* PROGRAMA DE MIGRACION DE PLANTA A VENTAS

CLEAR
SET DELE ON
SET DATE TO FRENCH

VIA=1     && 1=MODEM 2=DISKETTE
UNIDAD=1  && 1=A  2=B
OPCION=1  && 1=OK 2=CANCELAR

EMPRESA='1'

DO V_PRACD.SPR
IF OPCION=2 .OR. LASTKEY()=27
  CLEAR
  RETURN
ENDIF  

IF VIA=1 
  DO VIA_MODEM
ELSE 
  DO VIA_DISCO
ENDIF
  
CLOSE DATA
RETURN


PROCEDURE VIA_DISCO
*******************
IF UNIDAD=1
    IF .NOT. V_DISCO('A')
      WAIT 'ERROR EN UNIDAD A ...INSERTE EL DISCO E INTENTE DE NUEVO' WINDOW
      RETURN
    ENDIF
ELSE
    IF .NOT. V_DISCO('B')
      WAIT 'ERROR EN UNIDAD B ...INSERTE EL DISCO E INTENTE DE NUEVO' WINDOW
      RETURN
    ENDIF
ENDIF    

SELECT 1
USE V_DOC_HD ORDER MIGRA
SELECT 2
USE V_DOC_LN ORDER CORRE
SELECT 3
USE V_ITEMS ORDER MIGRA
SELECT 4
USE V_CORRE
  
IT=SPACE(3)

SELECT 1
SEEK EMPRESA+' '
IF .NOT. EOF()
  WNUM=V_NEXT_N(EMPRESA,'ARCH')
  HD='A_VENTAS\HD'+WNUM+'.DBF'
  LN='A_VENTAS\LN'+WNUM+'.DBF'
  IT='A_VENTAS\IT'+WNUM+'.DBF'
   
  SELECT V_DOC_HD  
  COPY STRUC TO (HD)
    
  SELECT V_DOC_LN
  COPY STRUC TO (LN)
  
  SELECT 5
  USE (HD) ALIAS CABEZA EXCLU
  
  SELECT 6
  USE (LN) ALIAS LINEAS EXCLU
  
  SELECT V_DOC_HD
    
  DO WHILE .NOT. EOF() .AND. HD_EMPR+HD_MIGRA=EMPRESA+' '
    IF LOCK()
      REPLACE HD_MIGRA WITH 'M'
    ENDIF

    SCATTER TO MEMVAR
    SELECT CABEZA
    APPEND BLANK
    GATHER FROM MEMVAR

    SELECT V_DOC_LN
    SEEK V_DOC_HD.HD_EMPR+V_DOC_HD.HD_ALM+V_DOC_HD.HD_TIPO+V_DOC_HD.HD_NRO

    DO WHILE .NOT. EOF() .AND. LD_EMPR+LD_ALM+LD_TIPO+LD_NRO=V_DOC_HD.HD_EMPR+V_DOC_HD.HD_ALM+V_DOC_HD.HD_TIPO+V_DOC_HD.HD_NRO
      SCATTER TO MEMVAR
      SELECT LINEAS
      APPEND BLANK
      GATHER FROM MEMVAR
      SELECT V_DOC_LN
      SKIP
    ENDDO      
    SELECT V_DOC_HD
    SEEK EMPRESA+' '
  ENDDO  

ENDIF    

SELECT V_ITEMS  
SEEK EMPRESA+' '
IF .NOT. EOF()
  IF IT=SPACE(3)
    IT='A_VENTAS\IT'+WNUM+'.DBF'
  ENDIF
      
  COPY STRUC TO (IT)

  SELECT 7
  USE (IT) ALIAS ITEMS EXCLU

  SELECT V_ITEMS
      
  DO WHILE .NOT. EOF() .AND. IT_EMPR+IT_MIGRA=EMPRESA+' '
    IF LOCK()
      REPLACE IT_MIGRA WITH 'M'
    ENDIF
    SCATTER TO MEMVAR
    SELECT ITEMS
    APPEND BLANK
    GATHER FROM MEMVAR
    SKIP
  ENDDO
ENDIF     

CLOSE DATA
IF UNIDAD=1
  ! DEL A:HD*.DBF
  ! DEL A:LN*.DBF
  ! DEL A:IT*.DBF
  CLEAR
  ?
  ?
  ! COPY A_VENTAS\*.DBF A:
  ! RENAME A_VENTAS\*.DBF  *.DDD
ELSE
  ! DEL B:HD*.DBF
  ! DEL B:LN*.DBF
  ! DEL B:IT*.DBF
  CLEAR
  ?
  ?
  ! COPY A_VENTAS\*.DBF B:
  ! RENAME A_VENTAS\*.DBF  *.DDD
ENDIF
RETURN

PROCEDURE VIA_MODEM
*******************
SELECT 1
USE V_DOC_HD ORDER MIGRA
SELECT 2
USE V_DOC_LN ORDER CORRE
SELECT 3
USE V_ITEMS ORDER MIGRA
SELECT 4
USE V_CORRE
  
IT=SPACE(3)

SELECT 1
SEEK EMPRESA+' '
IF .NOT. EOF()
  WNUM=V_NEXT_N(EMPRESA,'ARCH')
  HD='A_VENTAS\HD'+WNUM+'.DBF'
  LN='A_VENTAS\LN'+WNUM+'.DBF'
  IT='A_VENTAS\IT'+WNUM+'.DBF'
   
  SELECT V_DOC_HD  
  COPY STRUC TO (HD)
    
  SELECT V_DOC_LN
  COPY STRUC TO (LN)
  
  SELECT 5
  USE (HD) ALIAS CABEZA EXCLU
  
  SELECT 6
  USE (LN) ALIAS LINEAS EXCLU
  
  SELECT V_DOC_HD
    
  DO WHILE .NOT. EOF() .AND. HD_EMPR+HD_MIGRA=EMPRESA+' '
    IF LOCK()
      REPLACE HD_MIGRA WITH 'M'
    ENDIF

    SCATTER TO MEMVAR
    SELECT CABEZA
    APPEND BLANK
    GATHER FROM MEMVAR

    SELECT V_DOC_LN
    SEEK V_DOC_HD.HD_EMPR+V_DOC_HD.HD_ALM+V_DOC_HD.HD_TIPO+V_DOC_HD.HD_NRO

    DO WHILE .NOT. EOF() .AND. LD_EMPR+LD_ALM+LD_TIPO+LD_NRO=V_DOC_HD.HD_EMPR+V_DOC_HD.HD_ALM+V_DOC_HD.HD_TIPO+V_DOC_HD.HD_NRO
      SCATTER TO MEMVAR
      SELECT LINEAS
      APPEND BLANK
      GATHER FROM MEMVAR
      SELECT V_DOC_LN
      SKIP
    ENDDO      
    SELECT V_DOC_HD
    SEEK EMPRESA+' '
  ENDDO  

ENDIF    

SELECT V_ITEMS  
SEEK EMPRESA+' '
IF .NOT. EOF()
  IF IT=SPACE(3)
    IT='A_VENTAS\IT'+WNUM+'.DBF'
  ENDIF
      
  COPY STRUC TO (IT)

  SELECT 7
  USE (IT) ALIAS ITEMS EXCLU

  SELECT V_ITEMS
      
  DO WHILE .NOT. EOF() .AND. IT_EMPR+IT_MIGRA=EMPRESA+' '
    IF LOCK()
      REPLACE IT_MIGRA WITH 'M'
    ENDIF
    SCATTER TO MEMVAR
    SELECT ITEMS
    APPEND BLANK
    GATHER FROM MEMVAR
    SKIP
  ENDDO
ENDIF     

CLOSE DATA

RETURN

