************** PROGRAMA DE MANTENIMIENTO DE PRODUCTOS ******************
*IF NOT V_VALACC()
*  RETURN
*ENDIF  

IF TYPE("EMPRESA")="U" OR TYPE("MI_EMPRESA")="U"
  DO V_GETEMP
ENDIF

IF .NOT. V_USRAUT(USER,"PRODUCTOS",1) 
    RETURN
ENDIF

DO SET_AMBI
DO SETUP

SET CURSOR ON
SET CLOCK ON
CLEAR

DO IT_VER

STORE .T. TO com_loop
DO WHILE com_loop
   @ 22,0 SAY "ษอออออออออหออออออออหออออออหอออออออหออออออออออหออออออหออออออหอออออออออหอออออออป"
   @ 23,0 SAY "บ <- PREV บ SIG -> บ OJEA บ BUSCA บ MODIFICA บ ALTA บ BAJA บ IMPRIME บ SALIR บ"
   @ 24,0 SAY "ศอออออออออสออออออออสออออออสอออออออสออออออออออสออออออสออออออสอออออออออสอออออออผ"
   ACTIVATE MENU M_ITEM
ENDDO

DO FIN

RETURN

PROCEDURE SETUP
***************
SELECT 1
USE V_EMPR ORDER EMPR && .CDX

SELECT 2
USE V_LINEAS ORDER LINEA && .CDX

SELECT 3
USE V_MATER ORDER MATER  && .CDX

SELECT 4
USE V_FORMUL ORDER PART  && .CDX
SET RELATION TO FO_EMPR+FO_MATER INTO V_MATER

SELECT 5
* DISPONIBLE

SELECT 6
* RESERVADO PARA ARCHIVO TEMPORAL DE ITEMS
SELECT 7
* RESERVADO PARA ARCHIVO TEMPORAL DE FORMULAS

SELECT 8
USE V_ITEMS ORDER PART  && .CDX

SET RELATION TO IT_EMPR INTO  V_EMPR
SET RELATION TO IT_EMPR+IT_LINEA INTO V_LINEAS ADDITIVE
SET FILTER TO IT_EMPR=EMPRESA
GO TOP

DEFINE WINDOW W_ITEM FROM 0,0 TO 14,79 DOUBLE CLOSE
DEFINE WINDOW W_MATER FROM 15,0 TO 21,79 DOUBLE CLOSE
DEFINE WINDOW W_MATER2 FROM 15,0 TO 21,79 DOUBLE CLOSE

DEFINE MENU M_ITEM 
DEFINE PAD PREV OF M_ITEM PROMPT '<- \<PREV'  AT 23,01 SKIP FOR BOF()
DEFINE PAD NEXT OF M_ITEM PROMPT '\<SIG ->'   AT 23,11 SKIP FOR EOF()
DEFINE PAD OJEAR OF M_ITEM PROMPT '\<OJEA'   AT 23,20
DEFINE PAD BUSCA OF M_ITEM PROMPT '\<BUSCA'   AT 23,27
DEFINE PAD MODI  OF M_ITEM PROMPT '\<MODIFICA' AT 23,35
DEFINE PAD ALTA  OF M_ITEM PROMPT '\<ALTA'     AT 23,46 
DEFINE PAD BAJA  OF M_ITEM PROMPT 'BA\<JA'     AT 23,53
DEFINE PAD IMPRE OF M_ITEM PROMPT '\<IMPRIME'  AT 23,60
DEFINE PAD SALE  OF M_ITEM PROMPT 'SA\<LIR'    AT 23,70

*          1         2         3         4         5         6         7      
*01234567890123456789012345678901234567890123456789012345678901234567890123456789
*ษอออออออออหออออออออหออออออหอออออออหออออออออออหออออออหออออออหอออออออออหอออออออป
*บ <- PREV บ SIG -> บ OJEA บ BUSCA บ MODIFICA บ ALTA บ BAJA บ IMPRIME บ SALIR บ
*ศอออออออออสออออออออสออออออสอออออออสออออออออออสออออออสออออออสอออออออออสอออออออผ

ON SELECTION PAD PREV   OF M_ITEM DO IT_PREV
ON SELECTION PAD NEXT   OF M_ITEM DO IT_NEXT
ON SELECTION PAD OJEAR  OF M_ITEM DO IT_OJEAR
ON SELECTION PAD BUSCA  OF M_ITEM DO IT_BUSCA
ON SELECTION PAD MODI   OF M_ITEM DO IT_MODI
ON SELECTION PAD ALTA   OF M_ITEM DO IT_ALTA
ON SELECTION PAD BAJA   OF M_ITEM DO IT_BAJA
ON SELECTION PAD IMPRE  OF M_ITEM DO IT_IMPRE
ON SELECTION PAD SALE   OF M_ITEM DO IT_SALE
RETURN

PROCEDURE FIN
**************
RELEASE MENU   M_ITEM
RELEASE WINDOW W_ITEM
CLOSE DATA
ACTIVATE SCREEN
CLEAR
SET CLOCK TO 0,69
RETURN

PROCEDURE IT_SALE
******************
STORE .F. TO com_loop
DEACTIVATE MENU
RETURN

PROCEDURE IT_NEXT
*****************
IF .NOT. EOF()
   SKIP
ENDIF 
DO IT_VER
RETURN

PROCEDURE IT_PREV
*****************
IF .NOT. BOF()
   SKIP -1
ENDIF 
DO IT_VER
RETURN

PROCEDURE IT_OJEAR
******************
HIDE MENU M_ITEM
DO V_IR_REG.SPR

@ 22,0 CLEAR
@ 22,0 TO 24,79 
@ 23,10 SAY 'UBIQUESE EN EL ITEM QUE DESEA VER O MODIFICAR Y PRESIONE [F10]'

ON KEY LABEL F10 KEYBOARD CHR(23)
SET REFRESH TO 1
SELECT V_ITEMS
set relation to it_empr+it_part into v_formul additive

SELECT V_FORMUL
BROWSE NOWAIT  ;
       FIELDS FO_MATER:H='COD. M.P.',DESCR=V_MATER.MA_DESCR,FO_PORCEN:H='%':P='999.99',CV=((V_ITEMS.IT_PESO_T/100)*FO_PORCEN*V_MATER.MA_PRECIO):R ;
       WINDOW W_MATER  TITLE 'FORMULACION' COLOR SCHEME 10

SELECT V_ITEMS
BROWSE NODELETE NOAPPEND ;
       FIELDS IT_EMPR:H='EMPR':R,IT_PART:H='CODIGO':R,IT_LINEA:H='LINEA',IT_DESCR:H='DESCR', IT_UNIDAD:H='UNIDAD', IT_PESO_T:H='PESO T.', IT_DEMANDA:H='DEM.HIST':P='9999999.99', IT_PRECIO:H='PRECIO BASE', IT_PRECIO1:H='PRECIO 1', IT_PRECIO2:H='PRECIO 2', IT_PRECIO3:H='PRECIO 3', IT_PRECIO4:H='PRECIO 4', IT_PRECIO5:H='PRECIO 5' ;
       WINDOW W_ITEM TITLE 'F10 - PARA SALIR' COLOR SCHEME 10
ON KEY 
SET REFRESH TO 5
SET RELATION OFF INTO V_formul
@ 22,0 CLEAR
DO IT_VER
RETURN

PROCEDURE IT_VER
****************
ACTIVATE SCREEN
@ 0,0 TO 14,79 clear
DO V_ITM_V.SPR

SELECT V_FORMUL
KEYBOARD CHR(27)
BROWSE KEY V_ITEMS.IT_EMPR+V_ITEMS.IT_PART NOEDIT NOCLEAR;
       FIELDS FO_MATER:H='COD. M.P.',DESCR=V_MATER.MA_DESCR,FO_PORCEN:H='%':P='999.99',CV=((V_ITEMS.IT_PESO_T/100)*FO_PORCEN*V_MATER.MA_PRECIO):R ;
       WINDOW W_MATER  TITLE 'FORMULACION' COLOR SCHEME 10
SELECT V_ITEMS
@ 22,0 SAY "ษอออออออออหออออออออหออออออหอออออออหออออออออออหออออออหออออออหอออออออออหอออออออป"
@ 23,0 SAY "บ <- PREV บ SIG -> บ OJEA บ BUSCA บ MODIFICA บ ALTA บ BAJA บ IMPRIME บ SALIR บ"
@ 24,0 SAY "ศอออออออออสออออออออสออออออสอออออออสออออออออออสออออออสออออออสอออออออออสอออออออผ"
RETURN

PROCEDURE IT_BUSCA
******************
HIDE MENU M_ITEM
@ 22,0 CLEAR
@ 22,0 TO 24,79 
@ 23,03 SAY 'SELECCIONE SI SE BUSCA POR CODIGO O POR PARTE DE LA DESCRIPCION DEL ITEM'

DEFINE WINDOW IT_BUSCA FROM 14,10 TO 21,70 DOUBLE TITLE 'BUSQUEDA DE ITEMS'
ACTIVATE WINDOW IT_BUSCA

@ 1,1 GET choice FUNCTION '*RNV POR \<CODIGO;POR \<DESCR.';
	SIZE 1,10,1 DEFAULT 1

MI_COD=SPACE(15)
@ 1,20 SAY '        CODIGO:' GET MI_COD PICTURE REPLICATE('!',15) WHEN CHOICE=1

MI_SELE=SPACE(20)
@ 3,20 SAY 'DESCR. A BUSCAR:' GET MI_SELE PICTURE REPLICATE('!',20) WHEN CHOICE=2

@ 5,20 GET okcancel FUNCTION '*TH \!\<OK;\?\<Cancelar' DEFAULT 1;
	SIZE 1,10,1

READ CYCLE
SELECT V_ITEMS
IF okcancel = 1
  DO CASE
   CASE choice = 1
     ULTIMO=RECNO()
     SEEK EMPRESA+MI_COD
     IF EOF()
       CLEAR
       @ 2,5
       WAIT '               CODIGO NO EXISTE .... !!' 
       GO ULTIMO
     ENDIF
   CASE choice = 2
     MI_SELE=ALLTRIM(MI_SELE)
     ON KEY LABEL F10 KEYBOARD CHR(23)
     ON KEY LABEL ENTER KEYBOARD CHR(23)

     SET REFRESH TO 1
     SELECT V_ITEMS
     set relation to it_empr+it_part into v_formul additive
     
     SELECT V_FORMUL
     BROWSE NOWAIT  ;
        FIELDS FO_MATER:H='COD. M.P.',DESCR=V_MATER.MA_DESCR,FO_PORCEN:H='%':P='999.99',CV=((V_ITEMS.IT_PESO_T/100)*FO_PORCEN*V_MATER.MA_PRECIO):R ;
        WINDOW W_MATER  TITLE 'FORMULACION' COLOR SCHEME 10

     SELECT V_ITEMS
     ***
     IF .NOT. V_USRAUT(USER,"PRODUCTOS",2) 
       SELECT V_ITEMS
       BROWSE  NOEDIT  NODELETE NOAPPEND FOR MI_SELE$IT_DESCR;
          FIELDS IT_EMPR:H='EMPR':R,IT_PART:H='CODIGO':R,IT_LINEA:H='LINEA',IT_DESCR:H='DESCR', IT_UNIDAD:H='UNIDAD', IT_PESO_T:H='PESO T.' ;
          WINDOW W_ITEM TITLE 'SELECCIONE ITEM PRESIONANDO [ENTER]' COLOR SCHEME 10
     ELSE
       SELECT V_ITEMS
       BROWSE NODELETE NOAPPEND FOR MI_SELE$IT_DESCR;
          FIELDS IT_EMPR:H='EMPR':R,IT_PART:H='CODIGO':R,IT_LINEA:H='LINEA',IT_DESCR:H='DESCR', IT_UNIDAD:H='UNIDAD', IT_PESO_T:H='PESO T.' ;
          WINDOW W_ITEM TITLE 'SELECCIONE ITEM PRESIONANDO [ENTER]' COLOR SCHEME 10
     ENDIF
     ON KEY 
     SET REFRESH TO 5
     SET RELATION OFF INTO V_formul
     ON KEY 
  ENDCASE
ENDIF

RELEASE WINDOW IT_BUSCA
@ 22,0 CLEAR
DO IT_VER
RETURN

FUNCTION CHK_CODI
*****************
PARAMETER CODIGO
SELECT V_ITEMS
IF LASTKEY()=27
  SELECT ITEMS
  RETURN .T.
ENDIF  
SEEK CODIGO
IF EOF()
  RESUL=.T.
ELSE
  RESUL=.F.
ENDIF
SELECT ITEMS
RETURN RESUL    

FUNCTION CHK_LINEA
******************
PARAMETER LINEA
SELECT V_LINEAS
IF LASTKEY()=27
  SELECT ITEMS
  RETURN .T.
ENDIF  
SEEK LINEA
IF EOF()
  RESUL=.F.
ELSE
  @ 4,42 SAY '- '+SUBSTR(V_LINEAS.LI_DESCR,1,20)
  RESUL=.T.
ENDIF
SELECT ITEMS
RETURN RESUL    

PROCEDURE IT_BAJA
*****************
*IF .NOT. ITPASS()
*  RETURN
*ENDIF

IF .NOT. V_USRAUT(USER,"PRODUCTOS",2) 
    RETURN
ENDIF

SELECT V_ITEMS

HIDE MENU M_ITEM
@ 22,0 CLEAR
@ 22,0 TO 24,79 
@ 23,30 SAY 'BAJA ข ELIMINACION DE ITEMS'

DEFINE WINDOW IT_BAJA FROM 14,10 TO 20,70 DOUBLE TITLE 'BAJA DE REGISTRO DE ITEM'
ACTIVATE WINDOW IT_BAJA

@ 2,20 GET okcancel FUNCTION '*TH \!\<OK;\?\<Cancelar' DEFAULT 1;
	SIZE 1,10,1

READ CYCLE

IF okcancel = 1
  SELECT V_FORMUL
  SEEK V_ITEMS.IT_EMPR+V_ITEMS.IT_PART
  DELETE REST WHILE .NOT. EOF() .AND. V_ITEMS.IT_EMPR+V_ITEMS.IT_PART=FO_EMPR+FO_PART 
  SELECT V_ITEMS
  REPLACE IT_MIGRA WITH ' '
  DELETE
  GO TOP
ENDIF

RELEASE WINDOW IT_BAJA
@ 22,0 CLEAR
DO IT_VER
RETURN

PROCEDURE IT_IMPRE
******************
DEFINE WINDOW IT_IMPRE FROM 13,01 TO 21,78 DOUBLE TITLE 'LISTADO DE ITEMS'
ACTIVATE WINDOW IT_IMPRE

DO WHILE .T.
T_EMPR=EMPRESA
T_LINEA='   '
T_TEXT=SPACE(20)
DE_ITM=SPACE(15)
A_ITM=SPACE(15)
CLEAR
@ 1,1 GET choice FUNCTION '*RNV \<TODOS;POR \<CODIGOS;POR \<LINEAS;POR \<DESCR.';
	SIZE 1,12,0 DEFAULT 1
@ 2,25 SAY 'DE CODIGO:' GET DE_itm picture '@S10 !!!!!!!!!!!!!!!' WHEN CHOICE=2 
@ 2,50 SAY 'A  CODIGO:' GET A_itm picture '@S10 !!!!!!!!!!!!!!!' WHEN CHOICE=2
@ 3,25 SAY 'LINEA    :' GET T_linea PICTURE '!!!' WHEN CHOICE=3
@ 4,25 SAY 'DESCR.   :' GET T_TEXT PICTURE REPLICATE('!',20)    WHEN CHOICE=4

@ 6,25 GET okcancel FUNCTION '*TH \!\<Revisar;\<Imprimir;\?\<Cancelar' DEFAULT 1;
	SIZE 1,12,1

READ CYCLE

ON ESCAPE DO STOP_PRT

IF OKCANCEL=1 .OR. OKCANCEL=2
  SET RELATION OFF INTO V_LINEAS
  SET RELATION TO IT_EMPR+SUBSTR(IT_LINEA,1,2)+' ' INTO V_LINEAS ADDITIVE
  DO CASE
   CASE choice = 1
     SET ORDER TO LINEA
     if okcancel=1
       REPORT FORM V_ITM_1 FOR v_items.IT_EMPR=EMPRESA preview
     else
    	REPORT FORM V_ITM_1 FOR v_items.IT_EMPR=EMPRESA to print
    	WAIT "ENVIANDO DATOS A LA IMPRESORA.." WINDOW TIMEOUT 1
     endif
     SET ORDER TO PART     
   CASE choice = 2
     if okcancel=1
       	REPORT FORM V_ITM_1 FOR v_items.IT_EMPR=EMPRESA .AND. v_items.IT_part>=RTRIM(DE_itm) .AND. v_items.IT_part<=RTRIM(A_itm) preview
     else
        REPORT FORM V_ITM_1 FOR v_items.IT_EMPR=EMPRESA .AND. v_items.IT_part>=RTRIM(DE_itm) .AND. v_items.IT_part<=RTRIM(A_itm) to print
    	WAIT "ENVIANDO DATOS A LA IMPRESORA.." WINDOW TIMEOUT 1
     endif
   CASE choice = 3
     SET ORDER TO LINEA
     if okcancel=1
		REPORT FORM V_ITM_1 FOR v_items.IT_EMPR=EMPRESA .AND. v_items.IT_linea=ALLTRIM(T_LINEA) preview
     else
        REPORT FORM V_ITM_1 FOR v_items.IT_EMPR=EMPRESA .AND. v_items.IT_linea=ALLTRIM(T_LINEA) to print
    	WAIT "ENVIANDO DATOS A LA IMPRESORA.." WINDOW TIMEOUT 1
     endif
     SET ORDER TO PART     
   CASE choice = 4
     if okcancel=1
       REPORT FORM V_ITM_1 FOR v_items.IT_EMPR=EMPRESA .AND. ALLTRIM(T_TEXT)$v_items.IT_descr preview
     else
        REPORT FORM V_ITM_1 FOR v_items.IT_EMPR=EMPRESA .AND. ALLTRIM(T_TEXT)$v_items.IT_descr to print
    	WAIT "ENVIANDO DATOS A LA IMPRESORA.." WINDOW TIMEOUT 1
     endif 
  ENDCASE
  SET RELATION OFF INTO V_LINEAS
  SET RELATION TO IT_EMPR+IT_LINEA INTO V_LINEAS ADDITIVE
  IF OKCANCEL=2
    EXIT
  ENDIF
ELSE
 EXIT
ENDIF
ENDDO
ON ESCAPE
RELEASE WINDOW IT_IMPRE
RETURN

PROCEDURE stop_prt
******************
SET RELATION OFF INTO V_LINEAS
SET RELATION TO IT_EMPR+IT_LINEA INTO V_LINEAS ADDITIVE
RETURN

PROCEDURE SET_AMBI
******************
set color set to PLASMAR
SET CONFIRM ON
SET EXCLU OFF
SET DATE TO DMY
SET DELE ON
SET TALK OFF
SET SAFETY OFF
SET CLOCK TO 0,0
RETURN


PROCEDURE IT_ALTA
*****************
*IF .NOT. ITPASS()
*  RETURN
*ENDIF

IF .NOT. V_USRAUT(USER,"PRODUCTOS",2) 
    RETURN
ENDIF
SELECT V_ITEMS

HIDE MENU M_ITEM
@ 22,0 CLEAR
@ 22,0 TO 24,79 
@ 23,30 SAY 'ALTAS ข ADICION DE ITEMS'

P_ITEMS=SYS(3)

OPCION=1

SELECT V_ITEMS
SET RELATION OFF INTO V_EMPR
SET RELATION OFF INTO V_LINEAS 

COPY STRUCTURE TO (P_ITEMS)

P_FORMU=SYS(3)

SELECT 6
USE (P_ITEMS) ALIAS ITEMS EXCLUSIVE
SET RELATION TO IT_EMPR INTO  V_EMPR
SET RELATION TO IT_EMPR+IT_LINEA INTO V_LINEAS ADDITIVE
APPEND BLANK
REPLACE IT_EMPR WITH EMPRESA
REPLACE IT_FECHA_U WITH DATE()
REPLACE IT_FECHA_C WITH DATE()

SELECT V_FORMUL
SET RELATION OFF INTO V_MATER
COPY STRUCTURE TO (P_FORMU)

SELECT 7
USE (P_FORMU) ALIAS FORMULAS EXCLUSIVE
SET RELATION TO FO_EMPR+FO_MATER INTO V_MATER

DO WHILE .T.
   SELECT ITEMS
   DO V_ITM_A.SPR
   DO CASE
     CASE OPCION=1
       SELECT FORMULAS
       FOR N=0 TO 10
   		 APPEND BLANK
	   ENDFOR
       ACTIVATE SCREEN
       REPLACE ALL FO_EMPR  WITH ITEMS.IT_EMPR, ;
                   FO_PART  WITH ITEMS.IT_PART

       ON KEY LABEL F10 KEYBOARD CHR(23)
       ON KEY LABEL F8  KEYBOARD CHR(20)
       ON KEY LABEL F4 DO ADD_FORMUL

       GO TOP
       BROWSE FIELDS FO_MATER:H='COD. M.P.':V=CHK_MATER(FO_EMPR+FO_MATER),DESCR=V_MATER.MA_DESCR,FO_PORCEN:H='%':P='999.99',CV=((V_ITEMS.IT_PESO_T/100)*FO_PORCEN*V_MATER.MA_PRECIO):R ;
              WINDOW W_MATER2  TITLE 'FORMULACIONES    [F4] - ADICIONA  [F8] - BORRA  [F10] - SALIR' COLOR SCHEME 10
       ON KEY
       
       DELETE ALL FOR FO_PART=SPACE(15) .OR. FO_PORCEN=0
       GO TOP
       BROWSE NOWAIT NOEDIT FIELDS FO_MATER:H='COD. M.P.',DESCR=V_MATER.MA_DESCR,FO_PORCEN:H='%':P='999.99',CV=((V_ITEMS.IT_PESO_T/100)*FO_PORCEN*V_MATER.MA_PRECIO):R ;
              WINDOW W_MATER  TITLE 'FORMULACION' COLOR SCHEME 10
     CASE OPCION=2
       SELECT 6
       USE
       SELECT 7
       USE

       SELECT V_ITEMS
       APPEND FROM (P_ITEMS)
       SET RELATION TO IT_EMPR INTO  V_EMPR
       SET RELATION TO IT_EMPR+IT_LINEA INTO V_LINEAS ADDITIVE

       SELECT V_FORMUL
       APPEND FROM (P_FORMU)
       SET RELATION TO FO_EMPR+FO_MATER INTO V_MATER
       EXIT
     CASE OPCION=3
       SELECT 6
       USE
       SELECT 7
       USE

       SELECT V_ITEMS
       SET RELATION TO IT_EMPR INTO  V_EMPR
       SET RELATION TO IT_EMPR+IT_LINEA INTO V_LINEAS ADDITIVE

       SELECT V_FORMUL
       SET RELATION TO FO_EMPR+FO_MATER INTO V_MATER
       EXIT
   ENDCASE
ENDDO

DELETE FILE (P_ITEMS+'.dbf')
DELETE FILE (P_FORMU+'.dbf')
@ 22,0 CLEAR
DO IT_VER
RETURN

PROCEDURE IT_MODI
*****************
*IF .NOT. ITPASS()
*  RETURN
*ENDIF

IF .NOT. V_USRAUT(USER,"PRODUCTOS",2) 
    RETURN
ENDIF

SELECT V_ITEMS

HIDE MENU M_ITEM
@ 22,0 CLEAR
@ 22,0 TO 24,79 
@ 23,30 SAY 'MODIFICACION DE ITEMS'

P_ITEMS=SYS(3)

OPCION=1

SELECT V_ITEMS
SET RELATION OFF INTO V_EMPR
SET RELATION OFF INTO V_LINEAS 

COPY NEXT 1 TO (P_ITEMS)

SELECT 6
USE (P_ITEMS) ALIAS ITEMS EXCLUSIVE
SET RELATION TO IT_EMPR INTO  V_EMPR
SET RELATION TO IT_EMPR+IT_LINEA INTO V_LINEAS ADDITIVE
REPLACE IT_FECHA_U WITH DATE()

P_FORMU=SYS(3)

SELECT V_FORMUL
SET RELATION OFF INTO V_MATER
SEEK ITEMS.IT_EMPR+ITEMS.IT_PART
COPY REST WHILE ITEMS.IT_EMPR+ITEMS.IT_PART=FO_EMPR+FO_PART TO (P_FORMU)

SELECT 7
USE (P_FORMU) ALIAS FORMULAS EXCLUSIVE
SET RELATION TO FO_EMPR+FO_MATER INTO V_MATER

BROWSE NOWAIT NODELETE NOEDIT ;
       FIELDS FO_MATER:H='COD. M.P.',DESCR=V_MATER.MA_DESCR,FO_PORCEN:H='%':P='999.99',CV=((V_ITEMS.IT_PESO_T/100)*FO_PORCEN*V_MATER.MA_PRECIO):R ;
       WINDOW W_MATER  TITLE 'FORMULACION' COLOR SCHEME 10

DO WHILE .T.
   SELECT ITEMS
   DO V_ITM_M.SPR
   DO CASE
     CASE OPCION=1
       SELECT FORMULAS
       ACTIVATE SCREEN
	   APPEND BLANK
       REPLACE ALL FO_EMPR  WITH ITEMS.IT_EMPR, ;
          		   FO_PART  WITH ITEMS.IT_PART
       GO TOP
       ON KEY LABEL F10 KEYBOARD CHR(23)
       ON KEY LABEL F8  KEYBOARD CHR(20)
       ON KEY LABEL F4 DO ADD_FORMUL
       
       BROWSE FIELDS FO_MATER:H='COD. M.P.':V=CHK_MATER(FO_EMPR+FO_MATER),DESCR=V_MATER.MA_DESCR,FO_PORCEN:H='%':P='999.99',CV=((V_ITEMS.IT_PESO_T/100)*FO_PORCEN*V_MATER.MA_PRECIO):R ;
              WINDOW W_MATER2  TITLE 'FORMULACIONES    [F4] - ADICIONA  [F8] - BORRA  [F10] - SALIR' COLOR SCHEME 10
       ON KEY
       
       REPLACE ALL FO_EMPR  WITH ITEMS.IT_EMPR, ;
               FO_PART  WITH ITEMS.IT_PART
       DELETE FOR FO_PART=SPACE(15) .OR. FO_PORCEN=0
       GO TOP
       BROWSE NOWAIT NOEDIT FIELDS FO_MATER:H='COD. M.P.',DESCR=V_MATER.MA_DESCR,FO_PORCEN:H='%':P='999.99',CV=((V_ITEMS.IT_PESO_T/100)*FO_PORCEN*V_MATER.MA_PRECIO):R;
              WINDOW W_MATER  TITLE 'FORMULACION' COLOR SCHEME 10

     CASE OPCION=2
       SELECT 6
       USE
       SELECT 7
       USE

       SELECT V_ITEMS
       REPLACE IT_EMPR WITH 'X', IT_PART WITH SPACE(15)
       DELETE
       APPEND FROM (P_ITEMS)
       SET RELATION TO IT_EMPR INTO  V_EMPR
       SET RELATION TO IT_EMPR+IT_LINEA INTO V_LINEAS ADDITIVE

       SELECT V_FORMUL
       SEEK V_ITEMS.IT_EMPR+V_ITEMS.IT_PART
       DELETE REST WHILE V_ITEMS.IT_EMPR+V_ITEMS.IT_PART=FO_EMPR+FO_PART 
       APPEND FROM (P_FORMU)
       SET RELATION TO FO_EMPR+FO_MATER INTO V_MATER
       EXIT
     CASE OPCION=3
       SELECT 6
       USE
       SELECT 7
       USE

       SELECT V_ITEMS
       SET RELATION TO IT_EMPR INTO  V_EMPR
       SET RELATION TO IT_EMPR+IT_LINEA INTO V_LINEAS ADDITIVE

       SELECT V_FORMUL
       SET RELATION TO FO_EMPR+FO_MATER INTO V_MATER
       EXIT
   ENDCASE
ENDDO

DELETE FILE (P_ITEMS+'.dbf')
DELETE FILE (P_FORMU+'.dbf')

@ 22,0 CLEAR
DO IT_VER
RETURN

PROCEDURE ADD_FORMUL
********************
APPEND BLANK
REPLACE FO_EMPR WITH ITEMS.IT_EMPR
REPLACE FO_PART WITH ITEMS.IT_PART
RETURN

FUNCTION CHK_MATER
******************
PARAMETER MATERIAL

SELECT FORMULAS
SET RELATION OFF INTO V_MATER

SELECT V_MATER
SEEK material

IF .NOT. FOUND() 
  define window w_material from 12,30 to 21, 79 
  ACTIVATE SCREEN
  ON KEY LABEL ENTER KEYBOARD CHR(23)
  BROWSE NODELETE NOAPPEND NOEDIT ;
       FIELDS ma_mater:h='CODIGO', ma_descr:h='DESCR.'  window w_material COLOR SCHEME 10
  on key label enter
  release window w_material
  cod_mater=ma_mater 
  SELECT FORMULAS
  REPLACE fo_mater WITH cod_mater
ENDIF 

SELECT FORMULAS
SET RELATION TO FO_EMPR+FO_MATER INTO V_MATER

RETURN .T.

FUNCTION ITPASS
****************
PASSWORD=SPACE(15)
DO V_PASSWD.SPR
IF PASSWORD<>'X0ITN541' .AND. PASSWORD<>'COMPLETA0'
   MENSAJE1='CLAVE ERRONEA ... OPERACION NO AUTORIZADA !' 
   MENSAJE2='PRESIONE <OK> PARA CONTINUAR'
   DO V_MENSAJ.SPR
   RETURN .F.
ENDIF
RETURN .T.