SELECT 1
USE V_DOC_LN ORDER CORRE

SELECT 2
USE V_FAC_DO ORDER FACTURA

SELECT 3
USE V_FAC_LN ORDER CORRE
TOT_KANT=0
TOT_KACT=0
DO WHILE .NOT. EOF()
  IF LF_ESTADO<>'A'
    MI_PART=LF_PART
    NUM=0
    TOT_CANT=0
    TOT_PESO=0
    SELECT V_FAC_DO
    SEEK V_FAC_LN.LF_EMPR+V_FAC_LN.LF_NRO
    DO WHILE .NOT. EOF() .AND. FA_EMPR+FA_NRO=V_FAC_LN.LF_EMPR+V_FAC_LN.LF_NRO
      SELECT V_DOC_LN
      SEEK V_FAC_DO.FA_EMPR+V_FAC_DO.FA_DOC_ALM+V_FAC_DO.FA_DOC_TIP+V_FAC_DO.FA_DOC_NRO
      DO WHILE .NOT. EOF() .AND. LD_EMPR+LD_ALM+LD_TIPO+LD_NRO=V_FAC_DO.FA_EMPR+V_FAC_DO.FA_DOC_ALM+V_FAC_DO.FA_DOC_TIP+V_FAC_DO.FA_DOC_NRO
        IF LD_PART=MI_PART
          TOT_CANT=TOT_CANT+LD_CANT
          TOT_PESO=TOT_PESO+LD_PESO
          NUM=NUM+1
        ENDIF
        SKIP
      ENDDO
      SELECT V_FAC_DO
      SKIP
    ENDDO
    SELECT V_FAC_LN
    TOT_KANT=TOT_KANT+LF_PESO
    TOT_KACT=TOT_KACT+IIF(TOT_CANT=0,LF_PESO,LF_CANT*TOT_PESO/TOT_CANT)
    
    IF LOCK()
      REPLACE LF_PESO WITH IIF(TOT_CANT=0,LF_PESO,LF_CANT*TOT_PESO/TOT_CANT)
    ENDIF
    
*    ? LF_NRO,LF_PART,TRANSFORM(LF_PESO,'999,99.99'),TRANSFORM(LF_CANT*(TOT_PESO/TOT_CANT),'999,999.99'),STR(NUM,2)

    IF ABS(1-LF_PESO/(LF_CANT*(TOT_PESO/TOT_CANT)))>.5 .OR. LF_PESO<0 .OR. LF_CANT*(TOT_PESO/TOT_CANT)<0
      WAIT 'DIF.' WINDOW
    ENDIF
  ENDIF
  SELECT V_FAC_LN
  SKIP
ENDDO  
? '======================================='
? TOT_KANT, TOT_KACT
CLOSE ALL