* PROGRAMA MODIFICADO DE V_RDEUDA.
* NO ESTA EN EL MENU PRINCIPAL
* Y SOLO MODIFICA EL REPORTE DE ANTIGUEDAD DE DEUDAS EN REPORTE V_RDEUDD,
* INCLUYENDO LA DIRECCION Y EL TELEFONO DE LOS CLIENTES
* TAMBIEN PUEDE MODIFICAR LAS OPCIONES DE SALDOS
* POR EJEMPLO SALDOS EN Bs.> 0 y < 6000 ; VARIABLE SALDOS OPCION=4
*
SET EXCLU OFF
SET DELE ON
CLOSE DATA
CLEAR
SET TALK OFF
INI_GEST={  /  /  }
FECHAI  ={  /  /  }
FECHAF  =DATE()
INDICEF=00

EMPRESA=' '
RESPON='   '
ORDEN=1
SALDOS=1
CONCOSTO=2
MONEDA=1
REPRO=1
MAYOR_A=0
QUE_CODS=1
CODS_CL=SPACE(8)

OPCION=1

MI_EMPRESA=SPACE(30)

DO V_RDEUDA.SPR

IF LASTKEY()=27 .OR. OPCION=3
 CLOSE DATA
 CLEAR 
 RETURN
ENDIF

IF REPRO=1
  DO CALC_DEU
ENDIF

NOMBRE=SYS(3)
NOMB_REP='V:'+NOMBRE+'.TXT' 
NOMB_IDX=NOMBRE+'.IDX'

SELECT 1
USE V_CLIENT

DO CASE
  CASE ORDEN=1
    if moneda=1
      INDEX ON 10000000-CL_SALD_AC TO (NOMB_IDX)
    else
      INDEX ON 10000000-CL_SALD_US TO (NOMB_IDX)
    endif
  CASE ORDEN=2
    SET ORDER TO CODIGO
  CASE ORDEN=3 
    INDEX ON CL_RAZON TO (NOMB_IDX)
ENDCASE

DO CASE
  CASE QUE_CODS=1
    WCOND="CL_EMPR=EMPRESA .AND. CL_COD_CL<>'0' .AND. CL_COD_CL<>'21' .AND. CL_COD_CL<>'22'"
  CASE QUE_CODS=2
    WCOND="CL_EMPR=EMPRESA .AND. CL_COD_CL<>'0' .AND. CL_COD_CL<>'21'"
  CASE QUE_CODS=3
    WCOND="CL_EMPR=EMPRESA .AND. CL_COD_CL=ALLTRIM(CODS_CL)"
ENDCASE      

DO CASE 
  CASE SALDOS=1
    IF MONEDA=1
      SET FILTER TO EVAL(WCOND) .AND. CL_COD_RES=ALLTRIM(RESPON) .AND. CL_SALD_AC<>0 
    ELSE
      SET FILTER TO EVAL(WCOND) .AND. CL_COD_RES=ALLTRIM(RESPON) .AND. CL_SALD_US<>0 
    ENDIF
  CASE SALDOS=2
    IF MONEDA=1
      SET FILTER TO EVAL(WCOND) .AND. CL_COD_RES=ALLTRIM(RESPON) .AND. CL_SALD_AC>0
    ELSE
      SET FILTER TO EVAL(WCOND) .AND. CL_COD_RES=ALLTRIM(RESPON) .AND. CL_SALD_US>0
    ENDIF
  CASE SALDOS=3
    IF MONEDA=1
      SET FILTER TO EVAL(WCOND) .AND. CL_COD_RES=ALLTRIM(RESPON) .AND. CL_SALD_AC<0
    ELSE
      SET FILTER TO EVAL(WCOND) .AND. CL_COD_RES=ALLTRIM(RESPON) .AND. CL_SALD_US<0
    ENDIF
  CASE SALDOS=4
    IF MONEDA=1
      SET FILTER TO EVAL(WCOND) .AND. CL_COD_RES=ALLTRIM(RESPON) .AND. CL_SALD_AC<MAYOR_A .AND. CL_SALD_AC>0
    ELSE
      SET FILTER TO EVAL(WCOND) .AND. CL_COD_RES=ALLTRIM(RESPON) .AND. CL_SALD_US>MAYOR_A
    ENDIF
ENDCASE  
GO TOP

DO CASE
  CASE OPCION=1 .AND. LASTKEY()<>27
    IF CONCOSTO=1
      REPORT FORM V_RDEUDA TO FILE (NOMB_REP)
    ELSE
      REPORT FORM V_RDEUDD TO FILE (NOMB_REP)
    ENDIF
    DEFINE WINDOW VER_REP FROM 0,0 TO 24,79 DOUBLE TITLE '[ESC] - PARA SALIR'
    MODI COMM (NOMB_REP) WINDOW VER_REP NOEDIT
    RELEASE WINDOW VER_REP    
  CASE OPCION=2 .AND. LASTKEY()<>27
    IF CONCOSTO=1
      REPORT FORM V_RDEUDA TO (NOMB_REP)
    ELSE
      REPORT FORM V_RDEUDD TO (NOMB_REP)
    ENDIF
    ! COPY &NOMB_REP LPT1:
  CASE OPCION=3 .OR. LASTKEY()=27
ENDCASE
CLEAR

CLOSE DATA
DELETE FILE (NOMB_IDX)
DELETE FILE (NOMB_REP)

RETURN

FUNCTION GET_EMPR
*****************
PARAMETER EMPR
SELECT 0
USE V_EMPR ORDER EMPR
SEEK EMPR
IF EOF()
  USE
  RETURN .F.
ELSE
  INI_GEST=EM_FECHA
  FECHAI=EM_FECHA
  MI_EMPRESA=EM_DESCR
  @ 7,48 SAY FECHAI
  @ 5,37 SAY MI_EMPRESA
  USE
  RETURN .T.
ENDIF

PROCEDURE CALC_DEU
******************
CLOSE DATA
CLEAR
SET SAFETY OFF

SELECT 0
USE V_TC ORDER FECHA
SEEK DTOS(INI_GEST)
IF .not. EOF()
  TC_INI=TC_MONTO
ELSE
  TC_INI=0
ENDIF
USE

INDICEF=INDICEF/100/360

SELECT 1
USE V_FAC_HD ORDER ESTADOS
SET FILTER TO BETWEEN(HF_FECHA,FECHAI,FECHAF)

SELECT 2
USE V_REC_HD ORDER ESTADOS
SET FILTER TO BETWEEN(HR_FECHA,FECHAI,FECHAF)

SELECT 3
USE V_CLIENT ORDER  CODIGO

DO CASE
  CASE QUE_CODS=1
    SET FILTER TO CL_EMPR=EMPRESA .AND. CL_COD_CL<>'0' .AND. CL_COD_CL<>'21' .AND. CL_COD_CL<>'22'
  CASE QUE_CODS=2
    SET FILTER TO CL_EMPR=EMPRESA .AND. CL_COD_CL<>'0' .AND. CL_COD_CL<>'21'
  CASE QUE_CODS=3
    SET FILTER TO CL_EMPR=EMPRESA .AND. CL_COD_CL=ALLTRIM(CODS_CL)
ENDCASE      
GO TOP

SELECT 4
USE V_TC ORDER FECHA

EST_ARCH='C:\'+SYS(3)

SELECT 0
USE V_ESTCLI
COPY STRUC TO (EST_ARCH) WITH CDX
USE

SELECT 0
USE (EST_ARCH) ORDER FECHA ALIAS ESTADOS exclusive

SELECT V_CLIENT

DO WHILE .NOT. EOF()

  CODIGO=CL_COD_CL
  RAZON =CL_RAZON
  IF MONEDA=1
    SALD_INI=CL_SALD_AN
  ELSE
    SALD_INI=CL_SALD_AN+CL_DIF_AN
  ENDIF
  SELECT ESTADOS
  ZAP
  
  APPEND BLANK
  IF LOCK()
    REPLACE OBS   WITH 'SALDO INICIO DE GESTION', ;
            FECHA WITH INI_GEST, ;
            DEBE  WITH IIF(SALD_INI>=0,SALD_INI,0), ;
            HABER WITH IIF(SALD_INI<0 ,ABS(SALD_INI),0), ;
            TC WITH TC_INI

  ENDIF          

  SELECT V_FAC_HD
  SET RELATION TO DTOS(HF_FECHA) INTO V_TC

  SEEK V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL

  DO WHILE .NOT. EOF() .AND. V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL=HF_EMPR+HF_COD_CL
    IF HF_ESTADO<>'A' .AND. HF_TIPO<>'O'
      DO CASE
        CASE HF_TIPO='R'  && FACTURA AL CREDITO
          TTIPO='F.CR.'
          TDEBE=hf_importe-HF_DSCTO_M-ROUND(hf_importe*(HF_DSCTO_P/100),2)+hf_fletes+hf_embala+hf_otros 
          THABER=0 
        CASE HF_TIPO='X'  && NOTA DE CREDITO
          TTIPO='N.C.'
          TDEBE=0
          THABER=hf_importe
        CASE HF_TIPO='Y'  && NOTA DE DEBITO
          TTIPO='N.D.'
          TDEBE=HF_IMPORTE
          THABER=0
        CASE HF_TIPO='Z'  && COMUN. INTERNA
          IF (MONEDA = 1)
         	    TTIPO='C.I.'
         		   IF (HF_IMPORTE>0) THEN
         		      THABER=0
            		  DO CASE
            		  CASE HF_MONEDA='B'
            		     TDEBE=HF_IMPORTE
            		  CASE HF_MONEDA='D'
            			 TDEBE=0
            		  CASE HF_MONEDA='A'
            			 TDEBE=HF_IMPORTE
            	      ENDCASE
         		    ELSE
         			  TDEBE = 0
         			  DO CASE
            		    CASE HF_MONEDA='B'
            			   THABER=ABS(HF_IMPORTE)
            		    CASE HF_MONEDA='D'
            			   THABER=0
            		    CASE HF_MONEDA='A'
             			   THABER=ABS(HF_IMPORTE)
            		  ENDCASE
                    ENDIF
         	   ELSE
         		 TTIPO='C.I.'
         		 IF (HF_IMPORTE>0) THEN
         			   THABER=0
            		 DO CASE
            		    CASE HF_MONEDA='B'
            			      TDEBE=0
            		    CASE HF_MONEDA='D'
            			      TDEBE=HF_IMPORTE * HF_FACTOR
            		    CASE HF_MONEDA='A'
            			      TDEBE=HF_IMPORTE
            		 ENDCASE
         		  ELSE
         			 TDEBE = 0
         			 DO CASE
            		    CASE HF_MONEDA='B'
            			   THABER=0
            		    CASE HF_MONEDA='D'
            			   THABER=ABS(HF_IMPORTE) * HF_FACTOR
            		    CASE HF_MONEDA='A'
            			   THABER=ABS(HF_IMPORTE)
            		 ENDCASE
             	  ENDIF            	
              END IF        
      ENDCASE

      SELECT ESTADOS
      APPEND BLANK
      IF LOCK()
        REPLACE TIPO WITH TTIPO, ;
          OBS WITH V_FAC_HD.HF_OBS, ;
          FECHA WITH V_FAC_HD.HF_FECHA, NRO WITH V_FAC_HD.HF_NRO, ;
          DEBE WITH TDEBE, HABER WITH THABER
          IF V_FAC_HD.HF_TIPO='R'
             REPLACE TC WITH V_FAC_HD.HF_FACTOR
          ELSE
             REPLACE TC WITH V_TC.TC_MONTO
          ENDIF
      ENDIF          
    ENDIF
    SELECT V_FAC_HD 
    SKIP
  ENDDO

  SELECT V_REC_HD
  SET RELATION TO DTOS(HR_FECHA) INTO V_TC
  
  SEEK V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL
  DO WHILE .NOT. EOF() .AND. V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL=HR_EMPR+HR_COD_CL
    IF HR_ESTADO<>'A' 
      TDEBE=0
      THABER=HR_TOT_BS
      SELECT ESTADOS
      APPEND BLANK
      IF LOCK()
        REPLACE TIPO WITH 'RCBO.', ;
              OBS WITH 'ABONO A SU CUENTA', ;
              FECHA WITH V_REC_HD.HR_FECHA, NRO WITH V_REC_HD.HR_NRO, ;
              DEBE WITH TDEBE, HABER WITH THABER, ;
              TC WITH V_TC.TC_MONTO
      ENDIF          
    ENDIF
    SELECT V_REC_HD
    SKIP
  ENDDO

  T_DB=0
  T_HB=0

  FINANC=0
  P_FINAN=0

  T_DBU=0
  T_HBU=0

  FINANCU=0
  P_FINANU=0

  FECHA1=INI_GEST

  DEUD_0  =0
  DEUD_30 =0
  DEUD_60 =0
  DEUD_90 =0
  DEUD_120=0

  DEUD_0U  =0
  DEUD_30U =0
  DEUD_60U =0
  DEUD_90U =0
  DEUD_120U=0

  SELECT ESTADOS
  GO TOP

  DO WHILE .NOT. EOF()
    T_DB=T_DB+DEBE
    T_HB=T_HB+HABER
    T_SALDO=T_DB-T_HB

    T_DBU=T_DBU+DEBE/TC
    T_HBU=T_HBU+HABER/TC
    T_SALDOU=T_DBU-T_HBU

    IF LOCK()
      REPLACE SALDO WITH T_SALDO
      REPLACE SALDOU WITH T_SALDOU
    ENDIF

    FINANC=FINANC+(P_FINAN*(FECHA-FECHA1)*INDICEF)
    FINANCU=FINANCU+(P_FINANU*(FECHA-FECHA1)*INDICEF)

    P_FINAN=T_SALDO
    P_FINANU=T_SALDOU
    
    FECHA1=FECHA
    IF DEBE<>0 .AND. DEBE<>HABER
        DO CASE
          CASE FECHAF-FECHA <=30 
              DEUD_0  =DEUD_0+DEBE
              DEUD_0U  =DEUD_0U+DEBE/TC
          CASE FECHAF-FECHA <=60 
              DEUD_30 =DEUD_30+DEBE
              DEUD_30U =DEUD_30U+DEBE/TC
          CASE FECHAF-FECHA <=90 
              DEUD_60 =DEUD_60+DEBE
              DEUD_60U =DEUD_60U+DEBE/TC
          CASE FECHAF-FECHA <=120 
              DEUD_90 =DEUD_90+DEBE
              DEUD_90U =DEUD_90U+DEBE/TC
          CASE FECHAF-FECHA >120 
              DEUD_120=DEUD_120+DEBE
              DEUD_120U=DEUD_120U+DEBE/TC
        ENDCASE
    ENDIF

    SKIP
  ENDDO

  FINANC=FINANC+(P_FINAN*(FECHAF-FECHA1)*INDICEF)
  FINANCU=FINANCU+(P_FINANU*(FECHAF-FECHA1)*INDICEF)

  MI_HABER=0
  MI_HABERU=0
    
  GO TOP

  DO WHILE .NOT. EOF()
      IF HABER<>0 .AND. HABER<>DEBE

        MI_HABER=MI_HABER+HABER
        IF DEUD_120>0 .AND. MI_HABER>0
           IF DEUD_120>=MI_HABER
             DEUD_120=DEUD_120-MI_HABER
             MI_HABER=0
           ELSE
             MI_HABER=MI_HABER-DEUD_120
             DEUD_120=0
           ENDIF
        ENDIF

        MI_HABERU=MI_HABERU+HABER/TC
        IF DEUD_120U>0 .AND. MI_HABERU>0
           IF DEUD_120U>=MI_HABERU
             DEUD_120U=DEUD_120U-MI_HABERU
             MI_HABERU=0
           ELSE
             MI_HABERU=MI_HABERU-DEUD_120U
             DEUD_120U=0
           ENDIF
        ENDIF


        IF DEUD_90>0 .AND. MI_HABER>0
           IF DEUD_90>=MI_HABER
             DEUD_90=DEUD_90-MI_HABER
             MI_HABER=0
           ELSE
             MI_HABER=MI_HABER-DEUD_90
             DEUD_90=0
           ENDIF
        ENDIF
        IF DEUD_90U>0 .AND. MI_HABERU>0
           IF DEUD_90U>=MI_HABERU
             DEUD_90U=DEUD_90U-MI_HABERU
             MI_HABERU=0
           ELSE
             MI_HABERU=MI_HABERU-DEUD_90U
             DEUD_90U=0
           ENDIF
        ENDIF

        IF DEUD_60>0 .AND. MI_HABER>0
           IF DEUD_60>=MI_HABER
             DEUD_60=DEUD_60-MI_HABER
             MI_HABER=0
           ELSE
             MI_HABER=MI_HABER-DEUD_60
             DEUD_60=0
           ENDIF
        ENDIF
        IF DEUD_60U>0 .AND. MI_HABERU>0
           IF DEUD_60U>=MI_HABERU
             DEUD_60U=DEUD_60U-MI_HABERU
             MI_HABERU=0
           ELSE
             MI_HABERU=MI_HABERU-DEUD_60U
             DEUD_60U=0
           ENDIF
        ENDIF

        IF DEUD_30>0 .AND. MI_HABER>0
           IF DEUD_30>=MI_HABER
             DEUD_30=DEUD_30-MI_HABER
             MI_HABER=0
           ELSE
             MI_HABER=MI_HABER-DEUD_30
             DEUD_30=0
           ENDIF
        ENDIF
        IF DEUD_30U>0 .AND. MI_HABERU>0
           IF DEUD_30U>=MI_HABERU
             DEUD_30U=DEUD_30U-MI_HABERU
             MI_HABERU=0
           ELSE
             MI_HABERU=MI_HABERU-DEUD_30U
             DEUD_30U=0
           ENDIF
        ENDIF

        IF DEUD_0>0 .AND. MI_HABER>0
           IF DEUD_0>=MI_HABER
             DEUD_0=DEUD_0-MI_HABER
             MI_HABER=0
           ELSE
             MI_HABER=MI_HABER-DEUD_0
             DEUD_0=0
           ENDIF
        ENDIF
        IF DEUD_0U>0 .AND. MI_HABERU>0
           IF DEUD_0U>=MI_HABERU
             DEUD_0U=DEUD_0U-MI_HABERU
             MI_HABERU=0
           ELSE
             MI_HABERU=MI_HABERU-DEUD_0U
             DEUD_0U=0
           ENDIF
        ENDIF

        IF DEUD_0+DEUD_30+DEUD_60+DEUD_90+DEUD_120<=0 .AND. MI_HABER>0
          DO CASE
            CASE FECHAF-FECHA <=30 
                DEUD_0  =DEUD_0-MI_HABER
            CASE FECHAF-FECHA <=60 
                DEUD_30 =DEUD_30-MI_HABER
            CASE FECHAF-FECHA <=90 
                DEUD_60 =DEUD_60-MI_HABER
            CASE FECHAF-FECHA <=120 
                DEUD_90 =DEUD_90-MI_HABER
            CASE FECHAF-FECHA >120 
                DEUD_120=DEUD_120-MI_HABER
          ENDCASE
          MI_HABER=0 
        ENDIF  
        IF DEUD_0U+DEUD_30U+DEUD_60U+DEUD_90U+DEUD_120U<=0 .AND. MI_HABERU>0
          DO CASE
            CASE FECHAF-FECHA <=30 
                DEUD_0U  =DEUD_0U-MI_HABERU
            CASE FECHAF-FECHA <=60 
                DEUD_30U =DEUD_30U-MI_HABERU
            CASE FECHAF-FECHA <=90 
                DEUD_60U =DEUD_60U-MI_HABERU
            CASE FECHAF-FECHA <=120 
                DEUD_90U =DEUD_90U-MI_HABERU
            CASE FECHAF-FECHA >120 
                DEUD_120U=DEUD_120U-MI_HABERU
          ENDCASE
          MI_HABERU=0 
        ENDIF  


      ENDIF
      SKIP
    ENDDO

*********** ACTUALIZACION DE TABLA DE CLIENTES ***************

  SELECT V_CLIENT 
  IF LOCK()
    REPLACE CL_SALD_DB WITH T_DB, CL_SALD_HB WITH T_HB, CL_SALD_AC WITH T_SALDO
    REPLACE CL_0 WITH DEUD_0, CL_30 WITH DEUD_30, CL_60 WITH DEUD_60, CL_90 WITH DEUD_90, CL_120 WITH DEUD_120
    REPLACE CL_FINANC WITH FINANC

    REPLACE CL_SALD_US WITH T_SALDOU
    REPLACE CL_0U WITH DEUD_0U, CL_30U WITH DEUD_30U, CL_60U WITH DEUD_60U, CL_90U WITH DEUD_90U, CL_120U WITH DEUD_120U
    REPLACE CL_FINANCU WITH FINANCU

  ENDIF
  
  IF CL_SALD_AC<>0
    @  7,5 SAY 'CLIENTE: '+CL_COD_CL+'-  '+CL_RAZON+'  SALDO'+TRANSFORM(CL_SALD_AC,'99,999,999.99') COLOR B*/GR
    @  8,5 SAY 'DEUDA  1-30  dias:'+TRANSFORM(CL_0,'9,999,999.99')
    @  9,5 SAY 'DEUDA 31-60  dias:'+TRANSFORM(CL_30,'9,999,999.99')
    @ 10,5 SAY 'DEUDA 61-90  dias:'+TRANSFORM(CL_60,'9,999,999.99')
    @ 11,5 SAY 'DEUDA 91-120 dias:'+TRANSFORM(CL_90,'9,999,999.99')
    @ 12,5 SAY 'DEUDA 121 o mas  :'+TRANSFORM(CL_120,'9,999,999.99')+'  TOTAL DEUDA: '+TRANSFORM(CL_0+CL_30+CL_60+CL_90+CL_120,'99,999,999.99')+IIF(CL_0+CL_30+CL_60+CL_90+CL_120<>CL_SALD_AC,' ####','')
    @ 13,25 SAY 'COSTO FINANCIERO= '+TRANSFORM(FINANC,'9,999,999.99') COLOR R/GR*
  ENDIF
  ***************************************************************
  SELECT V_CLIENT
  SKIP
ENDDO

SELECT ESTADOS
USE

DELETE FILE (EST_ARCH+'.DBF') 
DELETE FILE (EST_ARCH+'.CDX') 

CLOSE DATA
CLEAR
RETURN
