******************
PROCEDURE V_ESTCLO
******************
PARAMETER IMPRE

EST_ARCH=SYS(3)
ARCH_TXT="..\TMP\"+EST_ARCH+".TXT"

CODIGO=CL_COD_CL
RAZON =CL_RAZON

SELECT V_EMPR
INI_GEST=EM_FECHA

SELECT 0
USE V_ESTCLI
COPY STRUC TO (EST_ARCH) WITH CDX
USE

SELECT 0
USE (EST_ARCH) ORDER FECHA ALIAS ESTADOS

SELECT V_FAC_HD 
SET RELATION TO DTOS(HF_FECHA) INTO V_TC

SEEK V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL

DO WHILE .NOT. EOF() .AND. V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL=HF_EMPR+HF_COD_CL
  IF HF_ESTADO<>'A' .AND. HF_TIPO='O'
    TTIPO='F.CO.'
    TDEBE=hf_importe-HF_DSCTO_M-ROUND(hf_importe*(HF_DSCTO_P/100),2)+hf_fletes+hf_embala+hf_otros 
    THABER=0 
    SELECT ESTADOS
    APPEND BLANK
    IF LOCK()
      REPLACE TIPO WITH TTIPO, ;
              OBS WITH V_FAC_HD.HF_OBS, ;
              FECHA WITH V_FAC_HD.HF_FECHA, NRO WITH V_FAC_HD.HF_NRO, ;
              DEBE WITH TDEBE, HABER WITH THABER, ;
              TC WITH V_TC.TC_MONTO
    ENDIF         
  ENDIF 
  SELECT V_FAC_HD 
  SKIP
ENDDO
SET RELATION OFF INTO V_TC

SELECT ESTADOS
DEFINE WINDOW VER_CLIE FROM 0,0 TO 24,79 DOUBLE TITLE 'ESTADO DE CUENTA DEL CLIENTE - [ESC] PARA SALIR'
ACTIVATE WINDOW VER_CLIE

MONEDA=1
DO V_BS_US.SPR

IF IMPRE='S'
  REPORT FORM V_ESTCLO TO FILE (ARCH_TXT)
  ! COPY &ARCH_TXT lpt1:
ELSE
  REPORT FORM V_ESTCLO TO FILE (ARCH_TXT)
  CLEAR
  MODI COMM (ARCH_TXT) NOEDIT WINDOW VER_CLIE 
ENDIF
RELEASE WINDOW VER_CLIE

USE

DELETE FILE (EST_ARCH+'.DBF') 
DELETE FILE (EST_ARCH+'.CDX') 
DELETE FILE (ARCH_TXT)

SELECT V_CLIENT

RETURN
