CLEAR
CLOSE DATA
set exclu off

IF TYPE("EMPRESA")="U" OR TYPE("MI_EMPRESA")="U" OR TYPE("INI_GEST")="U"
  DO V_GETEMP
ENDIF

ALM='  '
OPCION=1
TIPO =1
ORDEN=1
CODIGO_IT=SPACE(15)

DEFINE WINDOW VER FROM 0,0 TO 24,79 DOUBLE TITLE '> Presione [Esc] para salir ... <'
SELECT 1
  **
SELECT 2
  USE V_PED_LN
SELECT 3
  USE V_ITEMS ORDER PART
SELECT 4
  USE V_DOC_LN ORDER KARDEX
SELECT 5
  USE V_CLIENT ORDER CODIGO
SELECT 2
  SET RELATION TO LP_EMPR+LP_PART   INTO V_ITEMS
  SET RELATION TO LP_EMPR+LP_COD_CL INTO V_CLIENT ADDITIVE

DO WHILE .T.
  CLEAR
   
  DO V_PP.SPR

  IF OPCION=3 .OR. LASTKEY()=27
    EXIT
  ENDIF 
    
   IF TIPO=1
     TITULO1='LISTADO DE PEDIDOS PENDIENTES EN GENERAL'
   ELSE
     TITULO1='LISTADO DE PEDIDOS PENDIENTES PARA DESPACHAR'
   ENDIF

   DO CASE
     CASE ORDEN=1
       TITULO2='ORDENADO POR NROS. DE PEDIDOS'
     CASE ORDEN=2
       TITULO2='ORDENADO POR CODIGO DE PRODUCTOS'
     CASE ORDEN=3
       TITULO2='ORDENADO POR CODIGO DE CLIENTES'
   ENDCASE
  
  PP_IDX="..\TMP\"+SYS(3)+".IPP"
  PP_TXT="..\TMP\"+SYS(3)+".ITX"
  
  SELECT V_PED_LN
  IF TIPO=1
    DO CASE
      CASE ORDEN=1
        INDEX ON LP_EMPR+IIF(LP_ESTADO$'PI','P',' ')+LP_NRO TO (PP_IDX)
        SEEK EMPRESA+'P'
        REPORT FORM V_PP TO FILE (PP_TXT) FOR LP_PEND<>0 WHILE LP_EMPR=EMPRESA .AND. LP_ESTADO$'PI' .AND. .NOT. EOF()
      CASE ORDEN=2
        INDEX ON LP_EMPR+IIF(LP_ESTADO$'PI','P',' ')+LP_PART+DTOS(LP_FECHA) TO (PP_IDX)
        SEEK EMPRESA+'P'
        REPORT FORM V_PP TO FILE (PP_TXT) FOR LP_PEND<>0 .AND. LP_PART=ALLTRIM(CODIGO_IT) WHILE LP_EMPR=EMPRESA .AND. LP_ESTADO$'PI' .AND. .NOT. EOF()
      CASE ORDEN=3
        INDEX ON LP_EMPR+IIF(LP_ESTADO$'PI','P',' ')+LP_COD_CL+LP_PART+DTOS(LP_FECHA) TO (PP_IDX)
        SEEK EMPRESA+'P'
        REPORT FORM V_PP TO FILE (PP_TXT) FOR LP_PEND<>0 WHILE LP_EMPR=EMPRESA .AND. LP_ESTADO$'PI' .AND. .NOT. EOF()
      CASE ORDEN=4
        INDEX ON LP_EMPR+IIF(LP_ESTADO$'PI','P',' ')+LP_PART+DTOS(LP_FECHA) TO (PP_IDX)
        SEEK EMPRESA+'P'
        REPORT FORM V_PP_IT TO FILE (PP_TXT) FOR LP_PEND<>0 .AND. LP_PART=ALLTRIM(CODIGO_IT) WHILE LP_EMPR=EMPRESA .AND. LP_ESTADO$'PI' .AND. .NOT. EOF()
    ENDCASE
  ELSE
    DO CASE
      CASE ORDEN=1
        INDEX ON LP_EMPR+IIF(LP_ESTADO$'PI','P',' ')+LP_NRO TO (PP_IDX) 
        SEEK EMPRESA+'P'
        REPORT FORM V_PP TO FILE (PP_TXT) FOR LP_PEND<>0 .and. SALDOS(V_ITEMS.IT_PART)>0 WHILE LP_EMPR=EMPRESA .AND. LP_ESTADO$'PI' .AND. .NOT. EOF()
      CASE ORDEN=2
        INDEX ON LP_EMPR+IIF(LP_ESTADO$'PI','P',' ')+LP_PART+DTOS(LP_FECHA) TO (PP_IDX)
        SEEK EMPRESA+'P'
        REPORT FORM V_PP TO FILE (PP_TXT) FOR LP_PEND<>0 .AND. LP_PART=ALLTRIM(CODIGO_IT) .AND. SALDOS(V_ITEMS.IT_PART)>0  WHILE LP_EMPR=EMPRESA .AND. LP_ESTADO$'PI' .AND. .NOT. EOF()
      CASE ORDEN=3
        INDEX ON LP_EMPR+IIF(LP_ESTADO$'PI','P',' ')+LP_COD_CL+LP_PART+DTOS(LP_FECHA) TO (PP_IDX)
        SEEK EMPRESA+'P'
        REPORT FORM V_PP TO FILE (PP_TXT) FOR LP_PEND<>0 .and. SALDOS(V_ITEMS.IT_PART)>0 WHILE LP_EMPR=EMPRESA .AND. LP_ESTADO$'PI'.AND. .NOT. EOF()
      CASE ORDEN=4
        INDEX ON LP_EMPR+IIF(LP_ESTADO$'PI','P',' ')+LP_PART+DTOS(LP_FECHA) TO (PP_IDX)
        SEEK EMPRESA+'P'
        REPORT FORM V_PP_IT TO FILE (PP_TXT) FOR LP_PEND<>0 .AND. LP_PART=ALLTRIM(CODIGO_IT) WHILE LP_EMPR=EMPRESA .AND. LP_ESTADO$'PI' .AND. .NOT. EOF()
    ENDCASE
  ENDIF

  IF OPCION=2
     ! COPY &PP_TXT lpt1:
  ELSE
     MODI COMM (PP_TXT) NOEDIT WINDOW VER
     CLEAR
  ENDIF
  WAIT "PROCESO CONCLUIDO..." TIMEOUT 2
  SET INDEX TO
  DELE FILE (PP_TXT)
  DELE FILE (PP_IDX)
   
ENDDO

CLOSE ALL
RETURN       

FUNCTION SALDOS
***************
PARAMETER PART
MI_SAL=V_SALDOS(EMPRESA,ALM,PART)
SELECT V_PED_LN
RETURN MI_SAL
