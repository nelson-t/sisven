CLEAR
SET EXCLU OFF
SET DELE ON
SET TALK OFF

IF TYPE("EMPRESA")="U" OR TYPE("MI_EMPRESA")="U" OR TYPE("INI_GEST")="U"
  DO V_GETEMP
ENDIF

TIPOR=1
MI_GLOSA=SPACE(30)
MI_GLOSA1=SPACE(30)

KILOS=0
KILOS1=0

TOT_KILOS=0
ACTUALIZA=1

FECHAI=INI_GEST
FECHAF=DATE()

OPCION=1
INCLUIR=1 
ALMACEN="  "

DO V_RUTIL.SPR

IF LASTKEY()=27 .OR. OPCION=3
 CLOSE DATA
 CLEAR 
 RETURN
ENDIF

? "PROCESANDO..."

SELECT 1
USE V_LINEAS ORDER LINEA

SELECT 2
USE V_ITEMS  ORDER PART
SET RELATION TO IT_EMPR+SUBSTR(IT_LINEA,1,2)+' ' INTO V_LINEAS

SELECT 3
USE V_TC ORDER FECHA

SELECT 4
USE V_DOC_HD ORDER CORRE

SELECT 5
USE V_DOC_LN ORDER KARDEX
          
SET RELATION TO DTOS(LD_FECHA) INTO V_TC ADDITIVE
SET RELATION TO LD_EMPR+LD_ALM+LD_TIPO+LD_NRO INTO V_DOC_HD ADDITIVE
SET RELATION TO LD_EMPR+LD_PART INTO V_ITEMS ADDITIVE

SELECT 6
USE V_AREAS ORDER CODIGO ASCENDING

SELECT 7
USE V_CLIENT ORDER CODIGO

_REP='..\TMP\'+SYS(3)+'.TXT' 

SELECT V_DOC_LN
DO CASE
  CASE INCLUIR=1
    SET FILTER TO LD_EMPR=EMPRESA .AND. LD_ALM=ALLTRIM(ALMACEN) .AND.;
    LD_TIPO="R" .AND. BETWEEN(LD_FECHA,FECHAI, FECHAF) .AND. ;
    LD_ESTADO<>"A"
  CASE INCLUIR=2
    SET FILTER TO LD_EMPR=EMPRESA .AND. LD_ALM=ALLTRIM(ALMACEN) .AND.;
    LD_TIPO="R" .AND. BETWEEN(LD_FECHA,FECHAI, FECHAF) .AND. ;
    LD_ESTADO="F"
  CASE INCLUIR=3
    SET FILTER TO LD_EMPR=EMPRESA .AND. LD_ALM=ALLTRIM(ALMACEN) .AND.;
    LD_TIPO="R" .AND. BETWEEN(LD_FECHA,FECHAI, FECHAF) .AND. ;
    LD_ESTADO=" "
ENDCASE

SELECT V_DOC_LN
GO TOP

REPORT FORM V_RUTIL TO FILE (_REP)

DO CASE
  CASE OPCION=1 .AND. LASTKEY()<>27
	DEFINE WINDOW VER_REP FROM 0,0 TO 24,79 DOUBLE TITLE '[ESC] - PARA SALIR'
	MODI COMM (_REP) WINDOW VER_REP NOEDIT
	RELEASE WINDOW VER_REP    
  CASE OPCION=2 .AND. LASTKEY()<>27
	! COPY &_REP  lpt1:
ENDCASE

CLEAR
DO SALIR
RETURN

PROCEDURE SALIR
***************
CLOSE DATA
WAIT "PROCESO CONCLUIDO...SALIENDO." TIMEOUT 2
DELETE FILE (_REP)
RETURN TO MASTER

FUNCTION GLOSA
**************
MI_GLOSA=V_LINEAS.LI_DESCR
RETURN ' '

FUNCTION GLOSA1
**************
SELECT V_ITEMS
SET RELATION TO IT_EMPR+SUBSTR(IT_LINEA,1,1)+'  ' INTO V_LINEAS
MI_GLOSA1=V_LINEAS.LI_DESCR
SET RELATION TO IT_EMPR+SUBSTR(IT_LINEA,1,2)+' ' INTO V_LINEAS
SELECT FAC_LN
RETURN ' '

FUNCTION GLOSA3
***************
SELECT V_AREAS
SEEK SUBSTR(FAC_LN.LF_COD_CL,1 ,1)
RETURN ' '
