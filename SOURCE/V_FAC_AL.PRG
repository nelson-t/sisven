******************
PROCEDURE V_FAC_AL
******************
SET DELE ON
SET REFRESH TO 1

*OBTENEMOS NRO DE DOSIFICACION ACTIVO
NRODOSIF=V_GETNDO()

COPIA=.F. && PARA REPORTE/FORM de factura

COD_VEN=SPACE(3)
COD_CL =SPACE(8)
PED_NUM=SPACE(6)
RUC=SPACE(20)
RAZON=SPACE(30)
OPCION =1
ALM    = '  '
LAS_NRS=SPACE(60)
TOT_FLE=0
TOT_EMB=0
TOT_OTR=0
NROLINEAS=35

DEFINE WINDOW W1 FROM 1, 1 TO 17,31 DOUBLE TITLE 'NOTAS DE REMISION'
DEFINE WINDOW W2 FROM 5,33 TO 17,79 DOUBLE TITLE 'DETALLE DE REMISION'
DEFINE WINDOW W3 FROM 25,1 TO 49,79 DOUBLE TITLE 'LINEAS DE FACTURA'

ARCH_NR=SYS(3)+'.DBF'

SELECT V_FAC_LN
ARCH_TEMP=SYS(3)+'.FAC'

COPY STRUC TO (ARCH_TEMP)
ARCH_IDX =SYS(3)+'.IDX'

SELECT 0
USE (ARCH_TEMP) ALIAS TEMP_FAC EXCLUSIVE
INDEX ON LF_PART TO (ARCH_IDX)
ARCH_UNIC=SYS(3)+'.UNI'

INDEX ON LF_PART TO (ARCH_UNIC) UNIQUE
SET INDEX TO (ARCH_IDX), (ARCH_UNIC)
SET ORDER TO 1

SELECT V_DOC_HD

CLEAR
SET DISPLAY TO EGA43

DO V_FAC_AL.SPR

@ 23,8 CLEAR TO 23,30
@ 22,45 CLEAR TO 22,75

IF OPCION=1 .AND. LASTKEY()<>27
  @ 21,46 SAY '        BUSCANDO N.R. !!!     ' COLOR R+/GR*
  DO MUESTRA_NR
  IF LASTKEY()<>27
    DO V_FAC_AA.SPR
    IF OPCION=1 .AND. LASTKEY()<>27 && PROCESA NR's
      DO MAS_FACT    
    ENDIF
  ENDIF
  SELECT NRS
  USE
ENDIF
SET DISPLAY TO CGA

RELEASE WINDOW W1
RELEASE WINDOW W2
RELEASE WINDOW W3

CLEAR

SELECT TEMP_FAC
USE

DELET  FILE (ARCH_TEMP)
DELET  FILE (ARCH_IDX)
DELET  FILE (ARCH_UNIC)
DELETE FILE (ARCH_NR)
ON KEY LABEL SPACEBAR
ON KEY LABEL F10
RETURN

PROCEDURE MAS_FACT
******************
SELECT 0
USE V_TC ORDER FECHA
SEEK DTOS(DATE())

TCAMBIO = TC_MONTO   
FACTOR  = TC_MONTO
USE
************ 
FACTHD=SYS(3)+'.DBF'

SELECT V_FAC_HD 
COPY STRUC TO (FACTHD)

SELECT 0
USE (FACTHD) ALIAS FAC_HD EXCLU

APPEND BLANK
IF LOCK()
  REPLACE HF_EMPR    WITH EMPRESA, ;
          HF_NRO     WITH '',      ; 
          HF_NDOSIF  WITH NRODOSIF,; 
          HF_USUARIO WITH SYS(0),  ;
          HF_TIPO    WITH 'R',     ;
          HF_FECHA   WITH DATE(),  ;
          HF_ALM     WITH ALM,     ;
          HF_COD_CL  WITH COD_CL,  ;
          HF_COD_VEN WITH COD_VEN, ;
          HF_DSCTO_P WITH 0,       ;
          HF_FACTOR  WITH TCAMBIO  ;
          HF_OBS     WITH LAS_NRS

  REPLACE HF_FLETES WITH TOT_FLE ;
          HF_EMBALA WITH TOT_EMB, ;
          HF_OTROS  WITH TOT_OTR

ENDIF

DO V_FACTOR.SPR

IMPORTE=0

FACTLN=SYS(3)+'.DBF'
SELECT V_FAC_LN
COPY STRUC TO (FACTLN)

SELECT 0
USE (FACTLN) ALIAS FAC_LN EXCLU
SET RELATION TO LF_EMPR+LF_PART INTO V_ITEMS

SELECT TEMP_FAC
GO TOP

DO WHILE .NOT. EOF() 
  SELECT FAC_LN
  APPEND BLANK
  IF LOCK()
    REPLACE LF_EMPR    WITH FAC_HD.HF_EMPR, ;
            LF_TIPO    WITH FAC_HD.HF_TIPO, ;
            LF_NRO     WITH FAC_HD.HF_NRO, ;
            LF_NDOSIF  WITH FAC_HD.HF_NDOSIF, ;
            LF_FECHA   WITH FAC_HD.HF_FECHA, ;
            LF_COD_CL  WITH FAC_HD.HF_COD_CL, ;
            LF_PART    WITH TEMP_FAC.LF_PART, ;
            LF_CANT    WITH TEMP_FAC.LF_CANT, ;
            LF_PESO    WITH TEMP_FAC.LF_PESO, ;
            LF_LISTA   WITH TEMP_FAC.LF_LISTA, ;
            LF_PRECIO  WITH TEMP_FAC.LF_PRECIO

**  DO GET_PRECIO WITH LF_EMPR,LF_PART

    PARTE=LF_PART
    SELECT TEMP_FAC
    SKIP
    DO WHILE LF_PART=PARTE .AND. .NOT. EOF()
      SELECT FAC_LN
      REPLACE FAC_LN.LF_CANT WITH FAC_LN.LF_CANT+TEMP_FAC.LF_CANT
      REPLACE FAC_LN.LF_PESO WITH FAC_LN.LF_PESO+TEMP_FAC.LF_PESO
      SELECT TEMP_FAC
      SKIP
    ENDDO
    SELECT FAC_LN
    IMPORTE=IMPORTE+ROUND(LF_CANT*LF_PRECIO,2)
  ENDIF
  SELECT TEMP_FAC
ENDDO

SET DISPLAY TO CGA
ACTIVATE SCREEN
CLEAR

SELECT FAC_HD
DO V_FAC_V.SPR

SELECT V_FAC_LN

DEFINE WINDOW FAC_MOD FROM 9, 0 TO 18,79 ;
		TITLE "DETALLE DE LA FACTURA" ;
		NOFLOAT ;
		DOUBLE 

ACTIVATE SCREEN 

SELECT FAC_LN
GO TOP

ON KEY LABEL F10 KEYBOARD CHR(23)
=GET_TOT()

BROWSE FIELDS LF_PART:H='CODIGO':P='@S8 !!!!!!!!!!!!!!!', ;
       V_ITEMS.IT_DESCR :H='DESCRIPCION':W=.F., ;
       V_ITEMS.IT_UNIDAD:H='UNI.':W=.F., ;
       LF_CANT:H='CANTIDAD':W=.F.:P='9999999.99', ;
       LF_PRECIO:H='PRECIO U.':P='9999999.9999':V=GET_TOT(), ;
       IMPORTE=ROUND(LF_PRECIO*LF_CANT,2):P='9,999,999.99':R ;
       WINDOW FAC_MOD NOCLEAR  ;
       TITLE '[F10] - ACEPTAR PRECIOS  [ESC] - DESCARTA FACTURA' 

RELEASE WINDOW FAC_MOD


IF LASTKEY()<>27
  IMPORTE=0
  SUM ROUND(LF_CANT*LF_PRECIO,2) TO IMPORTE ALL
  SELECT FAC_HD
  IF LOCK()
    REPLACE HF_IMPORTE WITH IMPORTE
    REPLACE HF_NOM_CL WITH V_CLIENT.CL_RAZON
    REPLACE HF_RUC    WITH V_CLIENT.CL_RUC
  ENDIF

  T_EMBALA=HF_EMBALA
  T_FLETES=HF_FLETES
  T_OTROS=HF_OTROS
  T_DSCTO_M=0
  T_DSCTO_P=HF_DSCTO_P

  OPCION=1

  DO V_FAC_MO.SPR

  IF OPCION<>2 .AND. LASTKEY()<>27 .AND. LOCK()
    REPLACE HF_EMBALA  WITH T_EMBALA , ;
            HF_FLETES  WITH T_FLETES , ;
            HF_OTROS   WITH T_OTROS  , ;
            HF_DSCTO_M WITH T_DSCTO_M, ;
            HF_DSCTO_P WITH T_DSCTO_P

    DO CALC_DSCTO
    SELECT FAC_HD
    USE

    SELECT  V_FAC_HD 
    APPEN FROM (FACTHD)
    IF LOCK()
      REPLACE HF_NRO WITH V_NEXT_N(EMPRESA,'FAC')
    ENDIF
    
    SELECT FAC_LN
    REPLACE ALL LF_NRO WITH V_FAC_HD.HF_NRO
    USE
    
    SELECT V_FAC_LN 
    APPEN FROM (FACTLN)    


    SELECT NRS
    SET RELATION TO HD_EMPR+HD_TIPO+HD_NRO INTO V_DOC_HD

    GO TOP
    DO WHILE .NOT. EOF()
      IF HD_ESTADO=CHR(251)
        SELECT V_DOC_HD
        IF LOCK() .AND. HD_EMPR+HD_TIPO+HD_NRO=NRS.HD_EMPR+NRS.HD_TIPO+NRS.HD_NRO
          REPLACE HD_ESTADO WITH 'F', HD_FACTURA WITH V_FAC_HD.HF_NRO, HD_NDOSIF WITH V_FAC_HD.HF_NDOSIF, HD_MIGRA WITH ' '

          SELECT V_DOC_LN
          SEEK V_DOC_HD.HD_EMPR+V_DOC_HD.HD_TIPO+V_DOC_HD.HD_NRO
          DO WHILE .NOT. EOF() .AND. V_DOC_HD.HD_EMPR+V_DOC_HD.HD_TIPO+V_DOC_HD.HD_NRO=LD_EMPR+LD_TIPO+LD_NRO
            REPLACE LD_ESTADO WITH 'F'
            SKIP
          ENDDO
        ENDIF  
      ENDIF
      SELECT NRS
      SKIP
    ENDDO  
    SELECT NRS
    SET RELATION OFF INTO V_DOC_HD
    MENSAJE1='FACTURA NRO.:'+V_FAC_HD.HF_NRO+' HA SIDO GENERADA'
    MENSAJE2='PUEDE IMPRIMIRLA DESDE OPCIONES.'
    DO V_MENSAJ.SPR
  ELSE
    MENSAJE1='!!! LA FACTURA NO SE GENERO !!!'
    MENSAJE2='EL USUARIO CANCELO LA OPERACION'
    DO V_MENSAJ.SPR
  ENDIF
ELSE
  MENSAJE1='!!! LA FACTURA NO SE GENERO !!!'
  MENSAJE2='EL USUARIO CANCELO LA OPERACION'
  DO V_MENSAJ.SPR
ENDIF

SELECT FAC_HD
USE
SELECT FAC_LN
USE

DELE FILE (FACTHD)
DELE FILE (FACTLN)

SELECT V_FAC_HD

RETURN

FUNCTION SUM_TOT
****************
@ 2,21 SAY TRANSFORM(ROUND((hF_importe*T_dscto_p)/100,2),'99,999,999.99')
@ 4,21 SAY TRANSFORM(HF_IMPORTE-round((hF_importe*T_dscto_p)/100,2),'99,999,999.99')
@ 9,21 SAY TRANSFORM(HF_IMPORTE-round((hF_importe*T_dscto_p)/100,2)+T_FLETES+T_EMBALA+T_OTROS,'99,999,999.99')
@12,21 SAY TRANSFORM(HF_IMPORTE-round((hF_importe*T_dscto_p)/100,2)+T_FLETES+T_EMBALA+T_OTROS-T_DSCTO_M,'99,999,999.99')
RETURN .T.

PROCEDURE GET_PRECIO
********************
PARAMETER MI_EMPR,MI_PART
DESCTO_IT=0
SELECT V_DESCTO
SEEK FAC_LN.LF_EMPR+FAC_LN.LF_PART
DO WHILE .NOT. EOF() .AND. DE_EMPR+DE_PART=FAC_LN.LF_EMPR+FAC_LN.LF_PART
    IF BETWEEN(FAC_LN.LF_FECHA,DE_FECHAI,DE_FECHAF)
      IF V_CLIENT.CL_CATEGO$DE_CATEGO .OR. DE_CATEGO=SPACE(25)
        DESCTO_IT=DE_DESCTO/100
      ENDIF
      EXIT  
    ENDIF
    SKIP
ENDDO   

SELECT FAC_LN

IF LOCK()
    REPLACE LF_LISTA   WITH ROUND((V_ITEMS.IT_PRECIO-(V_ITEMS.IT_PRECIO*DESCTO_IT)),4)
    REPLACE LF_PRECIO  WITH ROUND((V_ITEMS.IT_PRECIO-(V_ITEMS.IT_PRECIO*DESCTO_IT)),4)
ENDIF

RETURN .T.

FUNCTION GET_TOT
*******************
MI_REC=RECNO()
SUM LF_CANT*LF_PRECIO TO TOT_IMPORT
GO MI_REC

ACTIVATE SCREEN
CLEAR
@ 19,0 TO 24,79 DOUBLE COLOR G+/B
@ 22,55 SAY 'DSCTO Bs.='+TRANSFORM( ROUND(TOT_IMPORT*FAC_HD.HF_DSCTO_P/100,2) ,'9,999,999.99') 
@ 23,55 SAY 'TOTAL Bs.='+TRANSFORM(TOT_IMPORT-ROUND(TOT_IMPORT*FAC_HD.HF_DSCTO_P/100,2),'9,999,999.99') 
RETURN .T.

PROCEDURE MUESTRA_NR
*******************
SELECT V_DOC_HD
COPY TO (ARCH_NR) FOR HD_TIPO$'RN' .AND. hd_empr=empresa .and. hd_alm=alm .and. hd_cod_cl=cod_cl AND HD_PEDIDO=ALLTRIM(PED_NUM)
select 0
use (arch_nr) alias nrs
set relation to hd_empr+hd_tipo+hd_nro into v_doc_ln

ON KEY LABEL SPACEBAR DO MARCA
ON KEY LABEL F10 KEYBOARD CHR(23)

@ 1,35 SAY '<--- [F10] - ACEPTAR  [ESC] - CANCELAR' COLOR GR+/W
@ 2,35 SAY '<--- BARRA SPACIADORA PARA SELECCIONAR' COLOR GR+/W
@ 21,46 SAY '                              '

ACTIVATE WINDOW W3
@ 0,1 SAY ' NR.    CODIGO        CANTIDAD      PESO'
@ 0,50 SAY 'PEDIDO : '+PED_NUM COLOR R+/GR*
@ 1,1 SAY '============================================='
@ 21,60 SAY "NRO. LINEAS:"

SELECT V_DOC_LN
BROWSE NOWAIT NOCLEAR FIELDS LD_PART:H='CODIGO', LD_CANT:H='CANT.',LD_PESO:H='PESO kg.' WINDOW W2 

SELECT NRS
BROWSE NOCLEAR FOR HD_COD_CL=COD_CL .AND. HD_ALM=ALM .AND. .NOT. HD_ESTADO$'FA' fields hd_nro:h='NRO.':R,hd_fecha:H='FECHA':R,hd_estado:H='E.',HD_PEDIDO:H='PEDIDO':R WINDOW W1

ACTIVATE SCREEN

@ 1,35 SAY '                                      '
@ 2,35 SAY '                                      '

ON KEY LABEL SPACEBAR
ON KEY LABEL F10

RETURN 

PROCEDURE MARCA
***************
set relation OFF into v_doc_ln
SELECT NRS
IF HD_ESTADO=' '
  IF PED_NUM=SPACE(6)
    PED_NUM=HD_PEDIDO
    WAIT 'SOLO SE PODRA FACTURAR N.R. CON PEDIDO = '+PED_NUM WINDOW TIMEOUT 2
  ENDIF

  IF PED_NUM=HD_PEDIDO
      REPLACE HD_ESTADO WITH CHR(251)
      select v_doc_ln
      SEEK NRS.hd_empr+NRS.hd_tipo+NRS.hd_nro

      DO WHILE .NOT. EOF() .AND. NRS.hd_empr+NRS.hd_tipo+NRS.hd_nro=LD_EMPR+LD_TIPO+LD_NRO
        SELECT TEMP_FAC
        APPEND BLANK
        REPLACE LF_TIPO WITH V_DOC_LN.LD_TIPO, ;
                LF_NRO  WITH V_DOC_LN.LD_NRO, LF_PART WITH V_DOC_LN.LD_PART, ;
                LF_CANT WITH V_DOC_LN.LD_CANT, LF_PESO WITH V_DOC_LN.LD_PESO, ;
                LF_LISTA WITH V_DOC_LN.LD_LISTA, LF_PRECIO WITH V_DOC_LN.LD_PRECIO
        SELECT V_DOC_LN
        SKIP
      ENDDO
  ENDIF      
ELSE
  REPLACE HD_ESTADO WITH ' '
  SELECT TEMP_FAC
  DELE FOR LF_TIPO+LF_NRO=NRS.HD_TIPO+NRS.HD_NRO
  PACK
ENDIF

CLEAR
SELECT TEMP_FAC
GO TOP
@ 0,1 SAY ' NR.    CODIGO        CANTIDAD      PESO '
@ 0,50 SAY 'PEDIDO : '+PED_NUM COLOR R+/GR*
@ 1,1 SAY '============================================='
@ 22,60 SAY "NRO. LINEAS:"

N=2
DO WHILE .NOT. EOF()
  IF N<=21
    @ N,1 SAY LF_NRO+' '+LF_PART+' '+TRANSFORM(LF_CANT,'999,999.99')+'  '+TRANSFORM(LF_PESO,'999,999.99') COLOR W+/W
  ELSE
    @ 22,1 SAY '......'
  ENDIF
  N=N+1
  SKIP
ENDDO

SET ORDER TO 2
COUNT FOR LF_CANT<>0 TO L_NROS
@ 22,59 SAY "NRO. LINEAS:"
@ 22,72 SAY L_NROS PICTURE '99'
IF L_NROS<=NROLINEAS .AND. L_NROS<>0
  ON KEY LABEL F10 KEYBOARD CHR(23)
  @ 22,75 SAY 'лл' COLOR G+
ELSE
  ON KEY LABEL F10 KEYBOARD ''
  @ 22, 0 SAY ' LA FACTURA NO PUEDE TENER 0 LINEAS O MAYOR A '+alltrim(STR(NROLINEAS))+' ' COLOR R+/B
  @ 22,75 SAY 'лл' COLOR R+
ENDIF
IF L_NROS=0
  PED_NUM=SPACE(6)
  @ 0,50 SAY 'PEDIDO : '+PED_NUM COLOR R+/GR*  
ENDIF  
SET ORDER TO 1

SELECT NRS
LAS_NRS=''
TOT_FLE=0
TOT_EMB=0
TOT_OTR=0

CURR_REC=RECNO()
GO TOP
DO WHILE .NOT. EOF()
  IF HD_ESTADO=CHR(251)  
    LAS_NRS=LAS_NRS+'R'+ALLTRIM(STR(VAL(HD_NRO)))+' '
    TOT_FLE=TOT_FLE+HD_PED_FLE
    TOT_EMB=TOT_EMB+HD_PED_EMB
    TOT_OTR=TOT_OTR+HD_PED_OTR
  ENDIF
  SKIP
ENDDO  
GO CURR_REC
set relation to hd_empr+hd_tipo+hd_nro into v_doc_ln
RETURN  


FUNCTION CHK_CLIE
*****************
PARAMETER CODIGO
SELECT V_CLIENT
SEEK EMPRESA+CODIGO
IF .NOT. EOF()
  RAZON=CL_RAZON
  RUC  =CL_RUC 
  @ 20,28 SAY '- '+CL_RAZON
  RETURN .T.
ELSE
  RETURN .F.
ENDIF    

FUNCTION GET_TC
***************
PARAMETER WFECHA
CURRENT=SELECT()
SELECT 0
USE V_TC ORDER FECHA
SEEK DTOS(WFECHA)
WTC=TC_MONTO
USE
SELECT (CURRENT)
RETURN WTC

PROCEDURE CALC_DSCTO
********************
SELECT FAC_HD

IMPORTE =HF_IMPORTE
TOT_DESC=HF_DSCTO_M+ROUND(hf_importe*(HF_DSCTO_P/100),2)

SELECT FAC_LN

COUNT TO NRO_LINEAS
DECLARE wdesc(NRO_LINEAS,2)

N=1
GO TOP
DO WHILE .NOT. EOF() 
  STORE ROUND(LF_CANT*LF_PRECIO,2) TO wdesc(N,1)
  STORE ROUND((ROUND(LF_CANT*LF_PRECIO,2)/IMPORTE)*TOT_DESC,2) TO wdesc(N,2)
  N=N+1
  SKIP
ENDDO

SUM_DESC=0
MAX_DESC=0

FOR Y=1 TO NRO_LINEAS
  SUM_DESC=SUM_DESC+wdesc(Y,2)
  IF wdesc(Y,2)>MAX_DESC
    EL_MAYOR=Y
  ENDIF
ENDFOR

IF SUM_DESC<>TOT_DESC
  DIF=TOT_DESC-SUM_DESC
  wdesc(EL_MAYOR,2)=wdesc(EL_MAYOR,2)+DIF
ENDIF

SUM_DESC=0
FOR Y=1 TO NRO_LINEAS
  SUM_DESC=SUM_DESC+wdesc(Y,2)
ENDFOR
    
L_IMPORTE=0    
N=1
GO TOP
DO WHILE .NOT. EOF() 
  IF LOCK()
    REPLACE LF_DESCTOS WITH wdesc(N,2)
  ENDIF
  L_IMPORTE=L_IMPORTE+ROUND(LF_CANT*LF_PRECIO,2)-LF_DESCTOS
  N=N+1
  SKIP
ENDDO

RETURN

FUNCTION CHK_PED
****************
PARAMETER P_NUM
SELECT 0
USE V_PED_HD ORDER CORRE
SEEK EMPRESA+P_NUM
IF .NOT. EOF() .OR. P_NUM=SPACE(6)
  USE
  RETURN .T.
ELSE
  USE
  PED_NUM=SPACE(6)
  RETURN .F.
ENDIF    

RETURN