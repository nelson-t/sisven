* PROGRAMA DE ACTUALIZACION DE kg. y COSTOS (Bs)
* MODIFICADO 26/01/2021 - asigna pesos teoricos a todos los movimientos...ya no pondera pesos.

IF TYPE("EMPRESA")="U" OR TYPE("MI_EMPRESA")="U"
  DO V_GETEMP
ENDIF

ALM="  "

SET DECIMALS TO 5

CLOSE DATA

TOT_CANT=0
TOT_BS=0

SINING=0

DO V_ASGKG.SPR

IF LASTKEY()=27
  RETURN
ENDIF
  
CLEAR

SELECT 1
USE V_DOC_LN ORDER KARDEX 

SELECT 2
USE V_FAC_LN ORDER PART

SELECT 3
USE V_ITEMS ORDER PART

SELECT V_DOC_LN
SET FILTER   TO LD_EMPR=EMPRESA .AND. LD_ALM=ALM .AND. LD_ESTADO<>'A' 
SET RELATION TO LD_EMPR+LD_PART INTO V_ITEMS
GO TOP

ITEM=SPACE(15)
DO WHILE .NOT. EOF() .AND. LASTKEY()<>27
  IF LD_PART<>SPACE(15) 
    IF LD_PART<>ITEM
      ? "PROCESANDO ..."+ITEM
      BS_UNI=0
      ITEM=LD_PART
      TOT_CANT=0
      TOT_BS  =0
    ENDIF

    * PARA TODOS ASIGNA PESO TEORICO DE LA TABLA ITEMS
    REPLACE V_ITEMS.IT_PESO_R WITH V_ITEMS.IT_PESO_T
    REPLACE LD_PESO           WITH LD_CANT*V_ITEMS.IT_PESO_T

	IF LD_INSAL="1"

      IF LD_CANT<0
        IF ABS(LD_CANT)<=TOT_CANT
          REPLACE LD_COSTO WITH BS_UNI
        ELSE
          REPLACE LD_COSTO WITH TOT_BS/ABS(LD_CANT)
        ENDIF
      ENDIF

      TOT_CANT=TOT_CANT+LD_CANT
      TOT_BS  =TOT_BS  +(LD_CANT*LD_COSTO)

      IF TOT_CANT=0 .OR. TOT_BS=0
        BS_UNI=0
      ELSE      
        BS_UNI=TOT_BS/TOT_CANT
      ENDIF

      REPLACE V_ITEMS.IT_COSTO WITH BS_UNI

    ELSE
      TOT_CANT=TOT_CANT-LD_CANT

      IF LD_CANT<=TOT_CANT
        REPLACE LD_COSTO WITH BS_UNI
        TOT_BS  =TOT_BS  -(LD_CANT*LD_COSTO)
      ELSE
        REPLACE LD_COSTO WITH TOT_BS/LD_CANT
        TOT_BS=0
        BS_UNI=0
        REPLACE V_ITEMS.IT_COSTO WITH BS_UNI
      ENDIF

    ENDIF
  ENDIF
  SKIP
ENDDO
CLEAR
CLOSE DATA 
RETURN
