* LLENA TABLA DE LINEAS / KG POR FACTURAR
PARAMETER VENDEDOR, AREA, CLIENTE, T_LINEAS, FECHA_I, FECHA_F
? "CALCULANDO KILOS POR FACTURAR ..."

TIPO='R'

SET DELE ON
SET EXCLU OFF
SET TALK OFF

SELECT 1
USE V_ITEMS ORDER PART

SELECT 2
USE V_DOC_HD ORDER CORRE

SELECT 3
USE V_DOC_LN ORDER CORRE
SET RELATION TO LD_EMPR+LD_ALM+LD_TIPO+LD_NRO INTO V_DOC_HD ADDITIVE
SET RELATION TO LD_EMPR+LD_PART INTO V_ITEMS ADDITIVE

SELECT 4
USE V_LINEAS ORDER LINEA

T_LINEAS='..\TMP\'+SYS(3)

COPY TO (T_LINEAS) WITH CDX

USE (T_LINEAS) ORDER LINEA ALIAS V_LINEAK

SELECT V_DOC_LN
SEEK EMPRESA

*INCLUIR NRs ELABORADAS EN EL RANGO DE FECHAS Y NO FACTURADAS, O FACTURADAS DESPUES DEL RANGO DE FECHAS
DO WHILE .NOT. EOF() .AND. LD_EMPR=EMPRESA
  IF LD_TIPO=TIPO .AND. LD_COD_VEN=ALLTRIM(VENDEDOR) ;
     .AND. V_DOC_HD.HD_AREA=ALLTRIM(AREA) .AND. LD_COD_CL=ALLTRIM(CLIENTE) ;
     .AND. ((.NOT. LD_ESTADO$'FA' .AND. BETWEEN(LD_FECHA,FECHA_I,FECHA_F)) .OR. ;
            (LD_ESTADO='F' .AND. V_DOC_HD.HD_F_FAC>FECHA_F))
            
      IF SUBSTR(V_ITEMS.IT_LINEA,3,1)<>' '
        LINEA=V_ITEMS.IT_LINEA
        SELECT V_LINEAK
        SEEK EMPRESA+LINEA
        IF FOUND()
          REPLACE LI_KGXFACT WITH LI_KGXFACT+V_DOC_LN.LD_PESO
        ELSE
          ? ' LINEA NO EXISTE !! '+V_ITEMS.IT_LINEA
        ENDIF     
      ENDIF
      IF SUBSTR(V_ITEMS.IT_LINEA,2,1)<>' '
        LINEA=SUBSTR(V_ITEMS.IT_LINEA,1,2)+' '
        SELECT V_LINEAK
        SEEK EMPRESA+LINEA
        IF FOUND()
          REPLACE LI_KGXFACT WITH LI_KGXFACT+V_DOC_LN.LD_PESO
        ELSE
          ? ' LINEA NO EXISTE !! '+V_ITEMS.IT_LINEA
        ENDIF     
      ENDIF
      IF SUBSTR(V_ITEMS.IT_LINEA,1,1)<>' '
        LINEA=SUBSTR(V_ITEMS.IT_LINEA,1,1)
        SELECT V_LINEAK
        SEEK EMPRESA+LINEA
        IF FOUND()
          REPLACE LI_KGXFACT WITH LI_KGXFACT+V_DOC_LN.LD_PESO
        ELSE
          ? ' LINEA NO EXISTE !! '+ V_ITEMS.IT_LINEA
        ENDIF     
      ENDIF
  ENDIF
  SELECT V_DOC_LN
  SKIP
ENDDO

CLOSE DATA
SELECT 1
USE (T_LINEAS) ORDER LINEA ALIAS V_LINEAK

RETURN