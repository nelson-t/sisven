******************
PROCEDURE V_NR_FAC
******************
SELECT V_DOC_HD

IF HD_ESTADO='F'
  WAIT "MENSAJE: LA NR YA FUE FACTURADA" WINDOW
  RETURN
ENDIF

IF HD_ESTADO='A'
  WAIT "MENSAJE: LA NR ESTA ANULADA...NO SE PUEDE FACTURAR" WINDOW
  RETURN
ENDIF

*OBTENEMOS NRO DE DOSIFICACION ACTIVO
NRODOSIF=V_GETNDO()

SELECT V_TC
SEEK DTOS(DATE())
IF EOF()
  MENSAJE1='!!! TIPO DE CAMBIO DEL DIA, NO HA SIDO ACTUALIZADO !!!' 
  MENSAJE2='ACTUALIZE EL TIPO DE CAMBIO ANTES DE INTENTAR DE NUEVO'
  DO V_MENSAJ.SPR
  RETURN
ENDIF

TCAMBIO = TC_MONTO   
FACTOR  = TC_MONTO

FACTHD=SYS(3)+'.DBF'

SELECT 0
USE V_FAC_HD ORDER CORRE

IF V_Vndupl('FAC',NRODOSIF)
	SELECT V_FAC_HD
	USE
	SELECT V_PED_HD
   	RETURN
ENDIF

SELECT V_FAC_HD
COPY STRUC TO (FACTHD)
USE (FACTHD) ALIAS FAC_HD

APPEND BLANK
IF LOCK()
  REPLACE HF_EMPR    WITH V_DOC_HD.HD_EMPR, ;
          HF_NRO     WITH '999999', ;   
          HF_NDOSIF  WITH NRODOSIF, ;
          HF_USUARIO WITH USER, ;
          HF_TIPO    WITH 'R', ;
          HF_FECHA   WITH DATE(), ;
          HF_ALM     WITH V_DOC_HD.HD_ALM, ;
          HF_COD_CL  WITH V_DOC_HD.HD_COD_CL, ;
          HF_COD_VEN WITH V_DOC_HD.HD_COD_VEN, ;
          HF_OBS     WITH V_DOC_HD.HD_OBS, ;
          HF_PEDIDO  WITH V_DOC_HD.HD_PEDIDO, ;
          HF_NR      WITH V_DOC_HD.HD_NRO, ;
          HF_DSCTO_P WITH V_DOC_HD.HD_DSCTO_P, ;
          HF_FACTOR  WITH TCAMBIO, ;
          HF_AREA    WITH V_DOC_HD.HD_AREA

  REPLACE HF_FLETES  WITH V_DOC_HD.HD_PED_FLE, ;
          HF_EMBALA  WITH V_DOC_HD.HD_PED_EMB, ;
          HF_OTROS   WITH V_DOC_HD.HD_PED_OTR                    
ENDIF

DO V_FACTOR.SPR

FACTLN=SYS(3)+'.DBF'

SELECT 0
USE V_FAC_LN ORDER CORRE
COPY STRUC TO (FACTLN)
USE (FACTLN) ALIAS FAC_LN
IMPORTE=0

SELECT V_DOC_LN
SEEK V_DOC_HD.HD_EMPR+V_DOC_HD.HD_TIPO+V_DOC_HD.HD_NRO

DO WHILE .NOT. EOF() .AND. V_DOC_HD.HD_EMPR+V_DOC_HD.HD_TIPO+V_DOC_HD.HD_NRO=LD_EMPR+LD_TIPO+LD_NRO
  SELECT FAC_LN
  APPEND BLANK
  IF LOCK()
    *SE JALA DATOS Y PRECIO DE LA NR
    
    REPLACE LF_EMPR    WITH FAC_HD.HF_EMPR, ;
            LF_TIPO    WITH FAC_HD.HF_TIPO, ;
            LF_NRO     WITH FAC_HD.HF_NRO, ;
            LF_NDOSIF  WITH FAC_HD.HF_NDOSIF, ;
            LF_FECHA   WITH FAC_HD.HF_FECHA, ;
            LF_COD_CL  WITH FAC_HD.HF_COD_CL, ;
            LF_PART    WITH V_DOC_LN.LD_PART, ;
            LF_CANT    WITH V_DOC_LN.LD_CANT, ;
            LF_PESO    WITH V_DOC_LN.LD_PESO, ;
            LF_LISTA   WITH V_DOC_LN.LD_LISTA, ;
            LF_PRECIO  WITH V_DOC_LN.LD_PRECIO

    IMPORTE=IMPORTE+ROUND(LF_CANT*LF_PRECIO,2)
  ENDIF
  SELECT V_DOC_LN
  SKIP
ENDDO

SELECT FAC_LN

DEFINE WINDOW FAC_MOD FROM 9, 0 TO 20,79 ;
		TITLE "DETALLE DE LA FACTURA" ;
		NOFLOAT ;
		DOUBLE 

HIDE MENU M_DOCS
ACTIVATE SCREEN 
CLEAR

SELECT FAC_LN
SET RELATION TO LF_EMPR+LF_PART INTO V_ITEMS

GO TOP
IF .NOT. EOF()
  =GET_TOT()
ENDIF

ON KEY LABEL F10 KEYBOARD CHR(23)

BROWSE  NOEDIT FIELDS LF_PART:H='CODIGO':P='@S8 !!!!!!!!!!!!!!!':R, ;
       V_ITEMS.IT_DESCR :H='DESCRIPCION':W=.F., ;
       V_ITEMS.IT_UNIDAD:H='UNI.':W=.F., ;
       LF_CANT:H='CANTIDAD':W=.F.:P='999999.99', ;
       LF_PRECIO:H='PRECIO U.':P='999999.9999':V=GET_TOT(), ;
       IMPORTE=ROUND(LF_PRECIO*LF_CANT,2):P='9,999,999.99':R ;
       WINDOW FAC_MOD  NOCLEAR;
       TITLE '[F10] - ACEPTAR PRECIOS  [ESC] - DESCARTA FACTURA' 

RELEASE WINDOW FAC_MOD

IF LASTKEY()<>27
  IMPORTE=0
  SUM ROUND(LF_CANT*LF_PRECIO,2) TO IMPORTE ALL
  SELECT FAC_HD
  IF LOCK()
    REPLACE HF_IMPORTE WITH IMPORTE
    REPLACE HF_NOM_CL WITH V_CLIENT.CL_RAZON
    REPLACE HF_RUC    WITH V_CLIENT.CL_RUC
  ENDIF

  T_EMBALA=HF_EMBALA
  T_FLETES=HF_FLETES
  T_OTROS =HF_OTROS
  T_DSCTO_M=0
  T_DSCTO_P=HF_DSCTO_P

  OPCION=1

  DO V_FAC_MO.SPR

  IF OPCION<>2 .AND. LASTKEY()<>27 .AND. LOCK()
    REPLACE HF_EMBALA  WITH T_EMBALA , ;
            HF_FLETES  WITH T_FLETES , ;
            HF_OTROS   WITH T_OTROS  , ;
            HF_DSCTO_M WITH T_DSCTO_M, ;
            HF_DSCTO_P WITH T_DSCTO_P

    DO CALC_DSCTO

    SELECT FAC_HD
    USE
    USE V_FAC_HD ORDER CORRE
    APPEN FROM (FACTHD)
    IF LOCK()
      REPLACE HF_NRO WITH V_NEXT_N(EMPRESA,'FAC')
    ENDIF
    
    SELECT FAC_LN
    REPLACE ALL LF_NRO WITH V_FAC_HD.HF_NRO
    USE
    USE V_FAC_LN ORDER CORRE
    APPEN FROM (FACTLN)    

    SELECT V_DOC_HD
    IF LOCK()
      REPLACE HD_ESTADO WITH 'F', ;
              HD_FACTURA WITH V_FAC_HD.HF_NRO, ;
              HD_NDOSIF  WITH V_FAC_HD.HF_NDOSIF, ;
              HD_F_FAC WITH DATE(), ;
              HD_U_FAC WITH USER, ;
              HD_MIGRA WITH ' '
    ENDIF

    SELECT V_DOC_LN
    SEEK V_DOC_HD.HD_EMPR+V_DOC_HD.HD_TIPO+V_DOC_HD.HD_NRO
    DO WHILE .NOT. EOF() .AND. V_DOC_HD.HD_EMPR+V_DOC_HD.HD_TIPO+V_DOC_HD.HD_NRO=LD_EMPR+LD_TIPO+LD_NRO
      IF LOCK()
        REPLACE LD_ESTADO WITH 'F'
      ENDIF
      SKIP
    ENDDO
    
	SELECT V_FAC_HD
    MENSAJE1='FACTURA NRO.:'+STR(V_FAC_HD.HF_NDOSIF,4)+"-"+V_FAC_HD.HF_NRO+' HA SIDO GENERADA'
    MENSAJE2='PUEDE IMPRIMIRLA DESDE EL MODULO DE FACTURAS'
    DO V_MENSAJ.SPR

    SELECT V_FAC_HD
    USE
    SELECT V_FAC_LN 
    USE
  ELSE
    MENSAJE1='!!! LA FACTURA NO SE GENERO !!!'
    MENSAJE2='EL USUARIO CANCELO LA OPERACION'
    DO V_MENSAJ.SPR
    SELECT FAC_HD
    USE
    SELECT FAC_LN
    USE
  ENDIF
ELSE
  MENSAJE1='!!! LA FACTURA NO SE GENERO !!!'
  MENSAJE2='EL USUARIO CANCELO LA OPERACION'
  DO V_MENSAJ.SPR
  SELECT FAC_HD
  USE
  SELECT FAC_LN
  USE
ENDIF

DELE FILE (FACTHD)
DELE FILE (FACTLN)

RETURN

FUNCTION SUM_TOT
****************
@ 2,21 SAY TRANSFORM(ROUND((hF_importe*T_dscto_p)/100,2),'99,999,999.99')
@ 4,21 SAY TRANSFORM(HF_IMPORTE-round((hF_importe*T_dscto_p)/100,2),'99,999,999.99')
@ 9,21 SAY TRANSFORM(HF_IMPORTE-round((hF_importe*T_dscto_p)/100,2)+T_FLETES+T_EMBALA+T_OTROS,'99,999,999.99')
@12,21 SAY TRANSFORM(HF_IMPORTE-round((hF_importe*T_dscto_p)/100,2)+T_FLETES+T_EMBALA+T_OTROS-T_DSCTO_M,'99,999,999.99')
RETURN .T.

PROCEDURE GET_PRECIO
********************
PARAMETER MI_EMPR,MI_PART
DESCTO_IT=0
SELECT V_DESCTO
SEEK EMPRESA+F.LP_PART
DO WHILE .NOT. EOF() .AND. DE_EMPR+DE_PART=EMPRESA+F.LP_PART
    IF BETWEEN(E.HP_FECHA,DE_FECHAI,DE_FECHAF)
      IF V_CLIENT.CL_CATEGO$DE_CATEGO .OR. DE_CATEGO=SPACE(25)
        DESCTO_IT=DE_DESCTO/100
      ENDIF
      EXIT  
    ENDIF
    SKIP
ENDDO   

SELECT FAC_LN 
IF LOCK()
    REPLACE LF_LISTA   WITH ROUND((V_ITEMS.IT_PRECIO-(V_ITEMS.IT_PRECIO*DESCTO_IT))*FAC_HD.HF_FACTOR,4)
    REPLACE LF_PRECIO  WITH ROUND((V_ITEMS.IT_PRECIO-(V_ITEMS.IT_PRECIO*DESCTO_IT))*FAC_HD.HF_FACTOR,4)
ENDIF
RETURN .T.

FUNCTION GET_TOT
*******************
MI_REC=RECNO()
SUM LF_CANT*LF_PRECIO TO TOT_IMPORT
GO MI_REC
ACTIVATE SCREEN
CLEAR
@ 21,0 TO 24,79 DOUBLE COLOR G+/B
@ 22,55 SAY 'DSCTO Bs.='+TRANSFORM( ROUND(TOT_IMPORT*FAC_HD.HF_DSCTO_P/100,2) ,'9,999,999.99') 
@ 23,55 SAY 'TOTAL Bs.='+TRANSFORM(TOT_IMPORT-ROUND(TOT_IMPORT*FAC_HD.HF_DSCTO_P/100,2),'9,999,999.99') 
RETURN .T.

FUNCTION GET_TC
***************
PARAMETER WFECHA
CURRENT=SELECT()
SELECT V_TC
SEEK DTOS(WFECHA)
WTC=TC_MONTO
SELECT (CURRENT)
RETURN WTC

PROCEDURE CALC_DSCTO
********************
SELECT FAC_HD

IMPORTE =HF_IMPORTE
TOT_DESC=HF_DSCTO_M+ROUND(hf_importe*(HF_DSCTO_P/100),2)

SELECT FAC_LN

COUNT TO NRO_LINEAS
DECLARE wdesc(NRO_LINEAS,2)

N=1
GO TOP
DO WHILE .NOT. EOF() 
  STORE ROUND(LF_CANT*LF_PRECIO,2) TO wdesc(N,1)
  STORE ROUND((ROUND(LF_CANT*LF_PRECIO,2)/IMPORTE)*TOT_DESC,2) TO wdesc(N,2)
  N=N+1
  SKIP
ENDDO

SUM_DESC=0
MAX_DESC=0

FOR Y=1 TO NRO_LINEAS
  SUM_DESC=SUM_DESC+wdesc(Y,2)
  IF wdesc(Y,2)>MAX_DESC
    EL_MAYOR=Y
  ENDIF
ENDFOR

IF SUM_DESC<>TOT_DESC
  DIF=TOT_DESC-SUM_DESC
  wdesc(EL_MAYOR,2)=wdesc(EL_MAYOR,2)+DIF
ENDIF

SUM_DESC=0
FOR Y=1 TO NRO_LINEAS
  SUM_DESC=SUM_DESC+wdesc(Y,2)
ENDFOR
    
L_IMPORTE=0    
N=1
GO TOP
DO WHILE .NOT. EOF() 
  IF LOCK()
    REPLACE LF_DESCTOS WITH wdesc(N,2)
  ENDIF
  L_IMPORTE=L_IMPORTE+ROUND(LF_CANT*LF_PRECIO,2)-LF_DESCTOS
  N=N+1
  SKIP
ENDDO

RETURN