* PROGRAMA DE MIGRACION PLASMAR  (PLANTA-VENTAS)
*
* EL PROGRAMA DEBE GENERAR LOS ARCHIVOS DE MIGRACION DE LOS 
* SIGUIENTES DATOS O DOCUMENTOS:
*            NOTAS DE REMISION (NUEVAS / ANULADAS / FACTURADAS)
*            ITEMS (NUEVOS / MODIFICADOS / BORRADOS)
*            LINEAS (NUEVAS / MODIFICADAS / BORRADAS)
*            CLIENTES (NUEVOS / MODIFICADOS / BORRADOS)
* EN TODOS ESTOS CASOS LA CONDICION ES ??_MIGRA=' '

* EL PROGRAMA DEBE ADJUNTAR LOS DOCUMENTOS O DATOS RECIBIDOS
* DE PLANTA A LA BASE DE DATOS DE VENTAS

SET VIEW OFF
SET TALK OFF
SET DELE ON
SET DATE TO DMY
SET EXCLU OFF
SET CONFIRM ON
SET AUTOSAVE ON
SET REPROCESS TO 5 SECONDS
EMPRESA='1'

SEND_PATH='C:\SEND\'
RECE_PATH='C:\RECEIVE\'

CLOSE DATA
DEFINE WINDOW WINSEND FROM 5, 4 TO 21,36 NONE COLOR G+/B
DEFINE WINDOW WINREC  FROM 5,43 TO 21,75 NONE COLOR G+/B

CLEAR

DO v_panmig.SPR

* GENERACION DE NOTAS DE REMISION
ACTIVATE WINDOW WINSEND

SELECT 1
USE V_DOC_HD ORDER MIGRA
SET FILTER TO HD_TIPO='R' .AND. HD_ALM='01' .AND. hd_migra<>'M'   && SOLO NOTAS DE REMISION DEL ALMACEN 01
GO TOP

SELECT 2
USE V_DOC_LN ORDER CORRE

SELECT 3
USE V_CORRE ORDER EMPRESA

SELECT 1

DO WHILE !EOF()
  NR_ARCH=SEND_PATH+'CD'+V_NEXT_N(EMPRESA,'ARCH')
  IF LOCK()
    COPY NEXT 1 TO (NR_ARCH+'._RH')
    SELECT V_DOC_LN
    SEEK V_DOC_HD.HD_EMPR+V_DOC_HD.HD_ALM+V_DOC_HD.HD_TIPO+V_DOC_HD.HD_NRO
    COPY REST WHILE .NOT. EOF() .AND. ;
         LD_EMPR+LD_ALM+LD_TIPO+LD_NRO=V_DOC_HD.HD_EMPR+V_DOC_HD.HD_ALM+V_DOC_HD.HD_TIPO+V_DOC_HD.HD_NRO ;
         TO (NR_ARCH+'._RL')
    SELECT V_DOC_HD
    REPLACE HD_MIGRA WITH 'M'
    ? ' N.R.:'+HD_NRO
    SEEK ' '
  ELSE
    SKIP
  ENDIF
ENDDO
? 
CLOSE DATA

* GENERACION DE ARCHIVOS DE CLIENTES 
ACTIVATE WINDOW WINSEND

SELECT 1
USE V_CLIENT ORDER MIGRA

SEEK ' '
DO WHILE .NOT. EOF() .AND. CL_MIGRA=' '
  CL_ARCH=SEND_PATH+'CD'+V_NEXT_N(EMPRESA,'ARCH')
  IF LOCK()
    REPLACE CL_MIGRA WITH 'M'
    COPY NEXT 1 TO (CL_ARCH+'._CL')
    ? ' CLIENTE:'+CL_COD_CL
    SEEK ' '
  ELSE
    SKIP
  ENDIF
ENDDO
? 
CLOSE DATA

* GENERACION DE ARCHIVOS DE LINEAS
ACTIVATE WINDOW WINSEND

SELECT 1
USE V_LINEAS ORDER MIGRA

SEEK ' '
DO WHILE .NOT. EOF() .AND. LI_MIGRA=' '
  LI_ARCH=SEND_PATH+'CD'+V_NEXT_N(EMPRESA,'ARCH')
  IF LOCK()
    REPLACE LI_MIGRA WITH 'M'
    COPY NEXT 1 TO (LI_ARCH+'._LI')
    ? ' LINEA:'+LI_LINEA
    SEEK ' '
  ELSE
    SKIP
  ENDIF
ENDDO
? 
CLOSE DATA

***********************************************************************
* ADICION DE DOCUMENTOS RECIBIDOS (N.I.,C.L.,IMP.,DEV.,TRASP.,DOC.INV.)

ACTIVATE SCREEN
DELE FILE C:\RECEIVE\LISTA.DOC
! DIR C:\RECEIVE\*._?? > C:\RECEIVE\LISTA.DOC

ACTIVATE WINDOW WINREC

SELECT 1
SET
USE V_ARCREC EXCLU
ZAP

APPEN FROM C:\RECEIVE\LISTA.DOC TYPE SDF FOR NOMBRE <> ' '
REPLACE ALL NOMBRE WITH SUBSTR(NOMBRE,1,8)+'.'+SUBSTR(NOMBRE,10,3)
GO TOP

DO WHILE .NOT. EOF()
  NEW_DOC='C:\RECEIVE\'+NOMBRE
  DO CASE
    CASE SUBSTR(NEW_DOC,22,2)='RH'     && CABEZERA
      SELECT 2
      USE (NEW_DOC) ALIAS DOC_HD EXCLU

      SELECT 3
      USE V_DOC_HD ORDER CORRE SHARED
      SEEK DOC_HD.HD_EMPR+DOC_HD.HD_ALM+DOC_HD.HD_TIPO+DOC_HD.HD_NRO

      IF .NOT. EOF()      && DOCUMENTO YA EXISTE
        IF LOCK()
          REPLACE HD_EMPR WITH 'X'
          DELETE
          ? 'REEMPLAZANDO:'
        ENDIF
      ENDIF 

      SELECT DOC_HD
      USE
      SELECT V_DOC_HD
      APPEND FROM (NEW_DOC)

      DO CASE
        CASE HD_TIPO='I'
          ? ' N.I.:'+HD_NRO
        CASE HD_TIPO='D'
          ? ' DEVOLUCION:'+HD_NRO
        CASE HD_TIPO='C'
          ? ' C.L.:'+HD_NRO
        CASE HD_TIPO='B'
          ? ' IMPORT.:'+HD_NRO
        CASE HD_TIPO='P'
          ? ' TRASPASO:'+HD_NRO
      ENDCASE            

      USE
      DELE FILE (NEW_DOC)

    CASE SUBSTR(NEW_DOC,22,2)='RL'     && INGRESOS - LINEAS
      SELECT 2
      USE (NEW_DOC) ALIAS DOC_LN EXCLU
      SELECT 3
      USE V_DOC_LN ORDER CORRE SHARED
      SEEK DOC_LN.LD_EMPR+DOC_LN.LD_ALM+DOC_LN.LD_TIPO+DOC_LN.LD_NRO
      IF .NOT. EOF()      && LINEAS YA EXISTEN
        DO WHILE .NOT. EOF() .AND. DOC_LN.LD_EMPR+DOC_LN.LD_ALM+DOC_LN.LD_TIPO+DOC_LN.LD_NRO=LD_EMPR+LD_ALM+LD_TIPO+LD_NRO
          IF LOCK()
            DELETE
          ENDIF
          SKIP
        ENDDO
      ENDIF

      SELECT DOC_LN
      USE
      SELECT V_DOC_LN
      APPEND FROM (NEW_DOC)

      DO CASE
        CASE LD_TIPO='I'
          ? ' N.I.:'+LD_NRO+' LINEAS'
        CASE LD_TIPO='D'
          ? ' DEVOLUCION:'+LD_NRO+' LINEAS'
        CASE LD_TIPO='C'
          ? ' C.L.:'+LD_NRO+' LINEAS'
        CASE LD_TIPO='B'
          ? ' IMPORT.:'+LD_NRO+' LINEAS'
        CASE LD_TIPO='P'
          ? ' TRASPASO:'+LD_NRO+' LINEAS'
      ENDCASE            

      USE
      DELE FILE (NEW_DOC)
      
* Adici¢n de Notas de Empaque

    CASE SUBSTR(NEW_DOC,22,2)='EH'     && CABEZERA N.E.
      SELECT 2
      USE (NEW_DOC) ALIAS NE_HD EXCLU

      SELECT 3
      USE V_NE_HD ORDER CORRE SHARED
      SEEK NE_HD.HD_EMPR+'01E'+NE_HD.HD_NRO

      IF .NOT. EOF()      && DOCUMENTO YA EXISTE
        IF LOCK()
          REPLACE HD_EMPR WITH 'X'
          DELETE
          ? 'REEMPLAZANDO:'
        ENDIF
      ENDIF 

      SELECT NE_HD
      USE
      SELECT V_NE_HD
      APPEND FROM (NEW_DOC)

      ? ' N.E.:'+HD_NRO

      USE
      DELE FILE (NEW_DOC)

    CASE SUBSTR(NEW_DOC,22,2)='EL'     && N.E. - LINEAS
      SELECT 2
      USE (NEW_DOC) ALIAS NE_LN EXCLU
      SELECT 3
      USE V_NE_LN ORDER CORRE SHARED
      SEEK NE_LN.LD_EMPR+'01E'+V_NE_LN.LD_NRO
      IF .NOT. EOF()      && LINEAS YA EXISTEN
        DO WHILE .NOT. EOF() .AND. V_NE_LN.LD_EMPR+V_NE_LN.LD_NRO=NE_LN.LD_EMPR+NE_LN.LD_NRO
          IF LOCK()
            DELETE
          ENDIF
          SKIP
        ENDDO
      ENDIF

      SELECT NE_LN
      USE
      SELECT V_NE_LN
      APPEND FROM (NEW_DOC)

      ? ' N.E.:'+LD_NRO+' LINEAS'
 
      USE
      DELE FILE (NEW_DOC)
****
    CASE SUBSTR(NEW_DOC,22,2)='IT'     && ITEMS
      SELECT 2
      USE (NEW_DOC) ALIAS ITEMS EXCLU
      SELECT 3
      USE V_ITEMS ORDER PART SHARED
      SEEK ITEMS.IT_EMPR+ITEMS.IT_PART
      IF .NOT. EOF()      && ITEM YA EXISTE
        IF LOCK()
          REPLACE IT_EMPR WITH 'X'
          DELETE
          ? 'REEMPLAZANDO:'
        ENDIF
      ENDIF 
      SELECT ITEMS
      USE
      SELECT V_ITEMS
      APPEND FROM (NEW_DOC)
      ? ' ITEM:'+IT_PART
      USE
      DELE FILE (NEW_DOC)
****
  ENDCASE
  SELECT V_ARCREC
  SKIP
ENDDO  
ZAP
RELEASE WINDOW WINSEND, WINREC
CLEAR PROGRAM
CLEAR
CLOSE DATA
SET VIEW OFF
