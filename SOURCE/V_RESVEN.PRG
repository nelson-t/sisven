SET EXCLU OFF
SET DELETE ON
CLOSE DATA
CLEAR
SET TALK OFF

TIPO_R=1
TIPO_V=' '
ZONA=SPACE(2)
CATEGO=SPACE(1)
VENDOR=SPACE(3)

MI_GLOSA=SPACE(30)
MI_GLOSA1=SPACE(30)

T_LINEAS=SPACE(8)

KILOS=0
KILOS1=0

TOT_KILOS=0
ACTUALIZA=1

EMPRESA=' '
FECHAI={  /  /    }
FECHAF={  /  /    }
OPCION=1
MI_EMPRESA=SPACE(30)

DO V_RESVEN.SPR

IF LASTKEY()=27 .OR. OPCION=3
 CLOSE DATA
 CLEAR 
 RETURN
ENDIF

IF ACTUALIZA=1
  DO V_RPROCE WITH EMPRESA, FECHAI, FECHAF
ENDIF

SELECT 1
USE V_LINEAS ORDER LINEA

SELECT 2
USE V_ITEMS  ORDER PART
SET RELATION TO IT_EMPR+SUBSTR(IT_LINEA,1,2)+' ' INTO V_LINEAS

SELECT 3
USE V_FAC_LN ORDER CORRE

SELECT 4
USE V_TC ORDER FECHA

SELECT 5
USE V_CLIENT ORDER CODIGO

SELECT 6
USE V_FAC_HD ORDER CORRE

FACTURAS=SYS(3)
FACT_REP='V:'+FACTURAS+'.TXT' 
FACT_IDX=FACTURAS+'.IDX'
FACTURAS=FACTURAS+'.DBF'

SELECT V_FAC_LN
SET RELATION TO LF_EMPR+LF_COD_CL INTO V_CLIENT  ADDITIVE
SET RELATION TO LF_EMPR+'F'+LF_NRO INTO V_FAC_HD ADDITIVE

DO CASE
   CASE TIPO_R=1
     TITULO='    ( G E N E R A L )'
     COPY TO (FACTURAS) FOR LF_EMPR=EMPRESA .AND. BETWEEN(LF_FECHA,FECHAI,FECHAF) .AND. LF_ESTADO<>'A'
   CASE TIPO_R=2
     TITULO='( POR TIPO DE VENTA **'+TIPO_V+'**)'
     COPY TO (FACTURAS) FOR LF_EMPR=EMPRESA .AND. BETWEEN(LF_FECHA,FECHAI,FECHAF) .AND. LF_ESTADO<>'A' .AND. V_FAC_HD.HF_COD_VEN=TIPO_V
   CASE TIPO_R=3
     TITULO='   ( POR ZONA **'+ZONA+'**)'
     COPY TO (FACTURAS) FOR LF_EMPR=EMPRESA .AND. BETWEEN(LF_FECHA,FECHAI,FECHAF) .AND. LF_ESTADO<>'A' .AND.  V_CLIENT.CL_ZONA=ZONA
   CASE TIPO_R=4
     TITULO='   ( POR CATEGORIA **'+CATEGO+'**)'
     COPY TO (FACTURAS) FOR LF_EMPR=EMPRESA .AND. BETWEEN(LF_FECHA,FECHAI,FECHAF) .AND. LF_ESTADO<>'A' .AND.  V_CLIENT.CL_CATEGO=CATEGO   
   CASE TIPO_R=5
     TITULO=' ( POR VENDEDOR **'+VENDOR+'**)'
     IF VENDOR='?'
       COPY TO (FACTURAS) FOR LF_EMPR=EMPRESA .AND. BETWEEN(LF_FECHA,FECHAI,FECHAF) .AND. LF_ESTADO<>'A' .AND. SUBSTR(V_FAC_HD.HF_COD_VEN,2,2)=SUBSTR(VENDOR,2,2)
     ELSE
       COPY TO (FACTURAS) FOR LF_EMPR=EMPRESA .AND. BETWEEN(LF_FECHA,FECHAI,FECHAF) .AND. LF_ESTADO<>'A' .AND. V_FAC_HD.HF_COD_VEN=VENDOR
     ENDIF 
ENDCASE

SELECT 3
USE (FACTURAS) ALIAS FAC_LN
SET RELATION TO LF_EMPR+LF_PART INTO V_ITEMS
INDEX ON LF_EMPR+V_ITEMS.IT_LINEA+LF_PART TO (FACT_IDX)
SET RELATION TO DTOS(LF_FECHA)  INTO V_TC ADDITIVE

DO CASE
  CASE OPCION=1 .AND. LASTKEY()<>27
    REPORT FORM V_RESVEN TO FILE (FACT_REP)
    DEFINE WINDOW VER_REP FROM 0,0 TO 24,79 DOUBLE TITLE '[ESC] - PARA SALIR'
    MODI COMM (FACT_REP) WINDOW VER_REP NOEDIT
    RELEASE WINDOW VER_REP    
  CASE OPCION=2 .AND. LASTKEY()<>27
    REPORT FORM V_RESVEN TO FILE (FACT_REP)
    ! NPRINT &FACT_REP NB NFF Q=SERVER   
  CASE OPCION=3 .OR. LASTKEY()=27
ENDCASE
CLEAR

CLOSE DATA
*DELETE FILE (FACTURAS)
*DELETE FILE (FACT_IDX)
DELETE FILE (FACT_REP)
DELETE FILE (T_LINEAS+'.DBF')
DELETE FILE (T_LINEAS+'.CDX')
RETURN

FUNCTION GET_EMPR
*****************
PARAMETER EMPR
SELECT 0
USE V_EMPR ORDER EMPR
SEEK EMPR
IF EOF()
  USE
  RETURN .F.
ELSE
  MI_EMPRESA=EM_DESCR
  @ 8,37 SAY MI_EMPRESA
  USE
  RETURN .T.
ENDIF

FUNCTION GLOSA
**************
MI_GLOSA=V_LINEAS.LI_DESCR
RETURN ' '

FUNCTION GLOSA1
**************
SELECT V_ITEMS
SET RELATION TO IT_EMPR+SUBSTR(IT_LINEA,1,1)+'  ' INTO V_LINEAS
MI_GLOSA1=V_LINEAS.LI_DESCR
SET RELATION TO IT_EMPR+SUBSTR(IT_LINEA,1,2)+' ' INTO V_LINEAS
SELECT FAC_LN
RETURN ' '