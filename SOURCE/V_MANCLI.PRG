************* PROGRAMA DE MANTENIMIENTO DE CLIENTES ******************
*IF NOT V_VALACC()
*  RETURN
*ENDIF  

IF TYPE("EMPRESA")="U" OR TYPE("MI_EMPRESA")="U"
  DO V_GETEMP
ENDIF
* EMPCIUD YA INICIALIZADA

IF .NOT. V_USRAUT(USER,"CLIENTES",1) 
    RETURN
ENDIF

SET COLOR SET TO PLASMAR
SET EXCLU OFF
SET CLOCK OFF
SET DELETE ON
SET TALK OFF
SET CONFIRM ON
SET DATE FRENCH

STORE 0 TO INI_BS,INI_US,FCR_BS,FCR_US,FCO_BS,FCO_US,REC_BS,REC_US
STORE 0 TO CARGO_BS,CARGO_US,ABONO_BS,ABONO_US,NR_BS,NR_US,NRO_NRP,NRO_PP

WPAGINA=1
EDITAOJEA=.F.

ULT_FECHA={  /  /    }
CLEAR

SELECT 1
USE V_EMPR
SET ORDER TO EMPR && .CDX

SELECT 2
USE V_CATEGO
SET ORDER TO CATEGO && .CDX

SELECT 3
USE V_DATCLI ORDER CODIGO

SELECT 4
USE V_CLIENT
SET ORDER TO CODIGO  && .CDX
SET RELATION TO CL_EMPR INTO V_EMPR
SET RELATION TO CL_EMPR+CL_CATEGO INTO V_CATEGO ADDITIVE
SET RELATION TO CL_EMPR+CL_COD_CL INTO V_DATCLI ADDITIVE
SET FILTER TO CL_EMPR=EMPRESA
GO TOP

SELECT 5 
USE V_FAC_HD ORDER ESTADOS
SELECT 6
USE V_REC_HD ORDER ESTADOS
SELECT 7
USE V_DOC_HD ORDER ESTADOS
SELECT 8
USE V_PED_HD ORDER ESTADOS
SELECT 9
USE V_TC ORDER FECHA
SELECT 10
USE V_REC_LN ORDER CORRE 
SELECT 11
USE V_VENDOR ORDER CODIGO
SELECT 12
USE V_HDR_HD ORDER ESTADOS

SELECT V_DOC_HD
SET RELATION TO DTOS(HD_FECHA) INTO V_TC

SELECT V_FAC_HD
SET RELATION TO DTOS(HF_FECHA) INTO V_TC

SELECT V_REC_HD
SET RELATION TO DTOS(HR_FECHA) INTO V_TC

*** SE EMPLEA PARA MOSTRAR UN POPUP EN LAS CATEGORIAS DE CLIENTES
SELECT V_CATEGO
DEFINE POPUP GETCATEGO FROM 7,51 TO 12,78;
	         PROMPT FIELD CA_CATEGO+'-'+CA_DESCR;
	         TITLE 'SELECCIONE CON [ENTER]' 
ON SELECTION POPUP GETCATEGO DEACTIVATE POPUP
*****************************************************

SELECT V_CLIENT

DEFINE WINDOW W_CLIENT FROM 0,0 TO 24,79 DOUBLE 
DEFINE MENU M_CLIENT
DEFINE PAD PREV OF M_CLIENT PROMPT '<- \<PREV'  AT 23,01 SKIP FOR BOF()
DEFINE PAD NEXT OF M_CLIENT PROMPT '\<SIG ->'   AT 23,11 SKIP FOR EOF()
DEFINE PAD OJEAR OF M_CLIENT PROMPT '\<OJEA'   AT 23,20
DEFINE PAD BUSCA OF M_CLIENT PROMPT '\<BUSCA'   AT 23,27
DEFINE PAD MODI  OF M_CLIENT PROMPT '\<MODIFICA' AT 23,35
DEFINE PAD ALTA  OF M_CLIENT PROMPT '\<ALTA'     AT 23,46 
DEFINE PAD BAJA  OF M_CLIENT PROMPT 'BA\<JA'     AT 23,53
DEFINE PAD IMPRE OF M_CLIENT PROMPT '\<REPORTES'  AT 23,60
DEFINE PAD SALE  OF M_CLIENT PROMPT 'SA\<LIR'    AT 23,71

*          1         2         3         4         5         6         7      
*01234567890123456789012345678901234567890123456789012345678901234567890123456789
*ษอออออออออหออออออออหออออออหอออออออหออออออออออหออออออหออออออหออออออออออหอออออออป
*บ <- PREV บ SIG -> บ OJEA บ BUSCA บ MODIFICA บ ALTA บ BAJA บ REPORTES บ SALIR บ
*ศอออออออออสออออออออสออออออสอออออออสออออออออออสออออออสออออออสออออออออออสอออออออผ

ON SELECTION PAD PREV   OF M_CLIENT DO CL_PREV
ON SELECTION PAD NEXT   OF M_CLIENT DO CL_NEXT
ON SELECTION PAD OJEAR  OF M_CLIENT DO CL_OJEAR
ON SELECTION PAD BUSCA  OF M_CLIENT DO CL_BUSCA
ON SELECTION PAD MODI   OF M_CLIENT DO CL_MODI
ON SELECTION PAD ALTA   OF M_CLIENT DO CL_ALTA
ON SELECTION PAD BAJA   OF M_CLIENT DO CL_BAJA
ON SELECTION PAD IMPRE  OF M_CLIENT DO V_CLI_OP
ON SELECTION PAD SALE   OF M_CLIENT DO CL_SALE

DO CL_VER

ON KEY LABEL PGUP DO CAMBIA_P1
ON KEY LABEL PGDN DO CAMBIA_P2
@ 22,0 SAY "ษอออออออออหออออออออหออออออหอออออออหออออออออออหออออออหออออออหออออออออออหอออออออป"
@ 23,0 SAY "บ <- PREV บ SIG -> บ OJEA บ BUSCA บ MODIFICA บ ALTA บ BAJA บ REPORTES บ SALIR บ"
@ 24,0 SAY "ศอออออออออสออออออออสออออออสอออออออสออออออออออสออออออสออออออสออออออออออสอออออออผ"

ACTIVATE MENU M_CLIENT

ON KEY LABEL PGUP
ON KEY LABEL PGDN

DO FIN

RETURN

PROCEDURE FIN
**************
RELEASE MENU   M_CLIENT
RELEASE WINDOW W_CLIENT
CLOSE DATA
ACTIVATE SCREEN
CLEAR
RETURN

PROCEDURE CL_SALE
******************
ON KEY LABEL F2 KEYBOARD ''
ON KEY LABEL F3 KEYBOARD ''
DEACTIVATE MENU M_CLIENT
RETURN

PROCEDURE CL_NEXT
*****************
IF !EOF()
   SKIP
ENDIF 
DO CL_VER
RETURN

PROCEDURE CL_PREV
*****************
IF !BOF()
   SKIP -1
ENDIF 
DO CL_VER
RETURN

PROCEDURE CL_OJEAR
******************
DO V_IR_REG.SPR
HIDE MENU M_CLIENT
on key label pgUP
on key label pgDN
ON KEY LABEL F2 KEYBOARD ''
ON KEY LABEL F3 KEYBOARD ''
ON KEY LABEL F10 KEYBOARD CHR(23)
*ON KEY LABEL ENTER KEYBOARD CHR(23)  **ES UN BROWSE DITABLE
BROWSE FIELDS CL_EMPR:H='EMPR':R,cl_cod_cl:H='CODIGO':R,CL_CATEGO:H='CATE.',CL_RAZON:H='RAZON':R, CL_COD_RES:H='RESPON.CTA.':7,CL_FONOS:H='TELEFS.',CL_COBRA:H='EN COBRANZA',CL_SALD_AN:H='SALDO INIC.',CL_DIF_AN:H='DIF.INIC.',CL_ESTADO:H='ESTADO':R,  ;
 CL_ZONA:H="Zona":P="@!" WINDOW W_CLIENT TITLE 'SELECCIONE CLIENTE Y PRESIONE [F10]' NODELETE 
ON KEY LABEL F10
*ON KEY LABEL ENTER
ON KEY LABEL PGUP DO CAMBIA_P1
ON KEY LABEL PGDN DO CAMBIA_P2
ON KEY LABEL F2 DO V_CARCL1 WITH 1
ON KEY LABEL F3 DO V_CARCL1 WITH 2
DO CL_VER
RETURN

PROCEDURE CL_VER
****************
CLEAR 
@ 22,0 SAY "ษอออออออออหออออออออหออออออหอออออออหออออออออออหออออออหออออออหออออออออออหอออออออป"
@ 23,0 SAY "บ <- PREV บ SIG -> บ OJEA บ BUSCA บ MODIFICA บ ALTA บ BAJA บ REPORTES บ SALIR บ"
@ 24,0 SAY "ศอออออออออสออออออออสออออออสอออออออสออออออออออสออออออสออออออสออออออออออสอออออออผ"
DO CASE
  CASE WPAGINA=1
    DO V_CLI_V.SPR
  CASE WPAGINA=2
    DO V_CLI_V2.SPR
  CASE WPAGINA=3
    DO V_CLI_V3.SPR
ENDCASE
RETURN

PROCEDURE CL_BUSCA
******************
HIDE MENU M_CLIENT
on key label pgUP
on key label pgDN
ON KEY LABEL F2 KEYBOARD ''
ON KEY LABEL F3 KEYBOARD ''
DEFINE WINDOW CL_BUSCA FROM 12,10 TO 21,70 DOUBLE TITLE 'BUSQUEDA DE CLIENTES'
ACTIVATE WINDOW CL_BUSCA
@1,1 GET choice FUNCTION '*RNV POR \<CODIGO;POR \<NIT; POR \<RAZON';
	SIZE 1,10,1 DEFAULT 1

MI_COD=SPACE(8)
MI_NIT=space(15)
MI_SELE=SPACE(20)
@1,20 SAY 'CODIGO:' GET MI_COD PICTURE "!!!!!!!!" WHEN CHOICE=1
@3,20 SAY '   NIT:' GET MI_NIT PICTURE "!!!!!!!!!!!!!!!" WHEN CHOICE=2
@5,20 SAY 'TEXTO A BUSCAR:' GET MI_SELE PICTURE REPLICATE('!',20) WHEN CHOICE=3
@7,20 GET okcancel FUNCTION '*TH \!\<OK;\?\<Cancelar' DEFAULT 1;
	SIZE 1,10,1

READ CYCLE

IF okcancel = 1
  DO CASE
   CASE choice = 1
     ULTIMO=RECNO()
     SEEK EMPRESA+MI_COD
     IF EOF()
       CLEAR
       @ 2,5
       WAIT '               CODIGO NO EXISTE .... !!' 
       GO ULTIMO
     ENDIF

   CASE choice = 2
     MI_NIT=ALLTRIM(MI_NIT)
     ON KEY LABEL F10 KEYBOARD CHR(23)
     ON KEY LABEL ENTER KEYBOARD CHR(23)
     BROWSE NOEDIT FOR MI_NIT$CL_RUC ;
       FIELDS CL_EMPR:H='EMPR',cl_cod_cl:H='CODIGO',CL_RUC:H='NIT',CL_RAZON:H='RAZON', CL_FONOS:H='TELEFS.',CL_ESTADO:H='ESTADO'  ;
       WINDOW W_CLIENT TITLE 'SELECCIONE CLIENTE CON [ENTER]'
     @ 0,0 TO 21,79 CLEAR
     ON KEY 


   CASE choice = 3
     MI_SELE=ALLTRIM(MI_SELE)
     ON KEY LABEL F10 KEYBOARD CHR(23)
     ON KEY LABEL ENTER KEYBOARD CHR(23)
     BROWSE NOEDIT FOR MI_SELE$CL_RAZON;
       FIELDS CL_EMPR:H='EMPR',cl_cod_cl:H='CODIGO',CL_CATEGO:H='CATE.',CL_RAZON:H='RAZON', CL_FONOS:H='TELEFS.',CL_ESTADO:H='ESTADO'  ;
       WINDOW W_CLIENT TITLE 'SELECCIONE CLIENTE CON [ENTER]'
     @ 0,0 TO 21,79 CLEAR
     ON KEY 
  ENDCASE
ENDIF

RELEASE WINDOW CL_BUSCA
ON KEY LABEL PGUP DO CAMBIA_P1
ON KEY LABEL PGDN DO CAMBIA_P2
ON KEY LABEL F2 DO V_CARCL1 WITH 1
ON KEY LABEL F3 DO V_CARCL1 WITH 2
DO CL_VER
RETURN

PROCEDURE CL_MODI
*****************
IF .NOT. V_USRAUT(USER,"CLIENTES",2) 
    RETURN
ENDIF

SELECT V_CLIENT
HIDE MENU M_CLIENT
on key label pgUP
on key label pgDN
ON KEY LABEL F2 KEYBOARD ''
ON KEY LABEL F3 KEYBOARD ''

*LOGICA PARA MODIFICACION EN EL FORMULARIO
DO V_CLI_M.SPR

ON KEY LABEL PGUP DO CAMBIA_P1
ON KEY LABEL PGDN DO CAMBIA_P2
ON KEY LABEL F2 DO V_CARCL1 WITH 1
ON KEY LABEL F3 DO V_CARCL1 WITH 2
DO CL_VER
RETURN

PROCEDURE CL_ALTA
*****************
IF .NOT. V_USRAUT(USER,"CLIENTES",2) 
    RETURN
ENDIF

SELECT V_CLIENT

HIDE MENU M_CLIENT
on key label pgUP
on key label pgDN
ON KEY LABEL F2 KEYBOARD ''
ON KEY LABEL F3 KEYBOARD ''

@2,17 SAY SPACE(31)

MIREC=RECNO()

*LOGICA PARA ALTA EN EL FORMULARIO
DO V_CLI_A.SPR
  
ON KEY LABEL PGUP DO CAMBIA_P1
ON KEY LABEL PGDN DO CAMBIA_P2
ON KEY LABEL F2 DO V_CARCL1 WITH 1
ON KEY LABEL F3 DO V_CARCL1 WITH 2
DO CL_VER
RETURN

FUNCTION CHK_CODI
*****************
PARAMETER CODIGO
IF LASTKEY()=27
  GOTO ULTIMO
  RETURN .T.
ENDIF  
SEEK CODIGO
IF EOF()
  RESUL=.T.
ELSE
  RESUL=.F.
ENDIF
RETURN RESUL    

PROCEDURE CL_BAJA
*****************
IF .NOT. V_USRAUT(USER,"CLIENTES",2) 
    RETURN
ENDIF

SELECT V_CLIENT

HIDE MENU M_CLIENT
on key label pgUP
on key label pgDN
ON KEY LABEL F2 KEYBOARD ''
ON KEY LABEL F3 KEYBOARD ''

DEFINE WINDOW CL_BAJA FROM 14,10 TO 20,70 DOUBLE TITLE 'BAJA DE REGISTRO DE CLIENTE'
ACTIVATE WINDOW CL_BAJA

@2,20 GET okcancel FUNCTION '*TH \!\<OK;\?\<Cancelar' DEFAULT 1;
	SIZE 1,10,1

READ CYCLE

RELEASE WINDOW CL_BAJA

IF okcancel = 1
  DARDEBAJA=.T.

  SELECT  V_FAC_HD
  SEEK V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL
  IF !EOF()
     WAIT 'EL CLIENTE TIENE FACTURAS ... NO SE PUEDE DAR DE BAJA' TIMEOUT 2 WINDOW
     DARDEBAJA=.f.
  ENDIF

  SELECT  V_DOC_HD
  SEEK V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL
  IF !EOF()
     WAIT 'EL CLIENTE TIENE N.R. ... NO SE PUEDE DAR DE BAJA' TIMEOUT 2 WINDOW
     DARDEBAJA=.f.
  ENDIF

  SELECT  V_PED_HD
  SEEK V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL
  IF !EOF()
     WAIT 'EL CLIENTE TIENE PEDIDOS ... NO SE PUEDE DAR DE BAJA' TIMEOUT 2 WINDOW
     DARDEBAJA=.f.
  ENDIF

  SELECT  V_HDR_HD
  SEEK V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL
  IF !EOF()
     WAIT 'TIENE HOJAS DE RUTA, NO SE PUEDE DAR DE BAJA' TIMEOUT 2 WINDOW
     DARDEBAJA=.f.
  ENDIF

  IF DARDEBAJA
    SELECT V_DATCLI
    SEEK V_CLIENT.CL_COD_CL+V_CLIENT.CL_EMPR
    IF !EOF()
      REPLACE DC_EMPR WITH 'X'
      DELETE
    ENDIF
    SELECT V_CLIENT
    MIREC =RECNO()
    MIREC2=-1
    SKIP
    IF NOT EOF()
      MIREC2=RECNO()
    ENDIF
    GO MIREC
    REPLACE CL_COD_CL WITH 'X'
    DELETE
    IF MIREC2=-1
      GO BOTTOM
    ELSE
      GO MIREC2
    ENDIF
  ENDIF

  SELECT V_CLIENT

ENDIF

ON KEY LABEL PGUP DO CAMBIA_P1
ON KEY LABEL PGDN DO CAMBIA_P2
ON KEY LABEL F2 DO V_CARCL1 WITH 1
ON KEY LABEL F3 DO V_CARCL1 WITH 2
DO CL_VER
RETURN

PROCEDURE CL_IMPRE
******************
on key label pgUP
on key label pgDN
ON KEY LABEL F2 KEYBOARD ''
ON KEY LABEL F3 KEYBOARD ''
T_EMPR=' '
T_CATE=' '
T_TEXT=SPACE(20)
DE_CLI=SPACE(6)
A_CLI=SPACE(6)
DEFINE WINDOW VER_CLIE FROM 0,0 TO 24,79 DOUBLE TITLE '[ESC] - PARA SALIR'
DEFINE WINDOW CL_IMPRE FROM 13,01 TO 21,78 DOUBLE TITLE 'LISTADO DE CLIENTES'
ACTIVATE WINDOW CL_IMPRE

T_CATE=' '
T_TEXT=SPACE(20)
DE_CLI=SPACE(8)
A_CLI=SPACE(8)
CLEAR
@1,1 GET choice FUNCTION '*RNV \<TODOS;POR C\<ODIGOS;POR C\<ATEGORIAS;POR RA\<ZON' ;
	SIZE 1,12,0 DEFAULT 1
@2,25 SAY 'DE CODIGO:' GET DE_CLI PICTURE "!!!!!!!!" WHEN CHOICE=2 
@2,50 SAY 'A  CODIGO:' GET A_CLI  PICTURE "!!!!!!!!" WHEN CHOICE=2
@3,25 SAY 'CATEGORIA:' GET T_CATE PICTURE '!' WHEN CHOICE=3
@4,25 SAY 'RAZON    :' GET T_TEXT PICTURE REPLICATE('!',20)    WHEN CHOICE=4
@6,25 GET okcancel FUNCTION '*TH \!\<Pantalla;\<Imprimir;\?\<Cancelar' DEFAULT 1 ;
	SIZE 1,12,1

READ CYCLE
ON ESCAPE DO STOP_PRT
IF OKCANCEL=1 .OR. OKCANCEL=2
  ARCH_CLI='..\TMP\'+SYS(3)+'.CLI'
  DO CASE
   CASE choice = 1
     REPORT FORM V_CLI_1 FOR V_CLIENT.CL_EMPR=EMPRESA TO FILE (ARCH_CLI)
   CASE choice = 2
     REPORT FORM V_CLI_1 FOR V_CLIENT.CL_EMPR=EMPRESA .AND. V_CLIENT.cl_cod_cl>=RTRIM(DE_CLI) .AND. V_CLIENT.cl_cod_cl<=RTRIM(A_CLI) TO FILE (ARCH_CLI)
   CASE choice = 3
     REPORT FORM V_CLI_1 FOR V_CLIENT.CL_EMPR=EMPRESA .AND. T_CATE=V_CLIENT.CL_CATEGO TO FILE (ARCH_CLI)
   CASE choice = 4
     REPORT FORM V_CLI_1 FOR V_CLIENT.CL_EMPR=EMPRESA .AND. ALLTRIM(T_TEXT)$V_CLIENT.CL_RAZON TO FILE (ARCH_CLI)
  ENDCASE
  IF OKCANCEL=1
    MODI COMM (ARCH_CLI) WINDOW VER_CLIE
    DELETE FILE (ARCH_CLI)
  ELSE
    ! COPY &ARCH_CLI lpt1:
  ENDIF
ENDIF
ON ESCAPE
RELEASE WINDOW CL_IMPRE
GO TOP
ON KEY LABEL PGUP DO CAMBIA_P1
ON KEY LABEL PGDN DO CAMBIA_P2
ON KEY LABEL F2 DO V_CARCL1 WITH 1
ON KEY LABEL F3 DO V_CARCL1 WITH 2
DO CL_VER
RETURN

PROCEDURE stop_prt
******************
RETURN

PROCEDURE CAMBIA_P1
******************
DO CASE
  CASE WPAGINA=1 
    RETURN
  CASE WPAGINA=2
    STORE 1 TO WPAGINA
  CASE WPAGINA=3
    STORE 2 TO WPAGINA
    ON KEY LABEL F2 KEYBOARD ''
    ON KEY LABEL F3 KEYBOARD ''
ENDCASE
DO CL_VER
RETURN 

PROCEDURE CAMBIA_P2
******************
DO CASE
  CASE WPAGINA=1 
    STORE 2 TO WPAGINA  
  CASE WPAGINA=2
    STORE 3 TO WPAGINA
    ON KEY LABEL F2 DO V_CARCL1 WITH 1
    ON KEY LABEL F3 DO V_CARCL1 WITH 2
  CASE WPAGINA=3
    RETURN 
ENDCASE    
DO CL_VER
RETURN 

FUNCTION CHK_CATE
*****************
PARAMETER CATEGORIA
IF LASTKEY()=27
  GOTO ULTIMO
  RETURN .T.
ENDIF  
SELECT V_CATEGO
SEEK CATEGORIA
IF EOF()
  RESUL=.F.
ELSE
  RESUL=.T.
ENDIF
SELECT V_CLIENT
RETURN RESUL    

FUNCTION CHK_CATEGORIA
**********************
PARAMETER CODIGO

	IF (LEN(ALLTRIM(Wclient.cl_catego)) <> 0) THEN
		SELECT V_CATEGO
		SEEK Wclient.cl_empr+CODIGO
		IF FOUND()
   			RETURN .T.
		ELSE
  			SELECT V_CATEGO
			ACTIVATE POPUP GETCATEGO
			REPLACE Wclient.cl_catego WITH SUBSTR(PROMPT(),1,1)
			RETURN .T.
		ENDIF    
	ENDIF
RETURN
