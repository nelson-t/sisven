* PROGRAMA PARA EL MANTENIMIENTO DE REQUERIMIENTOS DE PRODUCCION

DIR="V:\BASE_VEN.99\"
CLOSE DATA
CLEAR
SET REFRESH TO 1
PUBLIC DPTO,DEPART,NRO_LINEAS,MODO,INI_GEST
INI_GEST=CTOD('01/04/99')
DPTO=0
EMPRESA='1'
NRO_LINEAS=30
DEPART=SPACE(2)
MODO=' '
DEFINE WINDOW Z FROM 8,0 TO 21,79 TITLE '> [F4] - ADICIONA REGISTRO  [F8] - BORRA REGISTRO  [F10] - TERMINAR <'
DO SET_AMBI
DO SET_EMPR
DO ON_KEYS
CLEAR
DO RP_VER
STORE .T. TO MU_LOOP
DO WHILE MU_LOOP
   ACTIVATE MENU M_RP
ENDDO
DO FIN
RETURN

PROCEDURE SET_AMBI
******************
SET BLINK OFF
SET CLOCK ON
SET CONFIRM ON
SET EXCLU OFF
SET DATE TO DMY
SET DELE ON
SET TALK OFF
SET SAFETY OFF
SET ESCAPE OFF
SET EXACT OFF
RETURN

PROCEDURE SET_EMPR
******************
*MUESTRA PANTALLA INICIAL E INICIALIZA AMBIENTE CON 'DO SETUP'
SET CURSOR OFF
DO CARATULA WITH 'ESPERE UN MOMENTO POR FAVOR !!'
DO SETUP
SET CURSOR ON
CLEAR
* MUESTRA EMPRESAS
SELECT V_EMPR
DEFINE WINDOW MI_EMPR FROM 5,1 TO 20,78 DOUBLE FILL CHR(177) TITLE '[ESC] PARA SALIR' 
ACTIVATE WINDOW MI_EMPR
@ 3,0
GO TOP
counter=0
DO WHILE .NOT. EOF()
  @ 3+counter,33 SAY ' '+EM_EMPR+'-'+EM_DESCR COLOR G+/b*    
  counter=counter+1
  SKIP
ENDDO 
@ 2,32 TO 3+COUNTER,65 DOUBLE COLOR G+/b*
* PIDE Y VERIFICA EMPRESA

DO WHILE .T. .AND. LASTKEY()<>27
  @ 3, 3 SAY '   SELECCIONE EMPRESA:' GET EMPRESA PICTURE '9' 	COLOR G+/b*
  READ
  SEEK EMPRESA
  IF .NOT. EOF()
    EXIT
  ENDIF
ENDDO
RELEASE WINDOW MI_EMPR  
RETURN

PROCEDURE SETUP
***************
SELECT 1
  USE DIR+'V_DOC_LN' ORDER KARDEX
SELECT 2
  USE DIR+'V_EMPR' ORDER EMPR
SELECT 3
  USE DIR+'V_CLIENT' ORDER CODIGO
SELECT 4
  USE DIR+'V_VENDOR' ORDER CODIGO
SELECT 5
  USE DIR+'V_RP_HD' ORDER CORRE
  SET RELATION TO HR_EMPR+HR_COD_VEN INTO V_VENDOR
*  SET RELATION TO HR_EMPR+HR_COD_CL  INTO V_CLIENT ADDITIVE
SELECT 6
  USE DIR+'V_PED_LN' ORDER PENDIENTE
SELECT 7
  USE DIR+'V_PED_HD' ORDER CORRE
SELECT 8
  USE DIR+'V_ITEMS' ORDER PART
SELECT 9
  USE DIR+'V_REQ_PR' ORDER CORRE
  SET RELATION TO RP_EMPR+RP_PART    INTO V_ITEMS  ADDITIVE
  SET RELATION TO RP_EMPR            INTO V_EMPR   ADDITIVE

DEFINE WINDOW W_RP FROM 0,0 TO 49,79 DOUBLE
DEFINE WINDOW RP_ln FROM 9,0 TO 21,79 TITLE "D E T A L L E" NOFLOAT DOUBLE 
DEFINE WINDOW ped_MSG FROM 21,0 TO 24,79 TITLE "MENSAJES" NOFLOAT DOUBLE 
		
DEFINE MENU M_RP 
PUBLIC MENU M_RP
DEFINE PAD PREV   OF M_RP PROMPT '<-\<PREV'  AT 23,01 SKIP FOR BOF("V_RP_HD")
DEFINE PAD NEXT   OF M_RP PROMPT '\<SIG->'   AT 23,10 SKIP FOR EOF("V_RP_HD")
DEFINE PAD OJEAR  OF M_RP PROMPT '\<OJEA'    AT 23,18
DEFINE PAD BUSCA  OF M_RP PROMPT '\<BUSCA'   AT 23,25
DEFINE PAD MIRA   OF M_RP PROMPT '\<MODIF'   AT 23,33
DEFINE PAD ALTA   OF M_RP PROMPT '\<ALTA'    AT 23,41
DEFINE PAD ANULA  OF M_RP PROMPT 'AN\<UL'    AT 23,48
DEFINE PAD IMPRE  OF M_RP PROMPT '\<IMPR'    AT 23,55
DEFINE PAD PEDIDO OF M_RP PROMPT 'PED->\<RP' AT 23,62
DEFINE PAD SALE   OF M_RP PROMPT 'SA\<LIR'   AT 23,72

ON SELECTION PAD PREV   OF M_RP DO RP_PREV
ON SELECTION PAD NEXT   OF M_RP DO RP_NEXT
ON SELECTION PAD OJEAR  OF M_RP DO RP_OJEAR
ON SELECTION PAD BUSCA  OF M_RP DO RP_BUSCA
ON SELECTION PAD MIRA   OF M_RP DO RP_MODIF
ON SELECTION PAD ALTA   OF M_RP DO RP_ALTA
ON SELECTION PAD ANULA  OF M_RP DO RP_ANULA
ON SELECTION PAD IMPRE  OF M_RP DO RP_IMPRE WITH V_RP_HD.HR_NRO
ON SELECTION PAD PEDIDO OF M_RP DO PEDIDO_RP
ON SELECTION PAD SALE   OF M_RP DO RP_SALE
RETURN

PROCEDURE RP_VER
****************
SELECT V_RP_HD
DO V_RP_V.SPR
ACTIVATE SCREEN
@ 22,0 SAY "ษออออออออหอออออออหออออออหอออออออหอออออออหออออออหออออออหออออออหอออออออออหอออออออป"
@ 23,0 SAY "บ <-PREV บ SIG-> บ OJEA บ BUSCA บ MODIF บ ALTA บ ANUL บ IMPR บ PED->RP บ SALIR บ"
@ 24,0 SAY "ศออออออออสอออออออสออออออสอออออออสอออออออสออออออสออออออสออออออสอออออออออสอออออออผ"
SELECT V_REQ_PR
GO TOP
BROWSE KEY V_RP_HD.HR_EMPR+V_RP_HD.HR_NRO  ;
 FIELDS RP_PART:H='CODIGO':W=.F.:7,V_ITEMS.IT_DESCR:H='DESCRIPCION', ;
 V_ITEMS.IT_UNIDAD:H='UNI.',RP_CANT:H='CANTIDAD':P='9,999,999':W=.F., ;
 RP_CAN_STO:H='P/STOCK':P='99,999,999' WINDOW RP_LN  ;
 NOEDIT NOCLEAR NOAPPEND NOWAIT
RETURN

PROCEDURE CARATULA
******************
PARAMETER MENSAJE
CLEAR
DO V_RP_CA.SPR
RETURN

PROCEDURE RP_NEXT
*****************
SELECT V_RP_HD
IF .NOT. EOF()
   SKIP
ENDIF 
DO RP_VER
RETURN

PROCEDURE RP_PREV
*****************
SELECT V_RP_HD
IF .NOT. BOF()
   SKIP -1
ENDIF 
DO RP_VER
RETURN

PROCEDURE RP_OJEAR
******************
ON KEY LABEL F10 KEYBOARD CHR(23)
set display to vga50
SELECT V_RP_HD
GO BOTT
BROWSE KEY EMPRESA FIELDS HR_NRO:H='NRO.',HR_FECHA:H='FECHA', ;
 HR_OBSV:H='OBSERVACIONES':P='@S30' NOEDIT WINDOW W_RP ;
 TITLE 'F10 - PARA SALIR'
set display to vga25
DO ON_KEYS 
DO RP_VER
RETURN

PROCEDURE RP_BUSCA
******************
DEFINE WINDOW RP_BUSCA FROM 9,20 TO 16,60 DOUBLE TITLE "> BUSQUEDA DE R.P's <"
ACTIVATE WINDOW RP_BUSCA
SELECT V_RP_HD 

MI_RP=SPACE(9)
@ 1,11 SAY 'NUMERO :' GET MI_RP PICTURE '!!-999/99' COLOR W+/B
@ 4,9 GET okcancel FUNCTION '*TH \!\<OK;\?\<Cancelar' DEFAULT 1;
	SIZE 1,10,1 && COLOR B/G
READ CYCLE

IF okcancel = 1
     MI_RP=EMPRESA+MI_RP
     SEEK MI_RP
     IF EOF()
       CLEAR
       @ 2,5 SAY '!!!!!  R.P. NO EXISTE  !!!!! ' COLOR GR+/B
       READ
       GO TOP
     ENDIF
ENDIF

RELEASE WINDOW RP_BUSCA
DO ON_KEYS
DO RP_VER
RETURN

PROCEDURE RP_ANULA
******************
SELECT V_RP_HD
DEFINE WINDOW ANULA_WI FROM 8,20 TO 10,60 DOUBLE TITLE 'DESEA ANULAR ESTE R.P. ?' && COLOR B/G,,B/G,B/G,N+/G
ACTIVATE WINDOW ANULA_WI
SINO='N'
@ 0,5 SAY '          (S/N):' GET SINO PICTURE '!' VALID SINO$'SN'
READ
IF SINO='S'
  IF LOCK()
    REPLACE HR_ESTADO WITH 'A'
    REPLACE HR_OBSV WITH '*** R.P. ANULADO ***'
    SELECT V_REQ_PR
    SEEK V_RP_HD.HR_EMPR+V_RP_HD.HR_NRO
    DO WHILE .NOT. EOF() .AND. V_RP_HD.HR_EMPR+V_RP_HD.HR_NRO=RP_EMPR+RP_NRO
      IF LOCK()
        DELETE 
      ENDIF
      SKIP
    ENDDO     
  ENDIF
  RELEASE WINDOW ANULA_WI  
  MENSAJE1='!!!! EL R.P. HA SIDO ANULADO !!!!' 
  MENSAJE2=''
  DO V_MENSAJ.SPR
  DO RP_VER  
ELSE
  RELEASE WINDOW ANULA_WI  
ENDIF  
RETURN

PROCEDURE RP_SALE
*****************
STORE .F. TO MU_LOOP
  DEACTIVATE MENU
RETURN

PROCEDURE FIN
**************
RELEASE MENU   M_RP
RELEASE WINDOW RP_HD
RELEASE WINDOW Z
RELEASE WINDOW RP_LN
RELEASE WINDOW PED_MSG
CLOSE DATA
ACTIVATE SCREEN
ON KEY
SET ESCAPE ON
CLEAR
RETURN

PROCEDURE ON_KEYS
*****************
DEACTIVATE MENU _SYSMENU
ON KEY LABEL F1 KEYBOARD ''
ON KEY LABEL F2 KEYBOARD ''
ON KEY LABEL F3 KEYBOARD ''
ON KEY LABEL F4 KEYBOARD ''
ON KEY LABEL F5 KEYBOARD ''
ON KEY LABEL F6 KEYBOARD ''
ON KEY LABEL F7 KEYBOARD ''
ON KEY LABEL F8 KEYBOARD ''
ON KEY LABEL F9 KEYBOARD ''
ON KEY LABEL F10 KEYBOARD ''
ON KEY LABEL F11 keyboard ''
ON KEY LABEL F12 keyboard ''
RETURN

PROCEDURE RP_MODIF
******************
MODO="MODI"
SELECT V_RP_HD
DO V_RP_GET.SPR
SELECT V_REQ_PR
DEFINE WINDOW RP_MODI FROM 9, 0 TO 24,79 DOUBLE 
DO WHILE LASTKEY()<>23
 ON KEY LABEL F10 KEYBOARD CHR(23) 
 ON KEY LABEL F8  DO BORRA 
 ON KEY LABEL F4  DO ADD_L_MO
 BROWSE KEY V_RP_HD.HR_EMPR+V_RP_HD.HR_NRO  ;
  FIELDS RP_PART:H='CODIGO':V=GETITEM():P='@!',V_ITEMS.IT_DESCR:H='DESCRIPCION':W=.F., ;
  V_ITEMS.IT_UNIDAD:H='UNI':W=.F.,RP_CANT:H='P/CLIENTE':P='99,999,999', ;
  RP_CAN_STO:H='P/STOCK':V=RETORNO(), ;
  RP_COD_CLI:H='COD.CLI.':V=GETCLI(),RP_FECHA_C:H='FECHA C.' ;
  WINDOW RP_MODI TITLE '[F4] PARA ADICIONA - [F8] PARA BORRAR  -  [F10] PARA SALIR ' 
ENDDO
RELEASE WINDOW RP_MODI
RELEASE WINDOW rp_hd_get
DO ON_KEYS
DO RP_VER
RETURN

PROCEDURE RP_IMPRE
******************
PARAMETERS NUMERO
DEFINE WINDOW RP_IMP FROM 8,20 TO 13,60 DOUBLE TITLE '>> DESEA IMPRIMIR ESTE R.P. ? <<' && COLOR B/G,,B/G,B/G,N+/G
ACTIVATE WINDOW RP_IMP
STORE 1 TO IMP
@ 1,8 SAY 'R.P. # : ' COLOR W+/B
@ 1,19 SAY NUMERO COLOR W+/GB
@ 3,13 GET IMP PICTURE "@*HT \!\<OK;\<SALIR - Esc" 	SIZE 1,0,1 DEFAULT 1 
READ CYCLE
RELEASE WINDOW RP_IMP
IF LASTKEY()=27 .OR. IMP=2
   RETURN
ENDIF   
IF IMP = 1
     RP_FILE='V:'+SYS(3)+".TXT" 
     SELECT V_REQ_PR
     SET RELATION TO RP_EMPR+RP_COD_CLI INTO V_CLIENT ADDITIVE
     _PADVANCE='LINEFEED'
     RP_NRO=NUMERO
     REPORT FORM V_RPROD NOCONSOLE FOR RP_NRO=NUMERO TO FILE (RP_FILE)
     _PADVANCE='FORMFEED'
     *!/0 NPRINT &RP_FILE NFF NB Q=PEDIDOS NFF NB  > NULL 
     !/0 NPRINT &RP_FILE Q=PEDIDOS NFF NB > NULL S=PLASMAR 
     SET RELATION OFF INTO V_CLIENT   
     DELETE FILE (RP_FILE)
     MENSAJE1='EL REQUERIMIENTO DE PRODUCCION No.: '+NUMERO+' HA SIDO IMPRESO !'
     MENSAJE2=''
     DO V_MENSAJ.SPR
     DO ON_KEYS
     DO RP_VER
ENDIF     
RETURN

FUNCTION RETORNO
****************
KEYBOARD "{BACKTAB}"
KEYBOARD "{DNARROW}" 
RETURN

PROCEDURE BORRA
***************
SELECT V_REQ_PR
  DELETE
  KEYBOARD "{ESC}"
RETURN

PROCEDURE RP_ALTA
*****************
MODO="ALTA"
OKCANCEL=1
MI_HD=SYS(3)+'.HD'
MI_LN=SYS(3)+'.LN'
NRO_RP=SPACE(9)
PARTE=SPACE(15)
DO V_REQ_PR.SPR
IF LASTKEY()=27 .OR. EMPTY(DPTO)
   RETURN
ENDIF 
SELECT V_RP_HD
COPY STRUC TO (MI_HD)
SELECT 12
   USE (MI_HD) ALIAS CABEZA EXCLU
   APPEND BLANK
   REPLACE HR_EMPR WITH EMPRESA
HIDE MENU M_RP
HIDE WINDOWS ALL
ACTIVATE SCREEN
CLEAR
@ 14,0 SAY PADC('POR FAVOR, DIGITE LOS DATOS DEL NUEVO REQUERIMIENTO',80)
@ 16,0 SAY PADC('PRESIONE  [Esc]  PARA CANCELAR',80)
DO V_RP_GET.SPR
IF OKCANCEL=2 .OR. LASTKEY()=27
  SELECT CABEZA
  USE
  DELETE FILE (MI_HD)
  SELECT V_RP_HD
  MODO='  '
  DO RP_VER
  RETURN
ENDIF

SELECT V_REQ_PR
COPY STRUCT TO (MI_LN)
SELECT 13
USE (MI_LN) ALIAS LINEAS EXCLU
FOR N=1 TO NRO_LINEAS
  APPEND BLANK
ENDFOR
GO TOP
ON KEY LABEL F10 KEYBOARD CHR(23)
SELECT LINEAS
SET RELATION TO RP_EMPR+RP_PART INTO V_ITEMS
   BROWSE FIELDS RP_PART:H='CODIGO':V=GETITEM():P='@!', ;
   V_ITEMS.IT_DESCR:H='DESCRIPCION':W=.F., ;
   V_ITEMS.IT_UNIDAD:H='UNI.':W=.F., RP_CANT:H='P/CLIENTE':V=GETCANT(), ;
   RP_CAN_STO:H='P/STOCK', RP_P_PEND=GET_PED_PEN(LINEAS.RP_EMPR,LINEAS.RP_PART):H="P/PEND.":R , ;   
   RP_COD_CLI:H='COD.CLI.':V=GETCLI():P='@!',RP_FECHA_C:H='FECHA C.' ;
   WINDOW Z TITLE "[F10] - TERMINA DETALLE   [Esc] - DESCARTA DOCUMENTO" NOCLEAR NOAPPEND NODELETE
GO TOP
IF LASTKEY()<>27
  SELECT CABEZA
  REPLACE HR_NRO WITH NEXT_N(EMPRESA,DEPART) 
  SELECT LINEAS
  GO TOP
  DO WHILE .NOT. EOF() 
    IF RP_PART=SPACE(15) .OR. (RP_CANT+RP_CAN_STO)=0
      DELETE
    ELSE
      REPLACE RP_EMPR  WITH CABEZA.HR_EMPR
      REPLACE RP_NRO   WITH CABEZA.HR_NRO
      REPLACE RP_FECHA WITH CABEZA.HR_FECHA
      REPLACE RP_ESTADO WITH CABEZA.HR_ESTADO
    ENDIF
    SKIP
  ENDDO 
  SELECT 12
  USE
  SELECT 13
  USE
  SELECT V_RP_HD
  APPEND FROM (MI_HD)
  SELECT V_REQ_PR
  APPEND FROM (MI_LN)
ENDIF
MODO="  "
SELECT 12
USE
SELECT 13
USE
DELETE FILE (MI_HD)
DELETE FILE (MI_LN)
FLUSH
DO ON_KEYS
DO RP_VER
IF LASTKEY()<>27
  WAIT 'REQUERIMIENTO #:'+V_RP_HD.HR_NRO+' GENERADO !' NOWAIT WINDOW
ENDIF
RETURN

FUNCTION OBSV
*************
PUBLIC OBS1,OBS2,OBS3
OBSERVA=V_RP_HD.HR_OBSV
OBS1=SUBSTR(OBSERVA,1,59)+IIF(SUBSTR(OBSERVA,60,1)=' ',' ','_')
OBS2=IIF(SUBSTR(OBSERVA,60,1)=' ',LTRIM(SUBSTR(OBSERVA,60,59)),SUBSTR(OBSERVA,60,59))+IIF(SUBSTR(OBSERVA,120,1)=' ',' ','_')
OBS3=IIF(SUBSTR(OBSERVA,120,1)=' ',LTRIM(SUBSTR(OBSERVA,120,60)),SUBSTR(OBSERVA,120,60))
RETURN

FUNCTION GET_PED_PEN
********************
PARAMETERS EMPRESA,PARTE
STORE 0 TO PENDIENTE
ACTUAL=SELECT()
SELECT V_PED_LN
SEEK EMPRESA+'P'+PARTE
IF FOUND()
  CALCULATE SUM(LP_PEND) WHILE LP_EMPR=EMPRESA .AND. LP_PART=PARTE FOR ;
            LP_ESTADO='I'.OR. LP_ESTADO='P' TO PENDIENTE  
ENDIF
SELECT (ACTUAL)
REPLACE RP_P_PEND WITH PENDIENTE
RETURN PENDIENTE

PROCEDURE ADD_L_MO
*****************
APPEND BLANK
REPLACE RP_EMPR WITH V_RP_HD.HR_EMPR, RP_NRO WITH V_RP_HD.HR_NRO, ;
        RP_FECHA WITH V_RP_HD.HR_FECHA, RP_PART WITH SPACE(15)
RETURN

FUNCTION GET_SALDO
******************
PARAMETERS EMPRESA,PARTE
SALDO=0
SELECT V_DOC_LN
SEEK EMPRESA+PARTE
IF FOUND()
  CALCULATE SUM(IIF(LD_INSAL='1',LD_CANT,-LD_CANT)) WHILE LD_EMPR=EMPRESA .AND. LD_PART=PARTE FOR ;
            LD_ESTADO<>'A' TO SALDO
ENDIF
RETURN SALDO

PROCEDURE IT_BUSCA
******************
@ 22,0 CLEAR
@ 22,0 TO 24,79 
@ 23,03 SAY 'SELECCIONE SI SE BUSCA POR CODIGO O POR PARTE DE LA DESCRIPCION DEL ITEM'

DEFINE WINDOW IT_BUSCA FROM 14,10 TO 21,70 DOUBLE TITLE 'BUSQUEDA DE ITEMS'
ACTIVATE WINDOW IT_BUSCA

@ 1,1 GET choice FUNCTION '*RNV POR \<CODIGO;POR \<DESCR.';
	SIZE 1,10,1 DEFAULT 1

MI_COD=' -      '
@ 1,20 SAY 'EMPR. - CODIGO:' GET MI_COD PICTURE '!-'+REPLICATE('!',15) WHEN CHOICE=1

MI_SELE=SPACE(20)
@ 3,20 SAY 'DESCR. A BUSCAR:' GET MI_SELE PICTURE REPLICATE('!',20) WHEN CHOICE=2

@ 5,20 GET okcancel FUNCTION '*TH \!\<OK;\?\<Cancelar' DEFAULT 1;
	SIZE 1,10,1

READ CYCLE
SELECT V_ITEMS
IF okcancel = 1
  DO CASE
   CASE choice = 1
*     ULTIMO=RECNO()
     MI_COD=SUBSTR(MI_COD,1,1)+SUBSTR(MI_COD,3,15)
     SEEK RTRIM(MI_COD)
     IF EOF()
       CLEAR
       @ 2,5
       WAIT '               CODIGO NO EXISTE .... !!' 
     ENDIF
   CASE choice = 2
     MI_SELE=ALLTRIM(MI_SELE)
     ON KEY LABEL F10 KEYBOARD CHR(23)
     ON KEY LABEL ENTER KEYBOARD CHR(23)

     SET REFRESH TO 1

     SELECT V_ITEMS
     BROWSE NODELETE NOAPPEND FOR MI_SELE$IT_DESCR;
        FIELDS IT_EMPR:H='EMPR':R,IT_PART:H='CODIGO':R,IT_LINEA:H='LINEA',IT_DESCR:H='DESCR', IT_UNIDAD:H='UNIDAD', IT_PESO_T:H='PESO T.' ;
        WINDOW W_ITEM TITLE 'SELECCIONE ITEM PRESIONANDO [ENTER]'
     ON KEY 
     ON KEY 
  ENDCASE
ENDIF

RELEASE WINDOW IT_BUSCA
@ 22,0 CLEAR
DO RP_VER
RETURN

FUNCTION GETCANT
****************
IF RP_CANT <= 0 
   ?? CHR(7)
   WAIT 'ERROR !!!, POR FAVOR VERIFIQUE EL MONTO REQUERIDO !!!' WINDOW TIMEOUT 1
   RETURN .F.
ENDIF   
RETURN

FUNCTION GETITEM
****************
REPLACE RP_EMPR WITH EMPRESA
SELECT V_ITEMS
IF MODO="ALTA"
   SEEK EMPRESA+LINEAS.RP_PART
ELSE
   SEEK EMPRESA+V_REQ_PR.RP_PART
ENDIF
   IF .NOT. FOUND()
      SET RELATION OFF INTO V_ITEMS
      SELECT V_ITEMS
      DEFINE WINDOW GETITEM FROM 9,13 TO 23,67 ;
             TITLE '>> SELECCIONE ITEM CON [F10] - [F2] BUSCAR <<' SHADOW COLOR SCHEME 10
      DESC_BUS=SPACE(20)
      ON KEY LABEL F10 KEYBOARD CHR(23)
      ON KEY LABEL F2 DO IT_BUSCA
      GO TOP
      BROW KEY EMPRESA FIELDS IT_PART:H="CODIGO",IT_DESCR:H="DESCRIPCION",IT_UNIDAD:H="UNI." NOEDIT WINDOW GETITEM
      SET FILTER TO
      ON KEY LABEL F2 KEYBOARD ''  
      IF LASTKEY()<>27
         PART=IT_PART
         IF MODO="ALTA"
            SELECT LINEAS
         ELSE
            SELECT V_REQ_PR
         ENDIF
         REPLACE RP_PART WITH PART
         SET RELATION TO EMPRESA+RP_PART INTO V_ITEMS
      ELSE
         IF MODO="ALTA"
            SELECT LINEAS
         ELSE
            SELECT V_REQ_PR
         ENDIF
         SET RELATION TO EMPRESA+RP_PART INTO V_ITEMS
      ENDIF
   ELSE
      IF MODO="ALTA"
         SELECT LINEAS    
      ELSE
         SELECT V_REQ_PR
      ENDIF
      IF LOCK()
         REPLACE RP_PART WITH V_ITEMS.IT_PART
      ENDIF
   ENDIF

RETURN .T.

PROCEDURE BORRA
***************
SELECT V_REQ_PR
  DELETE
  KEYBOARD "{ESC}"
RETURN 

PROCEDURE IT_BUSCA
******************
DEFINE WINDOW IT_BUSCA FROM 13,15 TO 20,65 DOUBLE TITLE '> BUSQUEDA DE ITEMS <' SHADOW
ACTIVATE WINDOW IT_BUSCA

@ 1,1 GET OP_BUSC FUNCTION '*RNV POR \<CODIGO;POR \<DESCR.';
	  SIZE 1,10,1 DEFAULT 1

COD_BUS=SPACE(15)
DESC_BUS=SPACE(20)
@ 1,20 SAY 'CODIGO:' GET COD_BUS PICTURE REPLICATE('!',15) WHEN OP_BUSC=1
@ 3,20 SAY 'DESCR.:' GET DESC_BUS PICTURE REPLICATE('!',20) WHEN OP_BUSC=2
@ 5,15 GET okcancel FUNCTION '*TH \!\<OK;\?\<Cancelar' DEFAULT 1;
	   SIZE 1,10,1
READ CYCLE

SELECT V_ITEMS

IF okcancel = 1
  DO CASE
   CASE OP_BUSC = 1
*     ULTIMO=RECNO()
     COD_BUS=EMPRESA+COD_BUS
     SEEK RTRIM(COD_BUS)
     IF EOF()
        ?? CHR(7)
        WAIT 'EL CODIGO QUE HA DIGITADO'+CHR(13)+'NO EXISTE ....!!!' WINDOW NOWAIT
*        GO ULTIMO
     ENDIF
   CASE OP_BUSC = 2
    DESC_BUS=ALLTRIM(DESC_BUS)
    SET FILTER TO DESC_BUS$IT_DESCR 
  ENDCASE
ENDIF
RELEASE WINDOW IT_BUSCA
RETURN

FUNCTION NEXT_N
***************
PARAMETER EMPR,DPTO
ACTUAL=SELECT()
SELECT 15
USE DIR+'VRP_NRO' ORDER DPTO
SEEK EMPR+DPTO
IF EOF()
  SELECT (ACTUAL)
  RETURN '000000'
ENDIF  
PROXIMO=VAL(VRP_NRO)+1
PROXIMO=DPTO+'-'+RIGHT('00'+ALLTRIM(STR(PROXIMO)),3)+'/'+SUBSTR(STR(YEAR(INI_GEST),4),3,2)
IF LOCK()
   REPLACE VRP_NRO WITH RIGHT('00'+ALLTRIM(SUBSTR(PROXIMO,4,3)),3)
ENDIF
FLUSH
USE
SELECT (ACTUAL)
RETURN PROXIMO

FUNCTION GETCLI
****************
SELECT V_CLIENT
IF MODO="ALTA"
   SEEK EMPRESA+LINEAS.RP_COD_CLI
ELSE
   SEEK EMPRESA+V_REQ_PR.RP_COD_CLI
ENDIF
IF .NOT. FOUND()
      SELECT V_CLIENT
      DEFINE WINDOW GETCLI FROM 9,13 TO 23,57 ;
             TITLE '>[F10]-SELECCIONA CLIENTE : [F2]-BUSCAR<' SHADOW COLOR SCHEME 10
      DESC_BUS=SPACE(20)
      ON KEY LABEL F10 KEYBOARD CHR(23)
      ON KEY LABEL F2 DO CLI_BUSCA
      GO TOP
      BROW FIELDS CL_COD_CL:H="CODIGO",CL_RAZON:H="RAZON SOCIAL" NOEDIT WINDOW GETCLI
      SET FILTER TO
      ON KEY LABEL F2 KEYBOARD ''  
      IF LASTKEY()<>27
         CODCLI=CL_COD_CL
         IF MODO="ALTA"
            SELECT LINEAS
         ELSE
            SELECT V_REQ_PR
         ENDIF
         REPLACE RP_COD_CLI WITH CODCLI
      ELSE
         IF MODO="ALTA"
            SELECT LINEAS
         ELSE
            SELECT V_REQ_PR
         ENDIF
      ENDIF
   ELSE
      IF MODO="ALTA"
         SELECT LINEAS    
      ELSE
         SELECT V_REQ_PR
      ENDIF
      IF LOCK()
         REPLACE RP_COD_CLI WITH V_CLIENT.CL_COD_CL
      ENDIF
   ENDIF
WAIT WINDOW  'CLIENTE : '+ALLTRIM(V_CLIENT.CL_RAZON) NOWAIT
RETURN .T.

PROCEDURE CLI_BUSCA
*******************
DEFINE WINDOW CLI_BUSCA FROM 13,15 TO 20,65 DOUBLE TITLE '> BUSQUEDA DE CLIENTES <' SHADOW
ACTIVATE WINDOW CLI_BUSCA

@ 1,1 GET OP_BUSC FUNCTION '*RNV POR \<CODIGO;POR \<DESCR.';
	  SIZE 1,10,1 DEFAULT 1
COD_BUS=SPACE(15)
DESC_BUS=SPACE(20)

@ 1,20 SAY 'CODIGO:' GET COD_BUS PICTURE '@!' WHEN OP_BUSC=1
@ 3,20 SAY 'DESCR.:' GET DESC_BUS PICTURE '@!' WHEN OP_BUSC=2
@ 5,15 GET okcancel FUNCTION '*TH \!\<OK;\?\<Cancelar' DEFAULT 1;
	   SIZE 1,10,1
READ CYCLE

SELECT V_CLIENT
IF okcancel = 1
  DO CASE
   CASE OP_BUSC = 1
*     ULTIMO=RECNO()
     COD_BUS=EMPRESA+COD_BUS
     SEEK RTRIM(COD_BUS)
     IF EOF()
        ?? CHR(7)
        WAIT 'EL CODIGO QUE HA DIGITADO'+CHR(13)+'NO EXISTE ....!!!' WINDOW NOWAIT
*        GO ULTIMO
     ENDIF
   CASE OP_BUSC = 2
    DESC_BUS=ALLTRIM(DESC_BUS)
    SET FILTER TO DESC_BUS$CL_RAZON 
  ENDCASE
ENDIF
RELEASE WINDOW CLI_BUSCA
RETURN

PROCEDURE PEDIDO_RP    && RUTINA PARA CONVERTIR PEDIDOS EN R.P.'s
*******************
HIDE WINDOWS ALL
HIDE MENU M_RP
ACTIVATE SCREEN
CLEAR
STORE CTOD('') TO FECHAI,FECHAF,FECHAC
STORE ' ' TO LINEA,DEPART
IMPRE=1
DEFINE WINDOW W1 FROM 0, 0 TO 15,79 DOUBLE TITLE 'PEDIDOS PENDIENTES'
DO V_PED_RP.SPR
IF IMPRE=2 .OR. LASTKEY()=27
   DO RP_VER
   RETURN   
ENDIF
WAIT WINDOW 'SELECCIONANDO PEDIDOS'+CHR(13)+'Por Favor Espere ...' NOWAIT
SELECT V_PED_LN
  SET RELATION TO LP_EMPR+LP_PART INTO V_ITEMS
  ARCH=SYS(3)+'.PED'
  COPY TO (ARCH) FOR LP_FECHA>=FECHAI.AND.LP_FECHA<=FECHAF ;
         .AND. LP_ESTADO$'PI'.AND. V_ITEMS.IT_LINEA=ALLTRIM(LINEA)
SELECT 10
  USE (ARCH) ALIAS PED
  SET RELATION TO LP_EMPR+LP_PART INTO V_ITEMS
  SET RELATION TO LP_EMPR+LP_NRO  INTO V_PED_HD ADDITIVE
  ON KEY LABEL SPACEBAR DO MARCA
  ON KEY LABEL F10 KEYBOARD CHR(23)
  ON KEY LABEL ESC DO CANCELA
  ACTIVATE SCREEN
  @ 17,10 SAY 'ภ MARQUE EL ITEM CON LA BARRA ESPACIADORA PARA R.P.'
  @ 19,10 SAY 'ภ PRESIONE [F10] PARA CONVERTIR LOS ITEMS MARCADOS EN R.P.'
  @ 21,10 SAY 'ภ PRESIONE [Esc] PARA CANCELAR'
  KEYBOARD '{LEFTARROW}'
  BROW FIELDS LP_PART:H='CODIGO':W=.F.:10,V_ITEMS.IT_DESCR:H='DESCRIPCION':W=.F.:27, ;
              LP_NRO:H='PEDIDO':W=.F.,LP_FECHA:H='FECHA':W=.F., ;
              LP_COD_CL:H='CLIENT':W=.F.:6, ;
              LP_CANT:H='CANTIDAD':W=.F.,LP_ESTADO:H='E':1 WINDOW W1 
ON KEY
IF LASTKEY()=27
   RELEASE WINDOW W1
   CLEAR
   DO RP_VER
   RETURN
ENDIF
NRO = NEXT_N(EMPRESA,DEPART)
SELECT PED
GO TOP
DO WHILE .NOT. EOF()
   IF LP_ESTADO='๛'
      DO PED_RP WITH LP_EMPR,LP_PART
   ENDIF
   SELECT PED
   VEND=V_PED_HD.HP_COD_VEN
   OBSV=ALLTRIM(V_PED_HD.HP_OBS)
   SKIP
ENDDO
SELECT V_RP_HD
APPEND BLANK
REPLACE HR_EMPR WITH EMPRESA, HR_NRO WITH NRO, HR_FECHA WITH DATE(), ;
        HR_ESTADO WITH 'P', HR_COD_VEN WITH VEND, ;
        HR_OBSV WITH OBSV
*CLOSE ALL
DO RP_VER
RETURN

PROCEDURE PED_RP
****************
PARAMETERS EMPRESA,PARTE
  SELECT V_REQ_PR
  APPEND BLANK
  IF LOCK()
  REPLACE RP_EMPR WITH PED.LP_EMPR, RP_NRO WITH NRO, RP_PART WITH PED.LP_PART, ;
          RP_FECHA WITH DATE(), RP_FECHA_C WITH FECHAC, RP_CANT WITH PED.LP_CANT, ;
          RP_COD_CLI WITH PED.LP_COD_CL, RP_P_PEND WITH GET_PED_PEN(EMPRESA,PARTE), ;
          RP_PEDIDO WITH PED.LP_NRO, RP_ESTADO WITH 'P'
  ENDIF        
RETURN

PROCEDURE MARCA
***************
  REPLACE LP_ESTADO WITH CHR(251)
RETURN      

PROCEDURE CANCELA
*****************
SELECT PED
USE
DELETE FILE (ARCH)
RELEASE WINDOW W1
CLEAR
DO RP_VER
