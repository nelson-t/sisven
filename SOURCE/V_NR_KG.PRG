SET PRINT OFF
SET ESCAPE OFF
CLEAR
CLOSE DATA
SET EXCLU OFF
SET DELE ON
SET DATE TO FRENCH
SET CONFIRM ON
SET TALK OFF

IF TYPE("EMPRESA")="U" OR TYPE("MI_EMPRESA")="U" ;
OR TYPE("INI_GEST")="U"
  DO V_GETEMP
ENDIF

FECHAI=INI_GEST
FECHAF=DATE()

*EMPRESA=' '
*FECHAI={  /  /    }
*FECHAF={  /  /    }
*MI_EMPRESA=SPACE(30)

TIPOR=1
MI_GLOSA=SPACE(30)
MI_GLOSA1=SPACE(30)

T_LINEAS=SPACE(8)
COD_SEC=SPACE(3)
COD_VEN=SPACE(3)
COD_CL=SPACE(8)
TIPO_DOC=' '
ESTADO_DOC=' '

KILOS=0
KILOS1=0

TOT_KILOS=0
ACTUALIZA=1

OPCION=1

DO V_NR_KG.SPR

IF LASTKEY()=27 .OR. OPCION=3
 CLOSE DATA
 CLEAR 
 RETURN
ENDIF

SELECT 1
USE V_LINEAS ORDER LINEA
SELECT 2
USE V_ITEMS  ORDER PART
SET RELATION TO IT_EMPR+SUBSTR(IT_LINEA,1,2)+' ' INTO V_LINEAS
SELECT 4
SELECT 5
USE V_DOC_LN ORDER CORRE
SELECT 6
USE V_DOC_HD ORDER CORRE

DOCS=SYS(3)
DOC_REP='..\TMP\'+DOCS+'.TXT' 
DOC_IDX=DOCS+'.IDX'
DOCS=DOCS+'.DBF'

SELECT V_DOC_LN
SET RELATION TO LD_EMPR+LD_ALM+LD_TIPO+LD_NRO INTO V_DOC_HD ADDITIVE
COPY TO (DOCS) FOR LD_EMPR=EMPRESA .AND. BETWEEN(LD_FECHA,FECHAI,FECHAF) .AND. ;
                       LD_TIPO=ALLTRIM(TIPO_DOC) .AND. ;
                       LD_ESTADO<>'A' .AND. ;
                       IIF(ESTADO_DOC='*',.T.,LD_ESTADO=ESTADO_DOC) .AND.  ;
                       LD_COD_CL=ALLTRIM(COD_CL) .AND. ;
                       V_DOC_HD.HD_OBS=ALLTRIM(COD_SEC) .AND. ;
                       V_DOC_HD.HD_COD_VEN=ALLTRIM(COD_VEN) 

SELECT 7
USE (DOCS) ALIAS DOC_LN
SET RELATION TO LD_EMPR+LD_PART INTO V_ITEMS
INDEX ON LD_EMPR+V_ITEMS.IT_LINEA+LD_PART TO (DOC_IDX)

DO CASE
  CASE OPCION=1 .AND. LASTKEY()<>27
    REPORT FORM V_NR_KG TO FILE (DOC_REP)
    DEFINE WINDOW VER_REP FROM 0,0 TO 24,79 DOUBLE TITLE '[ESC] - PARA SALIR'
    MODI COMM (DOC_REP) WINDOW VER_REP NOEDIT
    RELEASE WINDOW VER_REP    
  CASE OPCION=2 .AND. LASTKEY()<>27
    REPORT FORM V_NR_KG TO FILE (DOC_REP)
    ! COPY &DOC_REP lpt1:
  CASE OPCION=3 .OR. LASTKEY()=27
ENDCASE
CLEAR

CLOSE DATA
DELETE FILE (DOCS)
DELETE FILE (DOC_IDX)
DELETE FILE (DOC_REP)
DELETE FILE (T_LINEAS+'.DBF')
DELETE FILE (T_LINEAS+'.CDX')
RETURN

FUNCTION GET_EMPR
*****************
PARAMETER EMPR
SELECT 0
USE V_EMPR ORDER EMPR
SEEK EMPR
IF EOF()
  USE
  RETURN .F.
ELSE
  MI_EMPRESA=EM_DESCR
  @ 8,37 SAY MI_EMPRESA
  USE
  RETURN .T.
ENDIF

FUNCTION GLOSA
**************
MI_GLOSA=V_LINEAS.LI_DESCR
RETURN ' '

FUNCTION GLOSA1
**************
SELECT V_ITEMS
SET RELATION TO IT_EMPR+SUBSTR(IT_LINEA,1,1)+'  ' INTO V_LINEAS
MI_GLOSA1=V_LINEAS.LI_DESCR
SET RELATION TO IT_EMPR+SUBSTR(IT_LINEA,1,2)+' ' INTO V_LINEAS
SELECT DOC_LN
RETURN ' '