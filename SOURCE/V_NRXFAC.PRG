SET EXCLU OFF
SET DELE ON
CLOSE DATA
CLEAR
SET TALK OFF

IF TYPE("EMPRESA")="U" OR TYPE("MI_EMPRESA")="U" OR TYPE("INI_GEST")="U"
  DO V_GETEMP
ENDIF

SELECT 1
USE V_DOC_HD ORDER NR
SELECT 2
USE V_CLIENTES ORDER CODIGO

SELECT 1
SET RELATION TO HD_EMPR+HD_COD_CL INTO V_CLIENT

SELECT 3
USE V_ITEMS ORDER PART

SELECT 4
USE V_DOC_LN ORDER NR
SET RELATION TO LD_EMPR+LD_TIPO+LD_NRO INTO V_DOC_HD
SET RELATION TO LD_EMPR+LD_PART INTO V_ITEMS ADDITIVE

EXCLUIR='   |   |   '

FECHAI=INI_GEST
FECHAF=DATE()

OPCION=1

DO V_NRXFAC.SPR

IF LASTKEY()=27 .OR. OPCION=3
 CLOSE DATA
 CLEAR 
 RETURN
ENDIF

NRS=SYS(3)
NRS_REP='..\TMP\'+NRS+'.TXT' 

SELECT V_DOC_LN
SET FILTER TO LD_EMPR=EMPRESA .AND. .NOT. LD_ESTADO$'AF' .AND. LD_TIPO$'NR' .AND. BETWEEN(LD_FECHA,FECHAI,FECHAF) ;
              .AND. LD_COD_CL<>'000' .AND. .NOT. SUBSTR(LD_COD_CL,1,3)$EXCLUIR

DO CASE
  CASE OPCION=1 .AND. LASTKEY()<>27
    REPORT FORM V_NRXFAC TO FILE (NRS_REP)
    DEFINE WINDOW VER_REP FROM 0,0 TO 24,79 DOUBLE TITLE '[ESC] - PARA SALIR'
    MODI COMM (NRS_REP) WINDOW VER_REP NOEDIT
    RELEASE WINDOW VER_REP    
  CASE OPCION=2 .AND. LASTKEY()<>27
    REPORT FORM V_NRXFAC TO FILE (NRS_REP)
    ! COPY &NRS_REP lpt1:
  CASE OPCION=3 .OR. LASTKEY()=27
ENDCASE
CLEAR
CLOSE DATA
WAIT "PROCESO CONCLUIDO...SALIENDO." TIMEOUT 2
DELETE FILE (NRS_REP)
RETURN

