PROCEDURE V_PED_PR
******************
SELECT V_TC
SEEK DTOS(E.HP_FECHA)
IF .NOT. EOF()
  TIPO_C=TC_MONTO
ELSE
  MENSAJE1='TIPO DE CAMBIO PARA ESTE DIA NO SE ENCONTRO EN LA TABLA' 
  MENSAJE2='PROFORMA NO PUEDE SER ELABORADA'
  DO V_MENSAJ.SPR
  RETURN
ENDIF  

DEFINE WINDOW PRO_hd ;
		FROM 0, 0 ;
		TO 8,79 ;
		TITLE " P R O F O R M A " ;
		NOFLOAT ;
		DOUBLE 
		
ACTIVATE WINDOW PRO_HD

T_FLETES=0.0
T_EMBALA=0.0
T_OTROS =0.0

SELECT 5

DO V_PRO_V.SPR

DO V_PRO_M.SPR

DO CASE
  CASE OPCION=1 
    SELECT E
    REPLACE HP_NRO WITH V_NEXT_N(EMPRESA,'PRO')
    REPLACE HP_USUARIO WITH SYS(0)  
    SELECT F
    GO TOP
    DO WHILE .NOT. EOF() 
      REPLACE LP_NRO WITH E.HP_NRO
      SKIP
    ENDDO

    SELECT 5
    USE V_PRO_HD ORDER CORRE
    APPEND FROM (P_CABEZA)
    REPLACE HP_LUGAR1 WITH HP_LUGENT
    REPLACE HP_FLETES WITH T_FLETES 
    REPLACE HP_EMBALA WITH T_EMBALA 
    REPLACE HP_OTROS  WITH T_OTROS
    REPLACE HP_AREA   WITH E.HP_AREA
    
    SELECT 6
    USE V_PRO_LN ORDER CORRE
    APPEND FROM (P_LINEAS)

    SELECT V_PRO_HD
    OP_IMPRE=0

    DO V_PRO_MO.SPR
  
    IF OP_IMPRE=1
     MONEDA=1
     DO V_BS_US.SPR
     ************** IMPRESION PROFORMA ********************

     SELECT v_pro_hd
     SET RELATION TO HP_EMPR INTO V_EMPR
     SET RELATION TO HP_EMPR+HP_COD_CL  INTO V_CLIENT ADDITIVE
     SET RELATION TO HP_EMPR+HP_COD_VEN INTO V_VENDOR ADDITIVE

     IF MONEDA=1
       IF LOCK()
         REPLACE HP_MONEDA WITH 'B'
       ENDIF
     ELSE
       IF LOCK()
         REPLACE HP_MONEDA WITH 'U'
       ENDIF
     ENDIF

     SELECT V_pro_LN
     SET RELATION TO LP_EMPR+LP_PART INTO V_ITEMS

     SEEK V_PRO_HD.HP_EMPR+V_PRO_HD.HP_NRO     
     _PLENGHT=66
     TEMP_FILE='V:'+SYS(3)+'.PRO'
     _PADVANCE='LINEFEED'
     REPORT FORM V_PR_FOR NOCONSOLE REST WHILE V_PRO_HD.HP_EMPR+V_PRO_HD.HP_NRO=LP_EMPR+LP_NRO TO FILE (TEMP_FILE)
     _PADVANCE='FORMFEED'
     ACTIVATE SCREEN
     ! COPY &TEMP_FILE lpt1:
     DELETE FILE (TEMP_FILE)
     MENSAJE1='PROFORMA HA SIDO IMPRESA'
     MENSAJE2=''
     DO V_MENSAJ.SPR
   ENDIF  

    SELECT V_PRO_HD
    DO V_PRO_V.SPR
    MENSAJE1='EL PEDIDO NO SE ALMACENO EN EL SISTEMA' 
    MENSAJE2='SE GENERO Y ALMACENO EN EL SISTEMA LA PROFORMA NRO: '+V_PRO_HD.HP_NRO
    DO V_MENSAJ.SPR

  CASE OPCION=2
    * CANCELA
    MENSAJE1='PROFORMA Y PEDIDO DESCARTADOS, NO SE ALMACENARON EN EL SISTEMA' 
    MENSAJE2=''
    DO V_MENSAJ.SPR
ENDCASE

RELEASE WINDO PRO_HD

SELECT 5
USE
SELECT 6
USE

RETURN

FUNCTION SUM_TOT
****************
@10,21 SAY TRANSFORM(T_FLETES+T_EMBALA+T_OTROS,'99,999,999.99')
@12,21 SAY TRANSFORM(HP_IMPORTE-round((hp_importe*hp_dscto_p)/100,2)+T_FLETES+T_EMBALA+T_OTROS,'99,999,999.99')
RETURN .T.
