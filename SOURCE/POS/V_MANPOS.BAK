***************************************************************************
* MANTENIMIENTO DE NOTAS DE REMISION

SET PATH TO ..\DBF; ..\FRT ; \POS


*IF NOT V_VALACC()
*  RETURN
*ENDIF  

IF .NOT. V_USRAUT(USER,"NOTAS_REM",1)
  RETURN
ENDIF

*VERIFICA DOSIFICACION ACTIVA
IF V_GETNDO()=0
  RETURN
ENDIF

*VERIFICA EMPRESA
IF TYPE("EMPRESA")="U" OR TYPE("MI_EMPRESA")="U"
  DO V_GETEMP
ENDIF

*POS genera facturas al contado, a partir de una NR que afecta inventarios
*XXXXXXXXXXXXXXXXXXXXXXXXCAMBIAR A O
TIPO='R'
NRO_PED='000000'
OBS_POS='PUNTO DE VENTA'
                                          
SET COLOR SET TO plasmar
DO SET_AMBI
DO SET_GRAL

IF LASTKEY()=27
  CLOSE DATA
  RETURN
ENDIF

SELECT V_CLIENT
SET FILTER TO CL_EMPR=EMPRESA
SELECT V_DOC_HD
SET FILTER TO HD_EMPR=EMPRESA .AND. HD_TIPO=TIPO

SEEK EMPRESA

STORE .T. TO MU_LOOP
DO NR_VER
DO WHILE MU_LOOP
   ACTIVATE MENU M_NR
ENDDO

DO FIN

RETURN

*******************************************************************************

PROCEDURE SET_AMBI
******************
SET BLINK OFF
SET CLOCK ON
SET CONFIRM ON
SET EXCLU OFF
SET DATE TO DMY
SET DELE ON
SET TALK OFF
SET SAFETY OFF
SET ESCAPE OFF
SET EXACT OFF
RETURN

PROCEDURE SET_GRAL
******************
*MUESTRA PANTALLA INICIAL E INICIALIZA AMBIENTE CON 'SETUP'
SET CURSOR OFF
MENSAJE='ESPERE UN MOMENTO POR FAVOR !!'
CLEAR
DO V_POS_CA.SPR
S_INI=SECONDS()
DO SETUP
S_FIN=SECONDS()
IF S_FIN-S_INI<2
  @ 23,0  
  WAIT '' TIMEOUT 2-(S_FIN-S_INI)
ENDIF
SET CURSOR ON
CLEAR
RETURN

PROCEDURE SETUP
***************
* INICIALIZA AMBIENTE
SELECT 1
USE V_DOC_HD ORDER NR
SELECT 2
USE V_DOC_LN ORDER NR
SELECT 3
USE V_EMPR ORDER EMPR
SELECT 4
USE V_ITEMS ORDER PART
SELECT 5
*USE V_PED_HD ORDER CORRE
SELECT 6
*USE V_PED_LN ORDER CORRE
SELECT 7
USE V_CORRE ORDER EMPRESA
SELECT 8
USE V_CLIENT ORDER CODIGO
SELECT 9
USE V_DESCTO ORDER PART
SELECT 10
USE V_VENDOR ORDER CODIGO
SELECT 11
USE V_CATEGO ORDER CATEGO
SELECT 0
*USE V_NE_HD ORDER NOTAR
SELECT 0
*USE V_NE_LN ORDER NR
SELECT 15
* AREA RESERVADA PARA USO TEMPORAL DE CABEZAS DE FACT. 
SELECT 16
* AREA RESERVADA PARA USO TEMPORAL DE LINEAS DE FACT. 
SELECT 17
USE V_TC ORDER FECHA

SELECT V_DOC_LN
SET RELATION TO LD_EMPR+LD_PART INTO V_ITEMS

SELECT  V_DOC_HD
SET RELATION TO HD_EMPR INTO V_EMPR
SET RELATION TO HD_EMPR+HD_COD_CL  INTO V_CLIENT ADDITIVE
SET RELATION TO HD_EMPR+HD_COD_VEN INTO V_VENDOR ADDITIVE

SELECT V_ITEMS

DEFINE POPUP GETITEM FROM 8,15 TO 20,70 ;
	PROMPT FIELD IT_PART+'-'+IT_DESCR ;
	TITLE 'SELECCIONE ITEM CON [ENTER]' 
ON SELECTION POPUP GETITEM DEACTIVATE POPUP

SELECT V_CLIENT

DEFINE POPUP GETCLIEN FROM 8,20 TO 20,60 ;
	PROMPT FIELD CL_RAZON+'-'+CL_COD_CL ;
	TITLE 'SELECCIONE CLIENTE CON [ENTER]' 
ON SELECTION POPUP GETCLIEN DEACTIVATE POPUP

SELECT V_DOC_HD

DEFINE WINDOW W_NR FROM 0,0 TO 24,79 DOUBLE

DEFINE WINDOW NR_hd FROM 0, 0 TO 8,79 TITLE " NOTA DE REMISION " ;
 NOFLOAT DOUBLE 

DEFINE WINDOW NR_ln FROM 9, 0 TO 21,79 	TITLE "D E T A L L E" ;
 NOFLOAT DOUBLE 
		
DEFINE WINDOW NR_MSG FROM 21, 0 TO 24,79 TITLE "MENSAJES" ;
 NOFLOAT DOUBLE 
	
DEFINE MENU M_NR 

DEFINE PAD PREV  OF M_NR PROMPT '<- \<PREV'   AT 23,01 SKIP FOR BOF("V_DOC_HD")
DEFINE PAD NEXT  OF M_NR PROMPT '\<SIG ->'    AT 23,11 SKIP FOR EOF("V_DOC_HD")
DEFINE PAD OJEAR OF M_NR PROMPT '\<OJEA'      AT 23,20
DEFINE PAD BUSCA OF M_NR PROMPT '\<BUSCA'     AT 23,27
DEFINE PAD MIRA  OF M_NR PROMPT '\<VERIFICA'  AT 23,35
DEFINE PAD ALTA  OF M_NR PROMPT '\<ALTA'      AT 23,46 SKIP FOR .T.
DEFINE PAD ANULA OF M_NR PROMPT 'AN\<UL'      AT 23,53  
DEFINE PAD OPCION OF M_NR PROMPT 'OP\<CIONES' AT 23,60
DEFINE PAD SALE  OF M_NR PROMPT 'SA\<LIR '    AT 23,71

*          1         2         3         4         5         6         7      
*01234567890123456789012345678901234567890123456789012345678901234567890123456789
*ษอออออออออหออออออออหออออออหอออออออหออออออออออหออออออหออออออหออออออออออหออออออออป
*บ <- PREV บ SIG -> บ OJEA บ BUSCA บ VERIFICA บ ALTA บ ANUL บ OPCIONES บ SALIR  บ
*ศอออออออออสออออออออสออออออสอออออออสออออออออออสออออออสออออออสออออออออออสออออออออผ

ON SELECTION PAD PREV   OF M_NR DO NR_PREV
ON SELECTION PAD NEXT   OF M_NR DO NR_NEXT
ON SELECTION PAD OJEAR  OF M_NR DO NR_OJEAR
ON SELECTION PAD BUSCA  OF M_NR DO NR_BUSCA
ON SELECTION PAD MIRA   OF M_NR DO NR_MIRA
ON SELECTION PAD ALTA   OF M_NR DO NR_ALTA
ON SELECTION PAD ANULA  OF M_NR DO NR_ANULA
ON SELECTION PAD OPCION OF M_NR DO V_POS_OP
ON SELECTION PAD SALE   OF M_NR DO NR_SALE
RETURN

PROCEDURE NR_MIRA
*****************
IF V_DOC_HD.HD_ALM='01'
  SELECT V_NE_HD
  *USE V_NE_HD ORDER NOTAR
  SELECT V_NE_LN
  *USE V_NE_LN ORDER NR
  DEFINE WINDOW NE_VER ;
          FROM 4,18 TO 7,78 TITLE 'DESPACHOS' NOCLOSE DOUBLE
  ACTIVATE WINDOW NE_VER        
ENDIF          
        
SELECT V_DOC_LN

DEFINE WINDOW NR_VERI FROM 9, 0 TO 24,79 DOUBLE 
		
ON KEY LABEL F10 KEYBOARD CHR(23)
BROWSE KEY V_DOC_HD.HD_EMPR+V_DOC_HD.HD_TIPO+V_DOC_HD.HD_NRO  ;
       FIELDS LD_PART:H='PART.#',V_ITEMS.IT_DESCR:H='DESCRIPCION',LD_CANT:H='CANTIDAD':P='999,999.99',V_ITEMS.IT_UNIDAD:H='UNI.',LD_PESO:H='kg. TOT.':P='99,999.99' WINDOW NR_VERI  ;
       NOCLEAR NOEDIT NODELETE NOAPPEND TIMEOUT 300  TITLE 'DETALLE  -  [F10] PARA SALIR' ;
       COLOR SCHEME 10 

RELEASE WINDOW NR_VERI
IF V_DOC_HD.HD_ALM='01'
  RELEASE WINDOW NE_VER
  SELECT V_NE_HD
  *USE
  SELECT V_NE_LN
  *USE
ENDIF

SELECT V_DOC_LN
DO V_ONKEYS
DO NR_VER
RETURN

PROCEDURE NR_NEXT
*****************
SELECT V_DOC_HD
IF .NOT. EOF()
   SKIP
ENDIF 
DO NR_VER
RETURN

PROCEDURE NR_PREV
*****************
SELECT V_DOC_HD
IF .NOT. BOF()
   SKIP -1
ENDIF 
DO NR_VER
RETURN

PROCEDURE NR_OJEAR
******************
SELECT V_DOC_HD
DO V_IR_REG.SPR
ON KEY LABEL F10 KEYBOARD CHR(23)
ON KEY LABEL F12 DO V_BEXPOR WITH "HD_NRO, HD_ALM, HD_FECHA, HD_COD_CL, HD_OBS, HD_PEDIDO, HD_FACTURA, HD_ESTADO", ".T."
BROWSE KEY EMPRESA FIELDS HD_NRO:H='NRO.',HD_ALM:H='ALM',HD_FECHA:H='FECHA',HD_COD_CL:H='COD.CLIE.',HD_OBS:H='OBSERVACIONES':P='@S30',HD_PEDIDO:H='PEDIDO',HD_FACTURA:H='FACTURA',HD_ESTADO:H='ESTADO' NOEDIT WINDOW W_NR ;
       TITLE 'SELECCIONE CON [F10] - [F12] GENERA ARCHIVO TEXTO' ;
       COLOR SCHEME 10 NODELETE
ON KEY
DO V_ONKEYS
DO NR_VER
RETURN

PROCEDURE NR_MODI
*****************
IF .NOT. V_USRAUT(USER,"NOTAS_REM",2)
  RETURN
ENDIF
  
SELECT V_DOC_HD
REPLACE HD_MIGRA WITH ' '
SELECT V_DOC_LN
ON KEY LABEL F10 KEYBOARD CHR(23)
BROWSE KEY V_DOC_HD.HD_EMPR+V_DOC_HD.HD_TIPO+V_DOC_HD.HD_NRO  ;
       FIELDS LD_PART:H='PART.#':W=.F.,V_ITEMS.IT_DESCR:H='DESCRIPCION':W=.F.,LD_CANT:H='CANTIDAD':P='999999.99',V_ITEMS.IT_UNIDAD:H='UNI.':W=.F.,LD_PESO:H='kg. TOT.':P='99999.99' WINDOW NR_LN  ;
       noclear NOAPPEND TITLE '[F10] PARA SALIR' 
DO NR_VER       
RETURN

PROCEDURE NR_SALE
*****************
STORE .F. TO MU_LOOP
DEACTIVATE MENU
RETURN

PROCEDURE FIN
**************
RELEASE MENU   M_NR
RELEASE WINDOW NR_HD
RELEASE WINDOW NR_LN
RELEASE WINDOW NR_MSG
RELEASE WINDOW W_NR
CLOSE DATA
ACTIVATE SCREEN
ON KEY
SET ESCAPE ON
CLEAR
SET PATH TO ..\DBF; ..\FRT ;\POS
RETURN

PROCEDURE NR_ALTA
*****************
MENSAJE1='LAS NOTAS DE REMISION SOLO PUEDEN SER GENERADAS A PARTIR DEL PEDIDO' 
MENSAJE2='GENERE LA N.R. EN EL MODULO DE PEDIDOS. GRACIAS.'
DO V_MENSAJ.SPR
RETURN

PROCEDURE NR_ANULA
******************
IF .NOT. V_USRAUT(USER,"NOTAS_REM",2)
  RETURN
ENDIF

SELECT V_DOC_HD
IF HD_ESTADO='F' .OR. HD_FACTURA<>SPACE(6)
    MENSAJE1='LA NOTA DE REMISION NO PUEDE SER ANULADA' 
    MENSAJE2='!! YA FUE FACTURADA !!'
    DO V_MENSAJ.SPR
    RETURN
ENDIF
DEFINE WINDOW ANULA_WI FROM 8,20 TO 10,60 DOUBLE TITLE 'DESEA ANULAR ESTA NR ?' && COLOR B/G,,B/G,B/G,N+/G
ACTIVATE WINDOW ANULA_WI
SINO='N'
@ 0,5 SAY '          (S/N):' GET SINO PICTURE '!' VALID SINO$'SN'
READ

IF SINO='S'

  SELECT V_DOC_HD
  IF LOCK()
    REPLACE HD_ESTADO WITH 'A', ;
            HD_PEDIDO WITH SPACE(6), ;
            HD_IMPORTE WITH 0, ;
            HD_OBS WITH '* * * A N U L A D A * * *', ;
            HD_IMPORTE WITH 0, ;
            HD_U_ANUL WITH USER, ;
            HD_F_ANUL WITH DATE(), ;
            HD_MIGRA WITH ' '

    SELECT V_DOC_LN
    SEEK V_DOC_HD.HD_EMPR+V_DOC_HD.HD_TIPO+V_DOC_HD.HD_NRO
    IF .NOT. EOF() .AND. LOCK()
      REPLACE LD_ESTADO WITH 'A', ;
              LD_PART WITH SPACE(15), ;
              LD_COD_CL WITH SPACE(8), ;
              LD_COD_VEN WITH SPACE(30), ; 
              LD_CANT WITH 0, ;
              LD_PESO WITH 0, ;
              LD_COD_CL WITH SPACE(8)
      SKIP             
      DO WHILE .NOT. EOF() .AND. V_DOC_HD.HD_EMPR+V_DOC_HD.HD_TIPO+V_DOC_HD.HD_NRO=LD_EMPR+LD_TIPO+LD_NRO
        IF LOCK()
          DELETE
        ENDIF
        SKIP
      ENDDO
    ENDIF     
  ENDIF
  RELEASE WINDOW ANULA_WI  
  MENSAJE1='!!!! LA NR HA SIDO ANULADO !!!!' 
  MENSAJE2=''
  DO V_MENSAJ.SPR
  DO NR_VER  
ELSE
  RELEASE WINDOW ANULA_WI  
ENDIF  
RETURN

*-----------------*
FUNCTION GET_ALM
*-----------------*
PARAMETER ALM
SELECT 0 
USE V_ALM ORDER ALM
SEEK EMPRESA+ALM
IF FOUND()
  ALMACEN=SUBSTR(AL_DESCR,1,20)
  USE
ELSE
  ALMACEN='ALMACEN NO EXISTE'
  USE
ENDIF    

PROCEDURE NR_BUSCA
******************
DEFINE WINDOW NR_BUSCA FROM 08,10 TO 19,70 DOUBLE TITLE 'BUSQUEDA DE N.R.' 
ACTIVATE WINDOW NR_BUSCA

MI_NR  =SPACE(6)
MI_CLI =SPACE(8)
MI_NROF=SPACE(6)
MI_NROP=SPACE(6)

@ 1,1 GET choice FUNCTION '*RNV POR \<NRO;POR \<CLIENTE;POR \<FACTURA;POR \<PEDIDO' ;
	SIZE 1,10,1 DEFAULT 1 && COLOR B/G
@ 1,20 GET MI_NR   PICTURE '999999'   WHEN CHOICE=1
@ 3,20 GET MI_CLI  PICTURE '99999999' WHEN CHOICE=2
@ 5,20 GET MI_NROF PICTURE '999999'   WHEN CHOICE=3
@ 7,20 GET MI_NROP PICTURE '999999'   WHEN CHOICE=4
@ 9,20 GET okcancel FUNCTION '*TH \!\<OK;\?\<Cancelar' DEFAULT 1;
	SIZE 1,10,1 && COLOR B/G
READ CYCLE

SELECT V_DOC_HD 
IF okcancel = 1
  W_FILTRO=".T."
  W_TITLE ="SELECCIONE CON [F10] - [F12] GENERA ARCHIVO TEXTO"
  ON KEY LABEL F10 KEYBOARD CHR(23)
  ON KEY LABEL F12 DO V_BEXPOR WITH "HD_NRO, HD_ALM, HD_FECHA, HD_COD_CL, HD_OBS, HD_PEDIDO, HD_NDOSIF, HD_FACTURA, HD_ESTADO", W_FILTRO
  DO CASE
   CASE choice = 1
     W_FILTRO="HD_TIPO=TIPO .AND. ALLTRIM(MI_NR)$HD_NRO"
   CASE choice = 2
     W_FILTRO="ALLTRIM(MI_CLI)$HD_COD_CL"
   CASE choice = 3
     W_FILTRO="ALLTRIM(MI_NROF)$HD_FACTURA"
     SET ORDER TO FACTURA
   CASE choice = 4
     W_FILTRO="ALLTRIM(MI_NROP)$HD_PEDIDO"
     SET ORDER TO PEDIDO
  ENDCASE
  BROWSE NOEDIT FOR EVAL(W_FILTRO) ;
     FIELDS HD_NRO:H='NRO.',HD_ALM:H='ALM',HD_FECHA:H='FECHA',HD_COD_CL:H='COD.CLIE.',HD_OBS:H='OBSERVACIONES':P='@S30',HD_PEDIDO:H='PEDIDO',HD_NDOSIF:H='# DOSIF.', HD_FACTURA:H='FACTURA',HD_ESTADO:H='ESTADO' ;
     WINDOW W_NR TITLE W_TITLE
  SET ORDER TO NR
ENDIF

RELEASE WINDOW NR_BUSCA
DO V_ONKEYS
DO NR_VER
RETURN


PROCEDURE NR_SALE
****************
ALMACEN =SPACE(20)
SELECT V_DOC_HD
DO GET_ALM    WITH HD_ALM
SELECT V_DOC_HD

DO V_POS_A.SPR
CLEAR
do FIN
RETURN
