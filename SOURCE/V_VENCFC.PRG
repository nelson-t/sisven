SET DATE FRENCH
SET CENTURY ON
FECHA_HOY={31/10/1999}

fecha_rep={31/10/1999}

SELECT 1
USE V_CLIENT ORDER CODIGO 
SELECT 2
USE V_FAC_HD ORDER ESTADOS 
set filter to between(hf_fecha,{01/04/1999},{31/10/1999})
SELECT 3
USE V_REC_HD ORDER ESTADOS 
set filter to between(hr_fecha,{01/04/1999},{31/10/1999})
SELECT 4
USE V_TC ORDER FECHA 
SELECT 5
USE V_EMPR 

SELECT 7
CREATE CURSOR VENCIDA (NRO C(6), FECHA D(8), FECHAV D(8), COD_CL C(8), MONTO N(12,2), MONTOPAG N(12,2), SALDOAC N(12,2), DIAS N(4), DIASV N(4) )

SELECT 1
GO TOP
DO WHILE NOT EOF()
  IF CL_COD_CL<>'0' .AND. CL_COD_CL<>'21' .AND. CL_COD_CL<>'22'
    ? CL_COD_CL, V_CLISAL()
    SELECT V_CLIENT
  ENDIF  
  SKIP
ENDDO

SELECT VENCIDA
SET FILTER TO DIASV>0
GO TOP
INDEX ON DIASV TAG DIASV DESC
REPORT FORM V_VENFC1 TO V_VENFC1 FOR MONTO-MONTOPAG>.05 and fechav>=fecha_rep

INDEX ON COD_CL+DTOS(FECHA) TAG COD_CL
SET RELATION TO '2'+COD_CL INTO V_CLIENT
REPORT FORM V_VENFC2 TO V_VENFC2 FOR MONTO-MONTOPAG>.05 and fechav>=fecha_rep

GO TOP
BROW NOEDIT NODELETE


FUNCTION V_CLISAL
*****************
INI_BS=0
INI_US=0
FCR_BS=0
FCR_US=0
FCO_BS=0
FCO_US=0
REC_BS=0
REC_US=0
CARGO_BS=0
CARGO_US=0
ABONO_BS=0
ABONO_US=0
NR_BS=0
NR_US=0
NRO_NRP=0
NRO_PP=0

SALDO_DISP=0

SELECT 6
CREATE CURSOR CONTROL (NRO C(6), FECHA D(8), FECHAV D(8), COD_CL C(8), MONTO N(12,2), MONTOPAG N(12,2), SALDOAC N(12,2), DIAS N(4), DIASV N(4) )

* SALDO INICIAL

SELECT V_TC
SEEK DTOS(V_EMPR.EM_FECHA)
TC_INI=TC_MONTO

SELECT V_CLIENT
INI_BS=CL_SALD_AN
INI_US=(CL_SALD_AN+CL_DIF_AN)/TC_INI

IF INI_US>0
  SELECT CONTROL
  APPEND BLANK
  REPLACE NRO WITH 'INICIO', FECHA WITH {01/04/99}, FECHAV WITH {01/04/99}, ;
          COD_CL WITH v_client.cl_cod_cl, MONTO WITH INI_US
ELSE
  SALDO_DISP=-INI_US
ENDIF  

SELECT V_REC_HD 
SET RELATION TO DTOS(HR_FECHA) INTO V_TC

SEEK V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL
DO WHILE .NOT. EOF() .AND. V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL=HR_EMPR+HR_COD_CL
  IF HR_ESTADO<>'A' 
    REC_BS=REC_BS+HR_TOT_BS
    REC_US=REC_US+HR_TOT_BS/V_TC.TC_MONTO
    SALDO_DISP=SALDO_DISP+HR_TOT_BS/V_TC.TC_MONTO
  ENDIF
  SELECT V_REC_HD
  SKIP
ENDDO
SET RELATION OFF INTO V_TC

***  REVISION DE FACTURAS  ***
SELECT V_FAC_HD 
SET RELATION TO DTOS(HF_FECHA) INTO V_TC

SEEK V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL

DO WHILE .NOT. EOF() .AND. V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL=HF_EMPR+HF_COD_CL
  IF HF_ESTADO<>'A' 
    DO CASE
      CASE HF_TIPO='R'  && FACTURA AL CREDITO
         SELECT CONTROL
         APPEND BLANK
         REPLACE NRO WITH V_FAC_HD.HF_NRO, FECHA WITH V_FAC_HD.HF_FECHA, FECHAV WITH V_FAC_HD.HF_FECHAV, ;
                 COD_CL WITH V_FAC_HD.HF_COD_CL, MONTO WITH ((V_FAC_HD.hf_importe-V_FAC_HD.HF_DSCTO_M-ROUND(V_FAC_HD.hf_importe*(V_FAC_HD.HF_DSCTO_P/100),2)+V_FAC_HD.hf_fletes+V_FAC_HD.hf_embala+V_FAC_HD.hf_otros)/V_FAC_HD.HF_FACTOR)
         SELECT V_FAC_HD

      CASE HF_TIPO='X'  && NOTA DE CREDITO
         SALDO_DISP=SALDO_DISP+HF_IMPORTE/V_TC.TC_MONTO

      CASE HF_TIPO='Y'  && NOTA DE DEBITO
         SALDO_DISP=SALDO_DISP-HF_IMPORTE/V_TC.TC_MONTO

      CASE HF_TIPO='Z'  && COMUN. INTERNA
        IF HF_IMPORTE>0
          SALDO_DISP=SALDO_DISP-HF_IMPORTE/V_TC.TC_MONTO
        ELSE
          SALDO_DISP=SALDO_DISP+ABS(HF_IMPORTE)/V_TC.TC_MONTO
        ENDIF

    ENDCASE
  ENDIF
  SELECT V_FAC_HD 
  SKIP
ENDDO


SET RELATION OFF INTO V_TC

SALDO_DISP=ROUND(SALDO_DISP,2)
SALDO=SALDO_DISP

SELECT CONTROL
GO TOP

DO WHILE .NOT. EOF()
  SALDO=SALDO-MONTO
  REPLACE SALDOAC WITH -SALDO

  DO CASE
    CASE SALDO_DISP>=MONTO
      REPLACE MONTOPAG WITH MONTO
      SALDO_DISP=SALDO_DISP-MONTOPAG

    CASE SALDO_DISP>0 AND SALDO_DISP<MONTO
      REPLACE MONTOPAG WITH SALDO_DISP
      SALDO_DISP=SALDO_DISP-MONTOPAG
      REPLACE DIAS  WITH FECHA_HOY+1-FECHA
      REPLACE DIASV WITH FECHA_HOY+1-FECHAV
      SCATTER MEMVAR
      SELECT VENCIDA
      APPEND BLANK
      GATHER MEMVAR
      SELECT CONTROL

    CASE SALDO_DISP=0
      REPLACE DIAS  WITH FECHA_HOY+1-FECHA
      REPLACE DIASV WITH FECHA_HOY+1-FECHAV
      SCATTER MEMVAR
      SELECT VENCIDA
      APPEND BLANK
      GATHER MEMVAR
      SELECT CONTROL
  ENDCASE      
  SKIP
ENDDO  

SELECT V_CLIENT

RETURN SALDO
