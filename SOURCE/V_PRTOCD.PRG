* PROGRAMA DE MIGRACION DE PLANTA A VENTAS

CLEAR
SET DELE ON
SET DATE TO FRENCH
SET SAFETY OFF

VIA=1     && 1=MODEM 2=DISKETTE
UNIDAD=1  && 1=A  2=B
OPCION=1  && 1=OK 2=CANCELAR

DO V_PRTOCD.SPR

IF OPCION=2 .OR. LASTKEY()=27
  CLEAR
  RETURN
ENDIF  

IF VIA=1 
  DO VIA_MODEM
ELSE 
  DO VIA_DISCO
ENDIF
  
CLOSE DATA
RETURN

PROCEDURE VIA_DISCO
*******************
IF UNIDAD=1
  IF .NOT. V_DISCO('A')
    WAIT 'ERROR EN UNIDAD B ...INSERTE EL DISCO E INTENTE DE NUEVO' WINDOW
    RETURN
  ENDIF
ELSE
  IF .NOT. V_DISCO('B')
    WAIT 'ERROR EN UNIDAD A ...INSERTE EL DISCO E INTENTE DE NUEVO' WINDOW
    RETURN
  ENDIF
ENDIF

IF UNIDAD=1
  CLEAR
  ? "COPIANDO ARCHIVOS .........."
  ?
  ! COPY A:IT*.DBF V:DE_PR
  ! COPY A:HD*.DBF V:DE_PR
  ! COPY A:LN*.DBF V:DE_PR
  ! DEL A:HD*.DBF
  ! DEL A:LN*.DBF
  ! DEL A:IT*.DBF
ELSE
  CLEAR
  ? "COPIANDO ARCHIVOS .........."
  ?
  ! COPY B:IT*.DBF V:DE_PR
  ! COPY B:HD*.DBF V:DE_PR
  ! COPY B:LN*.DBF V:DE_PR
  ! DEL B:HD*.DBF
  ! DEL B:LN*.DBF
  ! DEL B:IT*.DBF
ENDIF
DO MIGRACION
! RENAME V:DE_PR\*.DBF  *.DSC
CLEAR
WAIT 'PROCESO CONCLUIDO !!!' TIMEOUT 2 WINDOW
RETURN

PROCEDURE VIA_MODEM
*******************
DO MIGRACION
! RENAME V:DE_PR\*.DBF  *.MDM
CLEAR
WAIT 'PROCESO CONCLUIDO !!!' TIMEOUT 2 WINDOW
RETURN

PROCEDURE MIGRACION
*******************
SELECT 1
USE V_DOC_HD

SELECT 2
USE V_DOC_LN 

SELECT 3
USE V_ITEMS ORDER PART

SELECT 4
USE I_MIGRA ORDER ESTADO EXCLU

? 'BUSCANDO ARCHIVOS DE DATOS'
? '--------------------------'
?

DIR DE_PR\ TO MIGRA.TXT

APPEND FROM MIGRA.TXT TYPE SDF FOR ARCHIVO='IT' .OR. ARCHIVO='HD' .OR. ARCHIVO='LN'
CLEAR

GO TOP
SEEK ' '
DO WHILE .NOT. EOF() .AND. ESTADO=' '
   DO CASE
     CASE ARCHIVO='IT'
*      BORRAR PRIMERO ITEMS YA CREADOS
       SELECT 0
       USE ('DE_PR\'+I_MIGRA.ARCHIVO) EXCLU ALIAS NEW_ITM
       DO WHILE .NOT. EOF()
         CLAVE=IT_EMPR+IT_PART
         SELECT V_ITEMS
         SEEK CLAVE
         IF FOUND()
           SELECT NEW_ITM
           DELETE
         ENDIF
         SELECT NEW_ITM
         SKIP
       ENDDO
       SELECT NEW_ITM
       PACK
       USE
*      MIGRA SOLO NUEVOS ITEMS       
       ? 'PROCESANDO ARCHIVO: '+I_MIGRA.ARCHIVO
       SELECT V_ITEMS
       APPEN FROM ('DE_PR\'+I_MIGRA.ARCHIVO)
     CASE ARCHIVO='HD'
       ? 'PROCESANDO ARCHIVO: '+I_MIGRA.ARCHIVO
       SELECT V_DOC_HD
       APPEN FROM ('DE_PR\'+I_MIGRA.ARCHIVO)
     CASE ARCHIVO='LN'
       ? 'PROCESANDO ARCHIVO: '+I_MIGRA.ARCHIVO
       SELECT V_ITEMS
       APPEN FROM ('DE_PR\'+I_MIGRA.ARCHIVO)
   ENDCASE
   SELECT I_MIGRA
   REPLACE ESTADO WITH 'M'
   SEEK ' '
ENDDO

CLOSE DATA
RETURN