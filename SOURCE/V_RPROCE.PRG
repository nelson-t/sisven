*********************************************************************************
***        PROGRAMA DE ACTUALIZACION DE DESCUENTOS PARA
***        LAS LINEAS DE FACTURAS
*********************************************************************************
PARAMETER T_EMPR, T_FECHAI, T_FECHAF

CLEAR
? "ACTUALIZANDO DESCUENTOS .."

SET EXCLU OFF
SET DELE  ON
SET TALK  OFF
SET EXACT OFF
SET DATE  TO DMY

DEFINE WINDOW ACTUAL FROM 0,0 TO 24,79 DOUBLE TITLE 'ACTUALIZACION DE DESCUENTO PARA LINEAS DE FACTURAS'
ACTIVATE WINDOW ACTUAL

SELECT 1
USE V_FAC_LN ORDER CORRE ALIAS LF

SELECT 2
USE V_FAC_HD ORDER CORRE ALIAS HF

DO WHILE .NOT. EOF()

  IF HF_EMPR=T_EMPR .AND. BETWEEN(HF_FECHA,T_FECHAI,T_FECHAF) .AND. HF_TIPO$'OR' .AND. HF_ESTADO<>'A'

    IMPORTE =HF_IMPORTE
    TOT_DESC=HF_DSCTO_M+ROUND(hf_importe*(HF_DSCTO_P/100),2)
    
    SELECT LF 
    SEEK HF.HF_EMPR+'F'+STR(HF.HF_NDOSIF,4)+HF.HF_NRO
    COUNT REST WHILE .NOT. EOF() .AND. HF.HF_EMPR+'F'+STR(HF.HF_NDOSIF,4)+HF.HF_NRO=LF_EMPR+'F'+STR(LF_NDOSIF,4)+LF_NRO TO NRO_LINEAS
    ? 'FACTURA:'+STR(HF.HF_NDOSIF,4)+"-"+HF.HF_NRO+'   IMPORTE=',IMPORTE,'DESCUENTO=',TOT_DESC
    DECLARE wdesc(NRO_LINEAS,2)

    N=1
    SEEK HF.HF_EMPR+'F'+STR(HF.HF_NDOSIF,4)+HF.HF_NRO
    DO WHILE .NOT. EOF() .AND. HF.HF_EMPR+'F'+STR(HF.HF_NDOSIF,4)+HF.HF_NRO=LF_EMPR+'F'+STR(LF_NDOSIF,4)+LF_NRO
      STORE ROUND(LF_CANT*LF_PRECIO,2) TO wdesc(N,1)
      STORE ROUND((ROUND(LF_CANT*LF_PRECIO,2)/IMPORTE)*TOT_DESC,2) TO wdesc(N,2)
      N=N+1
      SKIP
    ENDDO
 
    EL_MAYOR=1
    SUM_DESC=0
    MAX_DESC=0
    FOR Y=1 TO NRO_LINEAS
      SUM_DESC=SUM_DESC+wdesc(Y,2)
      IF wdesc(Y,2)>MAX_DESC
        EL_MAYOR=Y
      ENDIF
    ENDFOR

    IF SUM_DESC<>TOT_DESC
      DIF=TOT_DESC-SUM_DESC
      wdesc(EL_MAYOR,2)=wdesc(EL_MAYOR,2)+DIF
    ENDIF

    SUM_DESC=0
    FOR Y=1 TO NRO_LINEAS
      SUM_DESC=SUM_DESC+wdesc(Y,2)
    ENDFOR
*    DISPLAY MEMORY LIKE DESC

*    IF NRO_LINEAS=0 .OR. SUM_DESC<>TOT_DESC
*      WAIT
*    ENDIF
    L_IMPORTE=0    
    N=1
    SEEK HF.HF_EMPR+'F'+STR(HF.HF_NDOSIF,4)+HF.HF_NRO
    DO WHILE .NOT. EOF() .AND. HF.HF_EMPR+'F'+STR(HF.HF_NDOSIF,4)+HF.HF_NRO=LF_EMPR+'F'+STR(LF_NDOSIF,4)+LF_NRO
      IF LOCK()
        REPLACE LF_DESCTOS WITH wdesc(N,2)
      ENDIF
      L_IMPORTE=L_IMPORTE+ROUND(LF_CANT*LF_PRECIO,2)-LF_DESCTOS
      N=N+1
      SKIP
    ENDDO
    IF L_IMPORTE<>IMPORTE-TOT_DESC
      ? "IMPORTE DE LINEAS NO COINCIDE CON CABECERA..", L_IMPORTE,IMPORTE
      WAIT
    ENDIF
  ENDIF
  SELECT HF
  SKIP
ENDDO  

RELEASE WINDOW ACTUAL
CLOSE DATA
RETURN