* PROGRAMA QUE CALCULA EL SALDO DEL CLIENTE A_FECHA Y ALMACENA OTRA INFORMACION 
* EN SU REGISTRO

* SE ASUME QUE SE ESTA UTILIZANDO LA TABLA DE CLIENTES Y EL REGISTRO ACTUAL
* SE UTILIZARA PARA BUSCAR Y ALMACENAR LOS RESULTADOS. TAMBIEN SE USA EN NRs PARA
* MOSTRAR SALDO CTA CLIENTE AL LA FECHA DE LA NR

FUNCTION V_CLISAL
*****************
PARAMETER A_FECHA
IF EOF()
  RETURN
ENDIF

ULT_FECHA=DATE()  &&ULTIMA FECHA DE PAGO
INCLUIR_NR=.T.    &&SE INCLUYE NR NO FACTURADAS EN CALCULO DE DEUDA

CURRENT=SELECT()  &&ALMACENAMOS ALIAS DE LA TABLA ACTUAL
TRECNO= RECNO()   &&REGISTRO ACTUAL

INI_BS=0
INI_US=0
FCR_BS=0
FCR_US=0
FCO_BS=0
FCO_US=0
REC_BS=0
REC_US=0
CARGO_BS=0
CARGO_US=0
ABONO_BS=0
ABONO_US=0
NR_BS=0
NR_US=0
NRO_NRP=0
NRO_PP=0

CREATE CURSOR CONTROL (XFECHA D(8), XCARGO N(10,2), XPAGO N(10,2))
XABONOS=0

SELECT V_TC
SEEK DTOS(V_EMPR.EM_FECHA)
IF FOUND()
  TC_INI=TC_MONTO
ELSE
  WAIT "NO HAY TC PARA:"+DTOC(V_EMPR.EM_FECHA) WINDOW
  WAIT "NO SE CALCULARA CORRECTAMENTE LA DEUDA" WINDOW
  TC_INI=0
ENDIF

SELECT V_CLIENT
COD_CL=V_CLIENT.CL_COD_CL
INI_BS=CL_SALD_AN
INI_US=ROUND((CL_SALD_AN+CL_DIF_AN)/TC_INI,2)

IF INI_US<>0
  SELECT CONTROL
  APPEND BLANK
  REPLACE XFECHA WITH V_EMPR.EM_FECHA, XCARGO WITH INI_US
ENDIF  

***  REVISION DE FACTURAS  ***
CLOSE_F=0
IF !USED("V_FAC_HD")
  CLOSE_F=1
  SELECT 0
  USE V_FAC_HD
ENDIF
  
SELECT V_FAC_HD 
IF EOF()
 GO BOTTOM
ENDIF

FAC_ORDER=ORDER()
FAC_RECNO=RECNO()
SET ORDER TO ESTADOS

SEEK EMPRESA+COD_CL
DO WHILE .NOT. EOF() .AND. EMPRESA+COD_CL=HF_EMPR+HF_COD_CL
  IF HF_ESTADO<>'A' .AND. HF_FECHA<=A_FECHA
    DO CASE
      CASE HF_TIPO='O'
         FCO_BS=FCO_BS+ hf_importe-HF_DSCTO_M-ROUND(hf_importe*(HF_DSCTO_P/100),2)+hf_fletes+hf_embala+hf_otros 
         FCO_US=FCO_US+round((hf_importe-HF_DSCTO_M-ROUND(hf_importe*(HF_DSCTO_P/100),2)+hf_fletes+hf_embala+hf_otros)/V_TC.TC_MONTO,2)
      CASE HF_TIPO='R'  && FACTURA AL CREDITO
         FCR_BS=FCR_BS+ hf_importe-HF_DSCTO_M-ROUND(hf_importe*(HF_DSCTO_P/100),2)+hf_fletes+hf_embala+hf_otros 
         FCR_US=FCR_US+round((hf_importe-HF_DSCTO_M-ROUND(hf_importe*(HF_DSCTO_P/100),2)+hf_fletes+hf_embala+hf_otros)/HF_FACTOR,2)
         SELECT CONTROL
         APPEN BLANK
         REPLACE XFECHA WITH V_FAC_HD.HF_FECHA, XCARGO WITH round((V_FAC_HD.HF_importe-V_FAC_HD.HF_DSCTO_M-ROUND(V_FAC_HD.HF_importe*(V_FAC_HD.HF_DSCTO_P/100),2)+V_FAC_HD.HF_fletes+V_FAC_HD.HF_embala+V_FAC_HD.HF_otros)/V_TC.TC_MONTO,2)
         SELECT V_FAC_HD
      CASE HF_TIPO='X'  && NOTA DE CREDITO
         ABONO_BS=ABONO_BS+hf_importe
         ABONO_US=ABONO_US+round(HF_IMPORTE/V_TC.TC_MONTO,2)
         XABONOS=XABONOS+round(HF_IMPORTE/V_TC.TC_MONTO,2)
      CASE HF_TIPO='Y'  && NOTA DE DEBITO
         CARGO_BS=CARGO_BS+hf_importe
         CARGO_US=CARGO_US+round(HF_IMPORTE/V_TC.TC_MONTO,2)
         SELECT CONTROL
         APPEN BLANK
         REPLACE XFECHA WITH V_FAC_HD.HF_FECHA, XCARGO WITH round(V_FAC_HD.HF_IMPORTE/V_TC.TC_MONTO,2)
         SELECT V_FAC_HD
    ENDCASE
  ENDIF
  SELECT V_FAC_HD 
  SKIP
ENDDO

IF CLOSE_F=1
  USE
ELSE
  SET ORDER TO (FAC_ORDER)
  GO TOP
  IF !EOF()
    GO (FAC_RECNO)
  ENDIF
ENDIF

*
CLOSE_R=0
IF !USED("V_REC_HD")
  CLOSE_R=1
  SELECT 0
  USE V_REC_HD
ENDIF

SELECT V_REC_HD 
IF EOF()
 GO BOTTOM
ENDIF

REC_ORDER=ORDER()
REC_RECNO=RECNO()
SET ORDER TO ESTADOS

SEEK EMPRESA+COD_CL
DO WHILE .NOT. EOF() .AND. EMPRESA+COD_CL=HR_EMPR+HR_COD_CL
  IF HR_ESTADO<>'A' .AND. HR_FECHA<=A_FECHA 
    REC_BS=REC_BS+HR_TOT_BS
    REC_US=REC_US+round(HR_TOT_BS/V_TC.TC_MONTO,2)
    XABONOS=XABONOS+round(HR_TOT_BS/V_TC.TC_MONTO,2)
  ENDIF
  SELECT V_REC_HD
  SKIP
ENDDO

IF CLOSE_R=1
  USE
ELSE
  SET ORDER TO (REC_ORDER)
  GO TOP
  IF !EOF()
    GO (REC_RECNO)
  ENDIF

ENDIF

*
CLOSE_D=0
IF !USED("V_DOC_HD")
  CLOSE_D=1
  SELECT 0
  USE V_DOC_HD
ENDIF

SELECT V_DOC_HD
DOC_ORDER=ORDER()
DOC_RECNO=RECNO()
SET ORDER TO ESTADOS

SEEK EMPRESA+COD_CL
DO WHILE .NOT. EOF() .AND. EMPRESA+COD_CL=HD_EMPR+HD_COD_CL
  IF HD_ESTADO=' ' .AND. HD_TIPO='R' .AND. HD_FECHA<=A_FECHA
    *AQUI SON NR NO FACTURADAS
    IF INCLUIR_NR
         CARGO_BS=CARGO_BS+V_DOC_HD.hd_importe-ROUND((V_DOC_HD.hd_importe* V_DOC_HD.hd_dscto_p)/100,2)+ V_DOC_HD.hd_ped_fle+ V_DOC_HD.hd_ped_emb+ V_DOC_HD.hd_ped_otr
         CARGO_US=CARGO_US+ROUND((V_DOC_HD.hd_importe-ROUND((V_DOC_HD.hd_importe* V_DOC_HD.hd_dscto_p)/100,2)+ V_DOC_HD.hd_ped_fle+ V_DOC_HD.hd_ped_emb+ V_DOC_HD.hd_ped_otr)/V_TC.TC_MONTO,2)
         SELECT CONTROL
         APPEN BLANK
         REPLACE XFECHA WITH V_DOC_HD.HD_FECHA, XCARGO WITH V_DOC_HD.hd_importe-ROUND((V_DOC_HD.hd_importe* V_DOC_HD.hd_dscto_p)/100,2)+ V_DOC_HD.hd_ped_fle+ V_DOC_HD.hd_ped_emb+ V_DOC_HD.hd_ped_otr
    ENDIF
    NRO_NRP=NRO_NRP+1
  ENDIF
  SELECT V_DOC_HD
  SKIP
ENDDO
IF CLOSE_D=1
  USE
ELSE
  SET ORDER TO (DOC_ORDER)
  GO TOP
  IF !EOF()
    GO (DOC_RECNO)
  ENDIF
ENDIF

*
CLOSE_P=0
IF .NOT. USED("V_PED_HD")
  CLOSE_P=1
  SELECT 0
  USE V_PED_HD
ENDIF

SELECT V_PED_HD
IF EOF()
 GO BOTTOM
ENDIF
 
PED_ORDER=ORDER()
PED_RECNO=RECNO()
SET ORDER TO ESTADOS

SEEK EMPRESA+COD_CL
DO WHILE .NOT. EOF() .AND. EMPRESA+COD_CL=HP_EMPR+HP_COD_CL
  IF HP_ESTADO=' '
    NRO_PP=NRO_PP+1
  ENDIF
  SKIP
ENDDO

IF CLOSE_P=1
  USE
ELSE
  SET ORDER TO (PED_ORDER)
  GO TOP
  IF !EOF()
    GO PED_RECNO
  ENDIF
ENDIF

SELECT CONTROL
GO TOP
DO WHILE .NOT. EOF()
  IF XABONOS>=XCARGO
    REPLACE XPAGO WITH XCARGO
    XABONOS=XABONOS-XCARGO
  ELSE
    REPLACE XPAGO WITH XABONOS
    XABONOS=0
  ENDIF
  SKIP
ENDDO  

IF XABONOS>0
  ULT_FECHA=DATE()
ELSE
  GO TOP
  DO WHILE .NOT. EOF()
    IF XCARGO>XPAGO
      ULT_FECHA=XFECHA
      EXIT
    ENDIF
    SKIP
  ENDDO
ENDIF  

SELECT CONTROL
USE  

SELECT (CURRENT)
GO TOP
IF !EOF()
  GO (TRECNO)
ENDIF

SALDO_CTA=INI_BS+FCR_BS+CARGO_BS-REC_BS-ABONO_BS

RETURN SALDO_CTA