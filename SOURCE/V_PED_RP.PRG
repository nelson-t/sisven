* PROGRAMA PARA CONVERTIR PEDIDOS EN R.P.'s

CLOSE ALL
CLEAR
EMPRESA='1'
STORE CTOD('') TO FECHAI,FECHAF,FECHAC
STORE ' ' TO LINEA,DEPART
IMPRE=1
DEFINE WINDOW W1 FROM 0, 0 TO 15,79 DOUBLE TITLE 'PEDIDOS PENDIENTES'
DO V_PED_RP.SPR
IF IMPRE=2 .OR. LASTKEY()=27
   RETURN   
ENDIF
WAIT WINDOW 'SELECCIONANDO PEDIDOS'+CHR(13)+'Por Favor Espere ...' NOWAIT
SELECT 1
  USE V_ITEMS ORDER PART
SELECT 2
  USE V_PED_LN ORDER PENDIENTE
  SET RELATION TO LP_EMPR+LP_PART INTO V_ITEMS
  ARCH=SYS(3)+'.PED'
  COPY TO (ARCH) FOR LP_FECHA>=FECHAI.AND.LP_FECHA<=FECHAF ;
         .AND. LP_ESTADO$'P'.AND. V_ITEMS.IT_LINEA=ALLTRIM(LINEA)
SELECT 3
  USE V_PED_HD ORDER CORRE
SELECT 4
  USE V_REQ_PR ORDER CORRE
SELECT 5
  USE V_RP_HD ORDER CORRE    
SELECT 6
  USE (ARCH) ALIAS PED
  SET RELATION TO LP_EMPR+LP_PART INTO V_ITEMS
  SET RELATION TO LP_EMPR+LP_NRO  INTO V_PED_HD ADDITIVE
  ON KEY LABEL SPACEBAR DO MARCA
  ON KEY LABEL F10 KEYBOARD CHR(23)
  ON KEY LABEL ESC DO CANCELA
  ACTIVATE SCREEN
  @ 17,10 SAY 'À MARQUE EL ITEM CON LA BARRA ESPACIADORA PARA R.P.'
  @ 19,10 SAY 'À PRESIONE [F10] PARA CONVERTIR LOS ITEMS MARCADOS EN R.P.'
  @ 21,10 SAY 'À PRESIONE [Esc] PARA CANCELAR'
  KEYBOARD '{LEFTARROW}'
  BROW FIELDS LP_PART:H='CODIGO':W=.F.:10,V_ITEMS.IT_DESCR:H='DESCRIPCION':W=.F.:29, ;
              LP_NRO:H='PEDIDO':W=.F.,LP_FECHA:H='FECHA':W=.F., ;
              LP_COD_CL:H='CLIENT':W=.F.:6, ;
              LP_CANT:H='CANTIDAD':W=.F.,LP_ESTADO:H='E':1 WINDOW W1 
ON KEY
IF LASTKEY()=27
   RETURN
ENDIF
NRO = NEXT_N(EMPRESA,DEPART)
SELECT PED
GO TOP
DO WHILE .NOT. EOF()
   IF LP_ESTADO='û'
      DO PED_RP WITH LP_EMPR,LP_PART
   ENDIF
   SELECT PED
   VEND=V_PED_HD.HP_COD_VEN
   OBSV=ALLTRIM(V_PED_HD.HP_OBS)
   SKIP
ENDDO
SELECT V_RP_HD
APPEND BLANK
REPLACE HR_EMPR WITH EMPRESA, HR_NRO WITH NRO, HR_FECHA WITH DATE(), ;
        HR_ESTADO WITH 'P', HR_COD_VEN WITH VEND, ;
        HR_OBSV WITH OBSV
CLOSE ALL
RETURN

PROCEDURE PED_RP
****************
PARAMETERS EMPRESA,PARTE
  SELECT V_REQ_PR
  APPEND BLANK
  IF LOCK()
  REPLACE RP_EMPR WITH PED.LP_EMPR, RP_NRO WITH NRO, RP_PART WITH PED.LP_PART, ;
          RP_FECHA WITH DATE(), RP_FECHA_C WITH FECHAC, RP_CANT WITH PED.LP_CANT, ;
          RP_COD_CLI WITH PED.LP_COD_CL, RP_P_PEND WITH GET_PED_PEN(EMPRESA,PARTE), ;
          RP_PEDIDO WITH PED.LP_NRO, RP_ESTADO WITH 'P'
  ENDIF        
RETURN

PROCEDURE MARCA
***************
  REPLACE LP_ESTADO WITH CHR(251)
RETURN      

PROCEDURE CANCELA
*****************
CLOSE ALL
DELETE FILE (ARCH)
RELEASE WINDOW W1
CLEAR
RETURN

FUNCTION NEXT_N
***************
PARAMETER EMPR,DPTO
ACTUAL=SELECT()
SELECT 15
USE VRP_NRO ORDER DPTO
SEEK EMPR+DPTO
IF EOF()
  SELECT (ACTUAL)
  RETURN '000000'
ENDIF  
PROXIMO=VAL(VRP_NRO)+1
PROXIMO=DPTO+'-'+RIGHT('00'+ALLTRIM(STR(PROXIMO)),3)+'/'+SUBSTR(STR(YEAR(DATE()),4),3,2)
IF LOCK()
   REPLACE VRP_NRO WITH RIGHT('00'+ALLTRIM(SUBSTR(PROXIMO,4,3)),3)
ENDIF
FLUSH
USE
SELECT (ACTUAL)
RETURN PROXIMO

FUNCTION GET_PED_PEN
********************
PARAMETERS EMPRESA,PARTE
STORE 0 TO PENDIENTE
SELECT V_PED_LN
SEEK EMPRESA+'P'+PARTE
IF FOUND()
  CALCULATE SUM(LP_PEND) WHILE LP_EMPR=EMPRESA .AND. LP_PART=PARTE FOR ;
            LP_ESTADO='I'.OR. LP_ESTADO='P' TO PENDIENTE  
ENDIF
SELECT V_REQ_PR
RETURN PENDIENTE
