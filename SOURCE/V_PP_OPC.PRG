* PROGRAMA PARA OBTENER PEDIDOS PENDIENTES POR CLIENTE
SET CENTURY ON
CLOSE DATA
CLEAR

IF TYPE("EMPRESA")="U" OR TYPE("MI_EMPRESA")="U" OR TYPE("INI_GEST")="U"
  DO V_GETEMP
ENDIF

STORE ' ' TO L1,L2,L3,L1_DESCR,L2_DESCR,L3_DESCR
CLIENTE=SPACE(8)
FECHAF=DATE()
SALDO=0
STORE 1 TO OPCION,TIPO
DEFINE WINDOW PP FROM 10,0 TO 24,79 TITLE "> Presione [Esc] para Salir <"

DELE FILE ..\TMP\V_PP_CL.TXT
DELE FILE ..\TMP\V_PP_ITR.TXT
DELE FILE ..\TMP\V_PP_ITC.TXT

SELECT 1
USE V_CLIENT ORDER CODIGO

DO V_PP_OPC.SPR

IF OPCION=3 .OR. LASTKEY()=27
   CLOSE ALL
   CLEAR
   RETURN
ENDIF   

REP_ARCH='..\TMP\'+SYS(3)+'.REP'

SELECT 2
  USE V_LINEAS ORDER LINEA  
SELECT 3
  USE V_DOC_LN ORDER KARDEX  
SELECT 4
  USE V_ITEMS ORDER PART
  SET RELATION TO IT_EMPR+IT_LINEA INTO V_LINEAS

DO CASE  
    CASE TIPO=1 
      DO PEND_TOT   
    CASE TIPO=2 
      SELECT 5
      USE V_PED_LN ORDER PENDIENTE 
      SET RELATION TO LP_EMPR+LP_COD_CL INTO V_CLIENT ADDITIVE
      SET RELATION TO LP_EMPR+LP_PART   INTO V_ITEMS  ADDITIVE
      SET FILTER TO LP_ESTADO$"IP" .AND. ;
          (V_ITEMS.IT_LINEA=ALLTRIM(L1) .AND. V_ITEMS.IT_LINEA=ALLTRIM(L2) .AND. V_ITEMS.IT_LINEA=ALLTRIM(L3)) ;
          .AND. LP_FECHA<=FECHAF
      GO TOP
      REPORT FORM V_PP_ITC TO FILE (REP_ARCH) NOCONSOLE
     
    CASE TIPO=3 
      SELECT 5
      USE V_PED_LN ORDER CLI_PEND
      SET RELATION TO LP_EMPR+LP_COD_CL INTO V_CLIENT ADDITIVE
      SET RELATION TO LP_EMPR+LP_PART   INTO V_ITEMS  ADDITIVE
      IF LEN(ALLTRIM(CLIENTE))>0
        SET FILTER LP_ESTADO$'IP' .AND. LP_COD_CL=ALLTRIM(CLIENTE) ;
          .AND. (V_ITEMS.IT_LINEA=ALLTRIM(L1) .AND. V_ITEMS.IT_LINEA=ALLTRIM(L2) .AND. V_ITEMS.IT_LINEA=ALLTRIM(L3)) ;
          .AND.LP_FECHA<=FECHAF
        GO TOP
        REPORT FORM V_PP_CL TO FILE (REP_ARCH) NOCONSOLE

      ELSE
        SET FILTER TO LP_ESTADO$'IP' ;
          .AND. (V_ITEMS.IT_LINEA=ALLTRIM(L1) .AND. V_ITEMS.IT_LINEA=ALLTRIM(L2) .AND. V_ITEMS.IT_LINEA=ALLTRIM(L3)) ;
          .AND.LP_FECHA<=FECHAF
        REPORT FORM V_PP_CL  TO FILE (REP_ARCH) NOCONSOLE

      ENDIF
ENDCASE

IF TIPO<>1
  IF OPCION=1 .
    *PARA PANTALLA
    DEFINE WINDOW P FROM 0,0 TO 24,79 TITLE "> Presione [Esc] para Salir <"
    MODI COMM (REP_ARCH) WINDOW P NOEDIT       
    RELEASE WINDOW P
  ELSE
    ! COPY &REP_ARCH lpt1:
  ENDIF
  CLEAR
  WAIT "PROCESO CONCLUIDO...SALIENDO." TIMEOUT 2
  DELETE FILE (REP_ARCH)
ENDIF

CLOSE ALL
ON KEY
RETURN

PROCEDURE IMPRE
***************
DEFINE WINDOW IMPRE FROM 8,20 TO 16,60 TITLE "> Donde desea enviar el archivo ? <"
ACTIVATE WINDOW IMPRE
@ 1,14 GET DONDE ;
	PICTURE "@*RVN \<PANTALLA;\<IMPRESORA" ;
	SIZE 1,10,0 ;
	DEFAULT 1 
@ 5,5 GET OPCION ;
	PICTURE "@*HT \<ACEPTAR;[Esc]-\<CANCELAR" ;
	SIZE 1,13,1 ;
	DEFAULT 1 ;
	COLOR SCHEME 2	
READ CYCLE
IF LASTKEY()=27 .OR. OPCION=2
   RELEASE WINDOW IMPRE
   RETURN
ENDIF 
RELEASE WINDOW IMPRE  
DO CASE
   CASE DONDE=1
     DEFINE WINDOW P FROM 0,0 TO 24,79 TITLE "> Presione [Esc] para Salir <"
     REPORT FORM V_PP_ITR TO FILE (REP_ARCH) NOCONSOLE
     MODI COMM (REP_ARCH) WINDOW P NOEDIT
     RELEASE WINDOW P     
   CASE DONDE=2
     REPORT FORM V_PP_ITR TO FILE (REP_ARCH) NOCONSOLE
     ! COPY &REP_ARCH lpt1:
ENDCASE	
RETURN

FUNCTION get_sald
******************
PARAMETER EMPR,PARTE
SALDO=0
ACTUAL=SELECT()
SELECT V_DOC_LN
SEEK EMPR+PARTE
DO WHILE .NOT. EOF() .AND. LD_EMPR=EMPR .AND. LD_PART=PARTE
   IF LD_INSAL='1'
      SALDO=SALDO+LD_CANT
   ELSE
      SALDO=SALDO-LD_CANT
   ENDIF
   SKIP
ENDDO
SELECT (ACTUAL)
RETURN SALDO

PROCEDURE PEND_TOT
******************
     SELECT 6
       ARCH=SYS(3)+".DBF"       
       SELECT LP_EMPR AS EMPR, LP_PART AS PARTE, LP_PEND AS PEND, LP_CANT AS SALD,LP_ESTADO AS ESTADO ;
         FROM V_PED_LN, V_ITEMS WHERE LP_PART=V_ITEMS.IT_PART ;
         HAVING LP_ESTADO$'IP'.AND.(IT_LINEA=ALLTRIM(L1) .AND. IT_LINEA=ALLTRIM(L2) .AND. IT_LINEA=ALLTRIM(L3)) ;
         .AND. LP_FECHA<=FECHAF ;
         ORDER BY PARTE ;
         INTO TABLE (ARCH)
       USE
       USE (ARCH) ALIAS PPEND
       INDEX ON PARTE TAG PART
 
       PP=SYS(3)+'.DBF'
       TOTAL TO (PP) ON PARTE FIELDS PEND
       SELECT PPEND
       USE
       USE (PP) ALIAS PP       
       INDEX ON PARTE TAG PARTE
       INDEX ON SALD  TAG SALDO
       INDEX ON PEND  TAG PENDIENTE
       SET ORDER TO PARTE
       
       SET RELATION TO EMPR+PARTE INTO V_ITEMS
       REPLACE SALD WITH 0 ALL
       GO TOP
       DO WHILE .NOT. EOF()
          REPLACE SALD WITH GET_SALD(EMPR, PARTE)
          SKIP
       ENDDO
       GO TOP
       ACTIVATE SCREEN
       CLEAR
       ON KEY LABEL F10 DO IMPRE
       ON KEY LABEL F6 DO POR_PART
       ON KEY LABEL F7 DO POR_PEND 
       ON KEY LABEL F8 DO POR_SALD

       @ 0,0 TO 9,79
       @ 2,1 SAY PADC('PEDIDOS PENDIENTES TOTALIZADOS',78,' ')
       @ 3,1 SAY PADC('컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴',78,' ')
       @ 4,1 SAY PADC(' TECLAS HABILITADAS       [F6] - ORDENAR POR ITEM      ',78,' ')
       @ 5,1 SAY PADC(' 컴컴컴컴컴컴컴컴컴       [F7] - ORDENAR POR CANT.PEND.',78,' ')
       @ 6,1 SAY PADC('[F10] - PARA VER/IMPR     [F8] - ORDENAR POR SALDO     ',78,' ')
       @ 7,1 SAY PADC('[Esc] - PARA SALIR                                     ',78,' ')
       @ 8,1 SAY PADC('                                                       ',78,' ')
       
       BROW FIELDS PARTE:H='CODIGO':W=.F.:10,V_ITEMS.IT_DESCR:H='DESCRIPCION':W=.F., ;
            V_ITEMS.IT_UNIDAD:H='U.':W=.F.:2,PEND:H='PENDIENTE':W=.F.:P='9,999,999', ;
            SALD:H='SALDO':W=.F.:P='9,999,999',NETO=PEND-SALD:H='NETO/P.':W=.F.:P='9,999,999' ;
            WINDOW PP 

       IF LASTKEY()=27
          RELEASE WINDOW PP
          CLOSE ALL
          DELETE FILE (ARCH)         
          DELETE FILE STUFF(ARCH,10,3,'CDX')
          DELETE FILE (PP)
          DELETE FILE STUFF(PP,10,3,'CDX')
          CLEAR
          ON KEY
          RETURN
       ENDIF
RETURN

PROCEDURE POR_PART
******************
SET ORDER TO PARTE
GO TOP
RETURN

PROCEDURE POR_PEND
******************
SET ORDER TO PENDIENTE
GO TOP
RETURN

PROCEDURE POR_SALD
******************
SET ORDER TO SALDO
GO TOP
RETURN

FUNCTION GETCLI
****************
SELECT V_CLIENT
SEEK EMPRESA+CLIENTE
IF .NOT. FOUND()
      SELECT V_CLIENT
      DEFINE WINDOW GETCLI FROM 9,13 TO 23,57 ;
             TITLE '>[F10]-SELECCIONA CLIENTE : [F2]-BUSCAR<' SHADOW COLOR SCHEME 10
      DESC_BUS=SPACE(20)
      ON KEY LABEL F10 KEYBOARD CHR(23)
      ON KEY LABEL F2 DO CLI_BUSCA
      GO TOP
      BROW FIELDS CL_COD_CL:H="CODIGO",CL_RAZON:H="RAZON SOCIAL" NOEDIT WINDOW GETCLI
      SET FILTER TO
      ON KEY LABEL F2 KEYBOARD ''  
      IF LASTKEY()<>27
         CLIENTE=CL_COD_CL
      ENDIF
   ENDIF
WAIT WINDOW  'CLIENTE : '+ALLTRIM(V_CLIENT.CL_RAZON) NOWAIT
RETURN .T.

PROCEDURE CLI_BUSCA
*******************
DEFINE WINDOW CLI_BUSCA FROM 13,15 TO 20,65 DOUBLE TITLE '> BUSQUEDA DE CLIENTES <' SHADOW
ACTIVATE WINDOW CLI_BUSCA

@ 1,1 GET OP_BUSC FUNCTION '*RNV POR \<CODIGO;POR \<DESCR.';
	  SIZE 1,10,1 DEFAULT 1
COD_BUS=SPACE(15)
DESC_BUS=SPACE(20)

@ 1,20 SAY 'CODIGO:' GET COD_BUS PICTURE '@!' WHEN OP_BUSC=1
@ 3,20 SAY 'DESCR.:' GET DESC_BUS PICTURE '@!' WHEN OP_BUSC=2
@ 5,15 GET okcancel FUNCTION '*TH \!\<OK;\?\<Cancelar' DEFAULT 1;
	   SIZE 1,10,1
READ CYCLE

SELECT V_CLIENT
IF okcancel = 1
  DO CASE
   CASE OP_BUSC = 1
     COD_BUS=EMPRESA+COD_BUS
     SEEK RTRIM(COD_BUS)
     IF EOF()
        ?? CHR(7)
        WAIT 'EL CODIGO QUE HA DIGITADO'+CHR(13)+'NO EXISTE ....!!!' WINDOW NOWAIT
     ENDIF
   CASE OP_BUSC = 2
    DESC_BUS=ALLTRIM(DESC_BUS)
    SET FILTER TO DESC_BUS$CL_RAZON 
  ENDCASE
ENDIF
RELEASE WINDOW CLI_BUSCA
RETURN
