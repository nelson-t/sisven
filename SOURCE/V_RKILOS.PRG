SET UDFPARMS REFERENCE
SET EXCLU OFF
SET DELE ON
CLOSE DATA
CLEAR
SET TALK OFF

IF TYPE("EMPRESA")="U" OR TYPE("MI_EMPRESA")="U" OR TYPE("INI_GEST")="U"
  DO V_GETEMP
ENDIF

TIPOR=1
MI_GLOSA=SPACE(30)
MI_GLOSA1=SPACE(30)

COD_AREA=SPACE(1)
COD_VEN=SPACE(3)
COD_CL=SPACE(8)
CL_RAZON=SPACE(30)

KILOS=0
KILOS1=0

TOT_KILOS=0
ACTUALIZA=1

FECHAI=INI_GEST
FECHAF=DATE()

OPCION=1
INCLUIR=1 

SELECT 1
USE V_AREAS ORDER CODIGO ASCENDING
DEFINE POPUP GETAREA FROM 10,36 TO 16,68;
	         PROMPT FIELD A_COD+'-'+A_DES;
	         TITLE 'SELECCIONE CON [ENTER]' 
ON SELECTION POPUP GETAREA DEACTIVATE POPUP

DO V_RKILOS.SPR

IF LASTKEY()=27 .OR. OPCION=3
 CLOSE DATA
 CLEAR 
 RETURN
ENDIF

? "PROCESANDO..."
SELECT 1
USE

IF ACTUALIZA=1
  DO V_RPROCE WITH EMPRESA, FECHAI, FECHAF
ENDIF

SELECT 1
USE V_LINEAS ORDER LINEA

SELECT 2
USE V_ITEMS  ORDER PART
SET RELATION TO IT_EMPR+SUBSTR(IT_LINEA,1,2)+' ' INTO V_LINEAS

SELECT 3
USE V_FAC_LN ORDER CORRE

SELECT 4
USE V_TC ORDER FECHA

SELECT 5
USE V_DOC_HD ORDER CORRE

SELECT 6
USE V_DOC_LN ORDER CORRE
*SELECCIONAMOS E INCLUIMOS NRs NO FACTURADAS
SET FILTER TO LD_EMPR=EMPRESA .AND. BETWEEN(LD_FECHA,FECHAI, FECHAF) ;
   .AND. LD_COD_CL=ALLTRIM(COD_CL) ;
   .AND. LD_COD_VEN=ALLTRIM(COD_VEN) 
          
SET RELATION TO DTOS(LD_FECHA) INTO V_TC ADDITIVE
SET RELATION TO LD_EMPR+LD_ALM+LD_TIPO+LD_NRO INTO V_DOC_HD ADDITIVE

SELECT 7
USE V_AREAS ORDER CODIGO ASCENDING
SEEK (COD_AREA)

SELECT 8
USE V_FAC_HD
SET ORDER TO CORRE

SELECT 9
USE V_CLIENT ORDER CODIGO
IF COD_CL<>SPACE(8)
  SEEK EMPRESA+COD_CL
  IF EOF()
    CL_RAZON='** CLIENTE NO EXISTE **'
  ELSE
    CL_RAZON=CL_RAZON
  ENDIF
ENDIF

FACTURAS='..\TMP\'+SYS(3)
FACT_REP='..\TMP\'+SYS(3)+'.TXT' 

SELECT V_FAC_LN
SET RELATION TO LF_EMPR+IIF(LF_TIPO$'RO','F',LF_TIPO)+LF_NRO INTO V_FAC_HD ADDITIVE

IF INCLUIR=1 OR INCLUIR=2
	COPY TO (FACTURAS) WITH CDX FOR LF_EMPR=EMPRESA .AND. BETWEEN(LF_FECHA,FECHAI,FECHAF) ;
 	.AND. V_FAC_LN.LF_COD_CL=ALLTRIM(COD_CL) .AND. ;
	 V_FAC_HD.HF_AREA=ALLTRIM(COD_AREA) .AND. ;
	 V_FAC_HD.HF_COD_VEN=ALLTRIM(COD_VEN) .AND. ;
 	LF_ESTADO<>'A'
ELSE
	COPY STRUCTURE TO (FACTURAS) WITH CDX 
ENDIF

SELECT 10
USE (FACTURAS) ALIAS FAC_LN EXCLUSIVE
SET RELATION TO LF_EMPR+LF_PART INTO V_ITEMS
SET RELATION TO DTOS(LF_FECHA)  INTO V_TC ADDITIVE

**ADICIONAMOS NR NO FACTURADAS

IF INCLUIR=2 OR INCLUIR=3

SELECT V_DOC_LN
GO TOP
DO WHILE .NOT. EOF() 
  IF V_TC.TC_MONTO=0
    WAIT "TIPO DE CAMBIO PARA ESTA FECHA NO EXISTE:"+DTOC(LD_FECHA) WINDOW TIMEOUT 3
    DO SALIR
  ENDIF

  *INCLUYE TODAS LAS NRs NO FACTURADAS o FACTURADAS DESPUES DE LA FECHAF
  IF ((LD_TIPO='R' .AND. LD_ESTADO=' ') .OR. (LD_TIPO='R' .AND. LD_ESTADO='F' .AND. V_DOC_HD.HD_F_FAC>FECHAF)) ;
    .AND. V_DOC_HD.HD_AREA=ALLTRIM(COD_AREA)

  SELECT FAC_LN
  APPEND BLANK
  IF LOCK()
    REPLACE LF_EMPR   WITH v_doc_ln.LD_EMPR
    REPLACE LF_FECHA  WITH v_doc_ln.LD_FECHA
    REPLACE LF_NRO    WITH v_doc_ln.LD_NRO
    REPLACE LF_COD_CL WITH v_doc_ln.LD_COD_CL
    REPLACE LF_TIPO   WITH "N" 
    REPLACE LF_PART   WITH v_doc_ln.LD_PART 
    REPLACE LF_CANT   WITH v_doc_ln.LD_CANT
    REPLACE LF_LISTA  WITH v_doc_ln.LD_LISTA
    REPLACE LF_PESO   WITH v_doc_ln.LD_PESO
    REPLACE LF_PRECIO WITH v_doc_ln.LD_PRECIO
	IF V_DOC_HD.HD_DSCTO_P>0
	  REPLACE LF_DESCTOS WITH ROUND((LF_CANT*LF_PRECIO)*(V_DOC_HD.HD_DSCTO_P/100),2) 
   ENDIF
 ENDIF

 ENDIF
 SELECT V_DOC_LN
 SKIP
 
ENDDO

ENDIF

SELECT FAC_LN
INDEX ON LF_EMPR+V_ITEMS.IT_LINEA+LF_PART+DTOS(LF_FECHA) TAG LIPART
GO TOP

DO CASE
  CASE OPCION=1 .AND. LASTKEY()<>27
    DO CASE
      CASE TIPOR=1  && Detallado
        REPORT FORM V_RKILOS TO FILE (FACT_REP)
      CASE TIPOR=2  && Resumido
        REPORT FORM V_RKILO2 TO FILE (FACT_REP)
      CASE TIPOR=3	&& Agrupado por CLIENTE
	    SET RELATION TO LF_EMPR+LF_COD_CL INTO V_CLIENT ADDITIVE
        INDEX ON LF_EMPR+LF_COD_CL+V_ITEMS.IT_LINEA+LF_PART TAG LICOCL
        REPORT FORM V_RKILO3 TO FILE (FACT_REP)
	  CASE TIPOR=4  && Agrupado por AREA
		SELECT FAC_LN
		SCAN
			IF LF_TIPO='N'
  				SELECT V_DOC_HD
  				SET ORDER TO NR
				SEEK FAC_LN.LF_EMPR+'R'+FAC_LN.LF_NRO
				SELECT FAC_LN
				REPLACE FAC_LN.LF_COD_CL WITH V_DOC_HD.HD_AREA
			ELSE
  				SELECT V_FAC_HD
				SEEK FAC_LN.LF_EMPR+IIF(FAC_LN.LF_TIPO$'RO','F',FAC_LN.LF_TIPO)+FAC_LN.LF_NRO
				SELECT FAC_LN
				REPLACE FAC_LN.LF_COD_CL WITH V_FAC_HD.HF_AREA
			ENDIF
		ENDSCAN

		SELECT FAC_LN
        INDEX ON LF_EMPR+LF_COD_CL+V_ITEMS.IT_LINEA+LF_PART TAG LICOCL
		SET RELATION TO FAC_LN.LF_COD_CL INTO V_AREAS ADDITIVE
 
		REPORT FORM V_RKILO5 TO FILE (FACT_REP)

    ENDCASE
    DEFINE WINDOW VER_REP FROM 0,0 TO 24,79 DOUBLE TITLE '[ESC] - PARA SALIR'
    MODI COMM (FACT_REP) WINDOW VER_REP NOEDIT
    RELEASE WINDOW VER_REP    

  CASE OPCION=2 .AND. LASTKEY()<>27
    DO CASE
      CASE TIPOR=1
        REPORT FORM V_RKILOS TO FILE (FACT_REP)
      CASE TIPOR=2
        REPORT FORM V_RKILO2 TO FILE (FACT_REP)
      CASE TIPOR=3	&& Agrupado por area
        SET RELATION TO LF_EMPR+LF_COD_CL INTO V_CLIENT ADDITIVE
        INDEX ON LF_EMPR+LF_COD_CL+V_ITEMS.IT_LINEA+LF_PART TAG COCLLI
        REPORT FORM V_RKILO3 TO FILE (FACT_REP)
      CASE TIPOR=4
		SELECT FAC_LN
		SCAN
			IF LF_TIPO='N'
  				SELECT V_DOC_HD
  				SET ORDER TO NR
				SEEK FAC_LN.LF_EMPR+'R'+FAC_LN.LF_NRO
				SELECT FAC_LN
				REPLACE FAC_LN.LF_COD_CL WITH V_DOC_HD.HD_AREA
			ELSE
  				SELECT V_FAC_HD
				SEEK FAC_LN.LF_EMPR+IIF(FAC_LN.LF_TIPO$'RO','F',FAC_LN.LF_TIPO)+FAC_LN.LF_NRO
				SELECT FAC_LN
				REPLACE FAC_LN.LF_COD_CL WITH V_FAC_HD.HF_AREA
			ENDIF
		ENDSCAN

		SELECT FAC_LN
        INDEX ON LF_EMPR+LF_COD_CL+V_ITEMS.IT_LINEA+LF_PART TAG LICOCL
		SET RELATION TO FAC_LN.LF_COD_CL INTO V_AREAS ADDITIVE

		REPORT FORM V_RKILO5 TO FILE (FACT_REP)

    ENDCASE
    ! COPY &FACT_REP  lpt1:
  CASE OPCION=3 .OR. LASTKEY()=27
ENDCASE
CLEAR
DO SALIR
RETURN

PROCEDURE SALIR
***************
CLOSE DATA
WAIT "PROCESO CONCLUIDO...SALIENDO." TIMEOUT 2
DELETE FILE (FACTURAS+".DBF")
DELETE FILE (FACTURAS+".CDX")
DELETE FILE (FACT_REP)
RETURN TO MASTER

FUNCTION GLOSA
**************
MI_GLOSA=V_LINEAS.LI_DESCR
RETURN ' '

FUNCTION GLOSA1
**************
SELECT V_ITEMS
SET RELATION TO IT_EMPR+SUBSTR(IT_LINEA,1,1)+'  ' INTO V_LINEAS
MI_GLOSA1=V_LINEAS.LI_DESCR
SET RELATION TO IT_EMPR+SUBSTR(IT_LINEA,1,2)+' ' INTO V_LINEAS
SELECT FAC_LN
RETURN ' '

FUNCTION GLOSA3
***************
SELECT V_AREAS
SEEK SUBSTR(FAC_LN.LF_COD_CL,1 ,1)
RETURN ' '

FUNCTION CHK_AREA
*****************
PARAMETER CODIGO
RESULT = ' '
	IF (LEN(ALLTRIM(CODIGO)) <> 0) THEN
		SELECT V_AREAS
		SEEK CODIGO
		IF FOUND()
   			RESULT = CODIGO
		ELSE
  			SELECT V_AREAS
			ACTIVATE POPUP GETAREA
			IF (LASTKEY() = 27) &&ESC
				RESULT = ' '
			ELSE
				RESULT = SUBSTR(PROMPT(),1,1)
			ENDIF
		ENDIF    
	ENDIF
RETURN RESULT
