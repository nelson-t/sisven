* PROGRAMA DE ACTUALIZACION DE kg.

IF TYPE("EMPRESA")="U" OR TYPE("MI_EMPRESA")="U"
  DO V_GETEMP
ENDIF

ALM="  "

SET DECIMALS TO 5

CLOSE DATA

TOT_CANT=0
TOT_PESO=0
TOT_ING =0
SINING=0

DO V_ASGKG.SPR

IF LASTKEY()=27
  RETURN
ENDIF
  
CLEAR

SELECT 1
USE V_DOC_LN ORDER KARDEX 
SET FILTER TO LD_ALM=ALM

SELECT 2
USE V_ITEMS ORDER PART

SELECT V_DOC_LN
SET RELATION TO LD_EMPR+LD_PART INTO V_ITEMS

GO TOP
SEEK EMPRESA
DO WHILE .NOT. EOF() .AND. LD_EMPR=EMPRESA .AND. LASTKEY()<>27
  REPLACE V_ITEMS.IT_PESO_R WITH V_ITEMS.IT_PESO_T
  REPLACE LD_PESO WITH LD_CANT*V_ITEMS.IT_PESO_T
  @ 10,10 SAY "PROCESANDO ...."
  SKIP
ENDDO  

CLOSE DATA 
RETURN

PROCEDURE ANTERIOR
******************
GO TOP
ITEM=SPACE(15)
SEEK EMPRESA
DO WHILE .NOT. EOF() .AND. LD_EMPR=EMPRESA .AND. LASTKEY()<>27
  IF LD_PART<>SPACE(15) .AND. LD_ESTADO<>'A' .AND. LD_ALM=ALM
    IF LD_PART<>ITEM
      KG_UNI=0
      ITEM=LD_PART
      TOT_CANT=0
      TOT_PESO=0
      TOT_ING =0
    ENDIF
    DO CASE
      CASE LD_INSAL='1'
        TOT_ING=TOT_ING+LD_CANT
        TOT_CANT=TOT_CANT+LD_CANT
        TOT_PESO=TOT_PESO+LD_PESO
        KG_UNI=TOT_PESO/TOT_CANT
        IF TOT_CANT<>0
          REPLACE V_ITEMS.IT_PESO_R WITH KG_UNI
        ENDIF
      CASE LD_INSAL='2'
        IF LD_TIPO<>'A'  && INVENTARIO
          IF TOT_CANT<=0
            IF LOCK()
              REPLACE LD_PESO WITH KG_UNI*LD_CANT
            ENDIF 
          ELSE 
            IF LOCK()
              REPLACE LD_PESO WITH (TOT_PESO/TOT_CANT)*LD_CANT
              IF TOT_CANT<>0
                 REPLACE V_ITEMS.IT_PESO_R WITH (TOT_PESO/TOT_CANT)
              ENDIF
              ? LD_NRO,LD_PART,LD_CANT,LD_PESO
            ENDIF
          ENDIF
        ENDIF
        
        IF TOT_ING=0
          CLEAR 
          PTEO=V_ITEMS.IT_PESO_T
          SINING=SINING+1

          IF SINING=1
            @ 09,0 say 'SE DETECTO SALIDAS SIN INGRESO DE MATERAIL ANTERIOR!'
            @ 10,0 say 'SE ASIGNARA PESOS TEORICOS.'
            WAIT 'PRESIONE [ESC] PARA SALIR O [ENTER] PARA CONTINUAR'
          ENDIF

          IF PTEO=0            
            @ 10,0 say 'SALIDA SIN INGRESO ANTERIOR Y PESO TEORICO =0'
            @ 11,0 SAY LD_TIPO+'-'+LD_NRO+' '+LD_PART+'  CANT.='+transform(ld_cant,'999,999.99')+' PESO=' get PTEO
            READ
          ENDIF
          REPLACE ld_peso WITH PTEO*ld_cant
          CLEAR
          @ 10,10 SAY "PROCESANDO ...."
        ENDIF
        TOT_CANT=TOT_CANT-LD_CANT
        TOT_PESO=TOT_PESO-LD_PESO
    ENDCASE  
  ENDIF
  SKIP
ENDDO
CLEAR
RETURN

