* PROGRAMA DE ACTUALIZACION DE kg.
SET DECIMALS TO 5

CLOSE DATA


TOT_CANT=0
TOT_PESO=0
TOT_ING =0

EMPR='1'
ALM='  '
*FECHAI={01/04/95}
*FECHAF={30/06/94}

DO V_ASGKG.SPR
CLEAR

SELECT 1
USE V_DOC_LN ORDER KARDEX 

SELECT 2
USE V_FAC_LN ORDER PART

SELECT V_DOC_LN

GO TOP
ITEM=SPACE(15)
SEEK EMPR
DO WHILE .NOT. EOF() .AND. LD_EMPR=EMPR
  IF LD_PART<>SPACE(15) .AND. LD_ESTADO<>'A' .AND. LD_ALM=ALM
    IF LD_PART<>ITEM
      KG_UNI=0
      ITEM=LD_PART
      TOT_CANT=0
      TOT_PESO=0
      TOT_ING =0
    ENDIF
    DO CASE
      CASE LD_INSAL='1'
        TOT_ING=TOT_ING+LD_CANT
        TOT_CANT=TOT_CANT+LD_CANT
        TOT_PESO=TOT_PESO+LD_PESO
        KG_UNI=TOT_PESO/TOT_CANT
      CASE LD_INSAL='2'
        IF LD_TIPO<>'A'  && INVENTARIO
          IF TOT_CANT<=0
            IF LOCK()
              REPLACE LD_PESO WITH KG_UNI*LD_CANT
            ENDIF 
          ELSE 
            IF LOCK()
              REPLACE LD_PESO WITH (TOT_PESO/TOT_CANT)*LD_CANT
              ? LD_NRO,LD_PART,LD_CANT,LD_PESO
            ENDIF
          ENDIF
        ENDIF
        SELECT V_FAC_LN
        SEEK V_DOC_LN.LD_EMPR+V_DOC_LN.LD_PART
        DO WHILE .NOT. EOF() .AND. V_DOC_LN.LD_EMPR+V_DOC_LN.LD_PART=LF_EMPR+LF_PART
          IF LF_FECHA >= V_DOC_LN.LD_FECHA .AND. LF_FECHA>{01/05/95}
            REPLACE LF_PESO WITH LF_CANT*(V_DOC_LN.LD_PESO/V_DOC_LN.LD_CANT)
          ENDIF
          SKIP
        ENDDO
        IF TOT_ING=0
          CLEAR 
          @ 10,0 say  'SALIDA SIN INGRESO ANTERIOR: '
          @ 11,0 SAY LD_TIPO+'-'+LD_NRO+' '+LD_PART+'  CANT.='+transform(ld_cant,'999,999.99')+' PESO=' get ld_peso
          READ
          CLEAR
        ENDIF
        TOT_CANT=TOT_CANT-LD_CANT
        TOT_PESO=TOT_PESO-LD_PESO
    ENDCASE  
  ENDIF
  SKIP
ENDDO
CLOSE DATA 
RETURN

FUNCTION GET_EMPR
*****************
PARAMETER EMPR
SELECT 0
USE V_EMPR ORDER EMPR
SEEK EMPR
IF EOF()
  USE
  RETURN .F.
ELSE
  MI_EMPRESA=EM_DESCR
  @ 8,37 SAY MI_EMPRESA
  USE
  RETURN .T.
ENDIF
