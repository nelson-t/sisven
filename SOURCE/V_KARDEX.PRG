PROCEDURE V_KARDEX
******************
SET PRINT OFF
SET ESCAPE OFF
CLEAR
CLOSE DATA
SET EXCLU OFF
SET DELE ON
SET DATE TO FRENCH
SET CONFIRM ON
SET TALK OFF

IF TYPE("EMPRESA")="U" OR TYPE("MI_EMPRESA")="U" ;
OR TYPE("INI_GEST")="U"
  DO V_GETEMP
ENDIF

FECHAI=INI_GEST
FECHAF=DATE()

SELECT 1
USE V_EMPR ORDER EMPR

SELECT 2
USE V_ALM ORDER ALM

SELECT 3
USE V_ITEMS ORDER PART

SELECT 4
USE V_DOC_LN ORDER KARDEX

SELECT 5
USE V_DOC_HD ORDER CORRE

SELECT 4
SET RELATION TO LD_EMPR+LD_ALM+LD_TIPO+LD_NRO INTO V_DOC_HD

ALMACEN='  '
PARTE=SPACE(15)

SELECT V_ITEMS 

DO WHILE .T.
  CLEAR
  OPCION=1
  TIPOR=1
  
  DO V_KARDEX.SPR

  IF OPCION=3 .OR. LASTKEY()=27
    EXIT
  ENDIF
  
  K_OPCION=1
  
  DO V_KAR_O.SPR
  
  DO LISTA WITH OPCION, K_OPCION

  SELECT V_ITEMS
  SKIP
  PARTE=IT_PART
ENDDO
CLOSE DATA
RETURN


FUNCTION CHECK_PART
*******************
PARAMETER EMP,PAR
SELECT V_ITEMS
SEEK EMP+PAR
IF EOF()
  if lastkey()=27
    return .t.
  endif
  RETURN .F.
ELSE
  @ 9,39 SAY V_ITEMS.IT_DESCR
  RETURN .T.
ENDIF

FUNCTION CHECK_ALM
*******************
PARAMETER EMPRESA,ALM
SELECT V_ALM
SEEK EMPRESA+ALM
IF EOF()
  if lastkey()=27
    return .t.
  endif
  RETURN .F.
ELSE
  @ 7,26 SAY V_ALM.AL_DESCR
  RETURN .T.
ENDIF

PROCEDURE LISTA
***************
PARAMETER OP, K_OP
 
DEFINE WINDOW MENSAJE FROM 16,5 TO 24,74 DOUBLE
ACTIVATE WINDOW MENSAJE

SELECT V_DOC_LN
SEEK EMPRESA+PARTE

IF EOF()
  @ 2,0
  WAIT '                       ITEM SIN MOVIMIENTOS !!!'
  RELEASE WINDOW MENSAJE
ELSE
  MI_ARCH='..\TMP\'+SYS(3)+'.KAR'

  SUM REST WHILE .NOT. EOF() .AND. LD_EMPR+LD_PART=EMPRESA+PARTE .AND. ;
      LD_FECHA>=INI_GEST .AND. LD_FECHA<FECHAI  ;
      IIF(LD_INSAL='1',v_doc_ln.ld_cant,-V_DOC_LN.LD_CANT), ;
      IIF(LD_INSAL='1',v_doc_ln.ld_peso,-V_DOC_LN.LD_PESO),  ;
      IIF(LD_INSAL='1',ROUND(v_doc_ln.ld_CANT*v_doc_ln.ld_COSTO,2), -ROUND(v_doc_ln.ld_CANT*v_doc_ln.ld_COSTO,2)) ; 
      TO CANT_ANT, KG_ANT, BS_ANT

  IF .NOT. LD_EMPR+LD_PART=EMPRESA+PARTE
    @ 1,0 SAY ' ITEM SIN MOVIMIENTOS EN EL RANGO ESPECIFICADO!!!'
    @ 3,0
    WAIT ' SALDO CANT.='+TRANSFORM(CANT_ANT,'999,999.99')+' SALDO kg.'+TRANSFORM(KG_ANT,'999,999.99')+' Bs.'+TRANSFORM(BS_ANT,'999,999.99')
    RELEASE WINDOW MENSAJE
  ELSE
    IF K_OP=1
      IF TIPOR=1
        REPORT FORM V_KARDEX REST WHILE .NOT. EOF() .AND. LD_EMPR+LD_PART=EMPRESA+PARTE FOR LD_ALM=ALLTRIM(ALMACEN) .AND. BETWEEN(LD_FECHA,FECHAI,FECHAF)  TO FILE (MI_ARCH)
      ELSE
        REPORT FORM V_KAR_BS REST WHILE .NOT. EOF() .AND. LD_EMPR+LD_PART=EMPRESA+PARTE FOR LD_ALM=ALLTRIM(ALMACEN) .AND. BETWEEN(LD_FECHA,FECHAI,FECHAF)  TO FILE (MI_ARCH)
      ENDIF
    ELSE
      IF TIPOR=1
        REPORT FORM V_KAR_EX REST WHILE .NOT. EOF() .AND. LD_EMPR+LD_PART=EMPRESA+PARTE FOR LD_ALM=ALLTRIM(ALMACEN) .AND. BETWEEN(LD_FECHA,FECHAI,FECHAF) TO FILE (MI_ARCH)
      ELSE
        REPORT FORM V_KEX_BS REST WHILE .NOT. EOF() .AND. LD_EMPR+LD_PART=EMPRESA+PARTE FOR LD_ALM=ALLTRIM(ALMACEN) .AND. BETWEEN(LD_FECHA,FECHAI,FECHAF) TO FILE (MI_ARCH)
      ENDIF
    ENDIF
    RELEASE WINDOW MENSAJE
    IF OP=1
      DEFINE WINDOW KARDEX FROM 0,0 TO 24,79 DOUBLE TITLE 'KARDEX - [ESC] PARA SALIR'  
      MODI COMM (MI_ARCH) WINDOW KARDEX NOEDIT
      RELEASE WINDOW KARDEX
    ELSE
      ! COPY &MI_ARCH lpt1:
      WAIT "IMPRIMIENDO..." TIMEOUT 2
    ENDIF
	DELETE FILE (MI_ARCH)
  ENDIF
ENDIF
RETURN
