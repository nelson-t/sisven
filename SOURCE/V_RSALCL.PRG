SET EXCLU OFF
SET DELE ON
CLOSE DATA
CLEAR
SET TALK OFF

SELECT 1
USE V_REC_HD ORDER ESTADOS
SELECT 2
USE V_FAC_HD ORDER ESTADOS
SELECT 3
USE V_CLIENTES ORDER CODIGO

EMPRESA=' '
FECHAI={01/04/95}
FECHAF=DATE()
OPCION=1
MI_EMPRESA=SPACE(30)

DO V_RSALCL.SPR

IF LASTKEY()=27 .OR. OPCION=3
 CLOSE DATA
 CLEAR 
 RETURN
ENDIF


SELECT V_CLIENT
SET FILTER TO CL_EMPR=EMPRESA

LIST OFF FOR SALDO()<>0 FIELDS CL_COD_CL,CL_RAZON, SALDO() TO V_RSALCL.TXT

CLOSE ALL
RETURN




NRS=SYS(3)
NRS_REP='V:'+NRS+'.TXT' 

SELECT V_DOC_HD
SET FILTER TO HD_EMPR=EMPRESA .AND. .NOT. HD_ESTADO$'AF' .AND. HD_TIPO$'NR' .AND. BETWEEN(HD_FECHA,FECHAI,FECHAF) ;
              .AND. HD_COD_CL<>'000'

DO CASE
  CASE OPCION=1 .AND. LASTKEY()<>27
    REPORT FORM V_RNRS TO FILE (NRS_REP)
    DEFINE WINDOW VER_REP FROM 0,0 TO 24,79 DOUBLE TITLE '[ESC] - PARA SALIR'
    MODI COMM (NRS_REP) WINDOW VER_REP NOEDIT
    RELEASE WINDOW VER_REP    
  CASE OPCION=2 .AND. LASTKEY()<>27
    REPORT FORM V_RNRS TO FILE (NRS_REP)
    ! NPRINT &NRS_REP NB NFF Q=SERVER   
  CASE OPCION=3 .OR. LASTKEY()=27
ENDCASE
CLEAR
CLOSE DATA
DELETE FILE (NRS_REP)
RETURN

FUNCTION GET_EMPR
*****************
PARAMETER EMPR
SELECT 0
USE V_EMPR ORDER EMPR
SEEK EMPR
IF EOF()
  USE
  RETURN .F.
ELSE
  MI_EMPRESA=EM_DESCR
  @ 8,37 SAY MI_EMPRESA
  USE
  RETURN .T.
ENDIF


PROCEDURE SALDO
***************
SELECT V_CLIENT
IF CL_SALD_AN>0
  T_DEBE=CL_SALD_AN
  T_HABER=0
ELSE  
  T_DEBE=0
  T_HABER=ABS(CL_SALD_AN)
ENDIF

SELECT V_FAC_HD 
SET ORDER TO ESTADOS


SEEK V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL

DO WHILE .NOT. EOF() .AND. V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL=HF_EMPR+HF_COD_CL
  IF HF_ESTADO<>'A' .AND. HF_TIPO<>'O'
    DO CASE
      TDEBE=0
      THABER=0
      CASE HF_TIPO='O'  && FACTURA AL CONTADO
        TTIPO='F.CO.'
        TDEBE =hf_importe-HF_DSCTO_M-ROUND(hf_importe*(HF_DSCTO_P/100),2)+hf_fletes+hf_embala+hf_otros 
        THABER=hf_importe-HF_DSCTO_M-ROUND(hf_importe*(HF_DSCTO_P/100),2)+hf_fletes+hf_embala+hf_otros 
      CASE HF_TIPO='R'  && FACTURA AL CREDITO
        TTIPO='F.CR.'
        TDEBE=hf_importe-HF_DSCTO_M-ROUND(hf_importe*(HF_DSCTO_P/100),2)+hf_fletes+hf_embala+hf_otros 
        THABER=0 
      CASE HF_TIPO='X'  && NOTA DE CREDITO
        TTIPO='N.C.'
        TDEBE=0
        THABER=hf_importe
      CASE HF_TIPO='Y'  && NOTA DE DEBITO
        TTIPO='N.D.'
        TDEBE=HF_IMPORTE
        THABER=0
      CASE HF_TIPO='Z'  && COMUN. INTERNA
        TTIPO='C.I.'
        TDEBE=HF_IMPORTE
        THABER=0
    ENDCASE
    T_DEBE =T_DEBE +TDEBE
    T_HABER=T_HABER+THABER
  ENDIF
  SELECT V_FAC_HD 
  SKIP
ENDDO

SELECT V_REC_HD 
SET ORDER TO ESTADOS

SEEK V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL
DO WHILE .NOT. EOF() .AND. V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL=HR_EMPR+HR_COD_CL
  IF HR_ESTADO<>'A' 
    TDEBE=0
    THABER=HR_TOT_BS
    T_DEBE=T_DEBE+TDEBE
    T_HABER=T_HABER+THABER
  ENDIF
  SELECT V_REC_HD
  SKIP
ENDDO

SELECT V_CLIENT
RETURN T_DEBE-T_HABER