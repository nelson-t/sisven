******************
PROCEDURE V_LISCLI
******************
T_COUNT=0
SET EXCLU OFF
SET DELE ON
CLOSE DATA
CLEAR
SET TALK OFF
MONEDA=1

IF TYPE("EMPRESA")="U" OR TYPE("MI_EMPRESA")="U" OR TYPE("INI_GEST")="U"
  DO V_GETEMP
ENDIF

CLEAR

FECHAI	=INI_GEST
FECHAF	=DATE()
QUE_CODS=1
CODS_CL=SPACE(8)
CATEGO_CL=' '
OPCION=1
ORDEN=1

P_INICIAL = 0
P_CARGO = 0
P_ABONO = 0
P_SALDO = 0
TOT_DEUDORES = 0

DO V_LISCLI.SPR

IF OPCION=3 .OR. LASTKEY()=27
  CLEAR
  RETURN
ENDIF
CLEAR  

SELECT 0
USE V_TC ORDER FECHA
SEEK DTOS(INI_GEST)
IF .not. EOF()
  TC_INI=TC_MONTO
ELSE
  TC_INI=0
ENDIF
USE

SELECT 1
USE V_CLIENT ORDER CODIGO

DO CASE
  CASE QUE_CODS=1
    SET FILTER TO CL_EMPR=EMPRESA 
  CASE QUE_CODS=2
    SET FILTER TO CL_EMPR=EMPRESA .AND. CL_COD_CL<>ALLTRIM(CODS_CL)
  CASE QUE_CODS=3
    SET FILTER TO CL_EMPR=EMPRESA .AND. CL_COD_CL=ALLTRIM(CODS_CL)
  CASE QUE_CODS=4
    SET FILTER TO CL_EMPR=EMPRESA .AND. CL_CATEGO=ALLTRIM(CATEGO_CL)  
ENDCASE      
GO TOP

SELECT 2
USE V_FAC_HD ORDER ESTADOS
SET FILTER TO BETWEEN(HF_FECHA,INI_GEST,FECHAF)

SELECT 3
USE V_REC_HD ORDER ESTADOS
SET FILTER TO BETWEEN(HR_FECHA,INI_GEST,FECHAF)

MI_ARCH=SYS(3)

SELECT 4
USE V_SALCLI
COPY STRUC TO (MI_ARCH)
USE (MI_ARCH) ALIAS SALDOCLI

SELECT 5
USE V_DOC_HD ORDER ESTADOS
SET FILTER TO BETWEEN(HD_FECHA,INI_GEST,FECHAF)

SELECT 6
USE V_TC ORDER FECHA

SELECT V_FAC_HD
SET RELATION TO DTOS(HF_FECHA) INTO V_TC

SELECT V_DOC_HD
SET RELATION TO DTOS(HD_FECHA) INTO V_TC


SELECT V_CLIENT

***********

DO WHILE .NOT. EOF()

T_COUNT=T_COUNT+1

@ 12,5 SAY  'NRO DE CLIENTE PROCESADOS: '+TRANSFORM(T_COUNT,'999,999') COLOR B*/GR

DEBE =0  && CARGOS
ODEBE=0  && OTROS CARGOS
HABER=0  && ABONOS
OHABER=0 && OTROS ABONOS
SALDO=0

IDEBE =0
IHABER=0
IOHABER=0 && OTROS ABONOS INICIAL
IODEBE=0 && OTROS ABONOS INICIAL

ISALDO=0

SALD_INI=round( IIF(MONEDA=2, V_CLIENT.CL_SALD_AN+V_CLIENT.CL_DIF_AN, V_CLIENT.CL_SALD_AN) ;
         / IIF(MONEDA=2,TC_INI,1), 2) 

SELECT V_FAC_HD
SEEK V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL

DO WHILE .NOT. EOF() .AND. V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL=HF_EMPR+HF_COD_CL
  IF V_TC.TC_MONTO=0
    WAIT "TIPO DE CAMBIO PARA ESTA FECHA ES CERO O NO EXISTE:"+DTOC(HF_FECHA) WINDOW TIMEOUT 3
    DO SALIR
  ENDIF
  IF HF_ESTADO<>'A' .AND. HF_TIPO<>'O'
    DO CASE
      CASE HF_TIPO$'R'  && SOLO FACTURA AL CREDITO 
        IF BETWEEN(HF_FECHA,FECHAI,FECHAF)
          DEBE=DEBE+round((hf_importe-HF_DSCTO_M-ROUND(hf_importe*(HF_DSCTO_P/100),2)+hf_fletes+hf_embala+hf_otros)/IIF(MONEDA=2,HF_FACTOR,1),2)
        ELSE
          IDEBE=IDEBE+round((hf_importe-HF_DSCTO_M-ROUND(hf_importe*(HF_DSCTO_P/100),2)+hf_fletes+hf_embala+hf_otros)/IIF(MONEDA=2,HF_FACTOR,1),2)
        ENDIF
      CASE HF_TIPO='X'  && NOTA DE CREDITO
        IF BETWEEN(HF_FECHA,FECHAI,FECHAF)
          HABER=HABER+round(hf_importe/IIF(MONEDA=2,V_TC.TC_MONTO,1),2)
          OHABER=OHABER+round(hf_importe/IIF(MONEDA=2,V_TC.TC_MONTO,1),2)
        ELSE
          IHABER=IHABER+round(hf_importe/IIF(MONEDA=2,V_TC.TC_MONTO,1),2)
          IOHABER=IOHABER+round(hf_importe/IIF(MONEDA=2,V_TC.TC_MONTO,1),2)          
        ENDIF
      CASE HF_TIPO='Y'  && NOTA DE DEBITO
        IF BETWEEN(HF_FECHA,FECHAI,FECHAF)
          DEBE=DEBE+round(HF_IMPORTE/IIF(MONEDA=2,V_TC.TC_MONTO,1),2)
          ODEBE=ODEBE+round(HF_IMPORTE/IIF(MONEDA=2,V_TC.TC_MONTO,1),2)          
        ELSE
          IDEBE=IDEBE+round(HF_IMPORTE/IIF(MONEDA=2,V_TC.TC_MONTO,1),2)
          IODEBE=IODEBE+round(HF_IMPORTE/IIF(MONEDA=2,V_TC.TC_MONTO,1),2)                    
        ENDIF
      ENDCASE
  ENDIF
  SELECT V_FAC_HD 
  SKIP
ENDDO

SELECT V_REC_HD
SET RELATION TO DTOS(Hr_FECHA) INTO V_TC

SEEK V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL
DO WHILE .NOT. EOF() .AND. V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL=HR_EMPR+HR_COD_CL
  IF V_TC.TC_MONTO=0
    WAIT "TIPO DE CAMBIO PARA ESTA FECHA ES CERO O NO EXISTE:"+DTOC(HR_FECHA) WINDOW TIMEOUT 3
    DO SALIR
  ENDIF
  IF HR_ESTADO<>'A' 
    IF BETWEEN(HR_FECHA,FECHAI,FECHAF)
      HABER=HABER+round(HR_TOT_BS/IIF(MONEDA=2,V_TC.TC_MONTO,1),2)
    ELSE
      IHABER=IHABER+round(HR_TOT_BS/IIF(MONEDA=2,V_TC.TC_MONTO,1),2)
    ENDIF
  ENDIF
  SELECT V_REC_HD
  SKIP
ENDDO

*AQUI SON NR NO FACTURADAS

SELECT V_DOC_HD
SET RELATION TO DTOS(HD_FECHA) INTO V_TC

SEEK V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL
DO WHILE .NOT. EOF() .AND. V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL=HD_EMPR+HD_COD_CL
    IF V_TC.TC_MONTO=0
      WAIT "TIPO DE CAMBIO PARA ESTA FECHA ES CERO O NO EXISTE:"+DTOC(HD_FECHA) WINDOW TIMEOUT 3
      DO SALIR
    ENDIF

    IF (HD_ESTADO=' ' .AND. HD_TIPO='R')
        TIMPORTE=V_DOC_HD.hd_importe-ROUND((V_DOC_HD.hd_importe* V_DOC_HD.hd_dscto_p)/100,2)+ V_DOC_HD.hd_ped_fle+ V_DOC_HD.hd_ped_emb+ V_DOC_HD.hd_ped_otr
      
        IF BETWEEN(HD_FECHA,FECHAI,FECHAF)
          DEBE=DEBE+ROUND(TIMPORTE/IIF(MONEDA=1,1,V_TC.TC_MONTO),2)
          ODEBE=ODEBE+ROUND(TIMPORTE/IIF(MONEDA=1,1,V_TC.TC_MONTO),2)          
        ELSE
          IDEBE=IDEBE+ROUND(TIMPORTE/IIF(MONEDA=1,1,V_TC.TC_MONTO),2)
          IODEBE=IODEBE+ROUND(TIMPORTE/IIF(MONEDA=1,1,V_TC.TC_MONTO),2)                    
        ENDIF
    ENDIF
    SELECT V_DOC_HD
    SKIP
ENDDO

SET RELATION TO

SELECT SALDOCLI
  IF ((SALD_INI+IDEBE-IHABER)+DEBE+HABER+ODEBE+OHABER)<>0
    APPEND BLANK
    REPLACE EMPR WITH EMPRESA, ;
          COD_CL WITH V_CLIENT.CL_COD_CL, ;
          RAZON  WITH V_CLIENT.CL_RAZON, ;
          INICIAL WITH SALD_INI+IDEBE-IHABER, ;
          CARGO WITH DEBE, ;
          ABONO WITH HABER, ;
          OCARGO WITH ODEBE, ;
          OABONO WITH OHABER, ;
          SALDO WITH INICIAL+DEBE-HABER
    TOT_DEUDORES = TOT_DEUDORES+INICIAL+DEBE-HABER          
  ENDIF

  SELECT V_CLIENT
  SKIP
ENDDO

SELECT SALDOCLI 
IF ORDEN=1
  INDEX ON RAZON TO (MI_ARCH)
ELSE
  INDEX ON COD_CL TO (MI_ARCH)
ENDIF

REP_ARCH='..\TMP\'+SYS(3)+'.TXT'

DO CASE
  CASE OPCION=1 
    REPORT FORM V_LISCLI TO FILE (REP_ARCH)
    DEFINE WINDOW VER_REP FROM 0,0 TO 24,79 DOUBLE TITLE '[ESC] - PARA SALIR'
    MODI COMM (REP_ARCH) WINDOW VER_REP NOEDIT
    RELEASE WINDOW VER_REP    
  CASE OPCION=2 
    REPORT FORM V_LISCLI TO FILE (REP_ARCH)
    ! COPY &REP_ARCH lpt1:
ENDCASE
WAIT "PROCESO CONCLUIDO...SALIENDO." TIMEOUT 2
DELETE FILE (REP_ARCH)
DO SALIR
RETURN


PROCEDURE SALIR
***************
CLEAR
CLOSE DATA
DELETE FILE (MI_ARCH+'.DBF')
DELETE FILE (MI_ARCH+'.IDX')
RETURN TO MASTER

