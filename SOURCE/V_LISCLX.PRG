******************
PROCEDURE V_LISCLX
******************
T_COUNT=0
SET EXCLU OFF
SET DELE ON
CLOSE DATA
CLEAR
SET TALK OFF
MONEDA=1
MI_EMPRESA=SPACE(30)
CLEAR
EMPRESA='2'
INI_GEST={  /  /    }
FECHAI={  /  /    }
FECHAF=DATE()
QUE_CODS=1
CODS_CL=SPACE(8)
CATEGO_CL=' '
OPCION=1
ORDEN=1

P_INICIAL = 0
P_CARGO = 0
P_ABONO = 0
P_SALDO = 0
TOT_DEUDORES = 0

DO V_LISCLI.SPR

IF OPCION=3 .OR. LASTKEY()=27
  CLEAR
  RETURN
ENDIF
CLEAR  

SELECT 0
USE V_TC ORDER FECHA
SEEK DTOS(INI_GEST)
IF .not. EOF()
  TC_INI=TC_MONTO
ELSE
  TC_INI=0
ENDIF
USE

SELECT 1
USE V_CLIENT ORDER CODIGO
DO CASE
  CASE QUE_CODS=1
    SET FILTER TO CL_EMPR=EMPRESA .AND. CL_COD_CL<>'000000' .AND. CL_COD_CL<>'000201' .AND. CL_COD_CL<>'000202' .AND. CL_COD_CL<>'000203';
    .AND. CL_COD_CL<>'22'
  CASE QUE_CODS=2
    SET FILTER TO CL_EMPR=EMPRESA .AND. CL_COD_CL<>'000000' .AND. CL_COD_CL<>'000201'
  CASE QUE_CODS=3
    SET FILTER TO CL_EMPR=EMPRESA .AND. CL_COD_CL=ALLTRIM(CODS_CL)
  CASE QUE_CODS=4
    SET FILTER TO CL_EMPR=EMPRESA .AND. CL_CATEGO=ALLTRIM(CATEGO_CL)  
ENDCASE      
GO TOP

SELECT 2
USE V_FAC_HD ORDER ESTADOS
SET FILTER TO BETWEEN(HF_FECHA,INI_GEST,FECHAF)
go top

SELECT 3
USE V_REC_HD ORDER ESTADOS
SET FILTER TO BETWEEN(HR_FECHA,INI_GEST,FECHAF)
go top

MI_ARCH=SYS(3)

SELECT 4
USE V_SALCLI
COPY STRUC TO (MI_ARCH)
USE (MI_ARCH) ALIAS SALDOCLI

SELECT 5
USE V_TC ORDER FECHA

SELECT V_FAC_HD
SET RELATION TO DTOS(HF_FECHA) INTO V_TC


SELECT V_CLIENT

DO WHILE .NOT. EOF()

T_COUNT=T_COUNT+1

@ 12,5 SAY  'NRO DE CLIENTE PROCESADOS: '+TRANSFORM(T_COUNT,'999,999') COLOR B*/GR

DEBE =0
HABER=0
SALDO=0

IDEBE =0
IHABER=0
ISALDO=0

SELECT V_FAC_HD

SEEK V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL

DO WHILE .NOT. EOF() .AND. V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL=HF_EMPR+HF_COD_CL

  IF HF_ESTADO<>'A' 
    DO CASE
      CASE HF_TIPO$'R'  && SOLO FACTURA AL CREDITO 
        IF BETWEEN(HF_FECHA,FECHAI,FECHAF)
          DEBE=DEBE+(hf_importe-HF_DSCTO_M-ROUND(hf_importe*(HF_DSCTO_P/100),2)+hf_fletes+hf_embala+hf_otros)/IIF(MONEDA=2,HF_FACTOR,1)
        ELSE
          IDEBE=IDEBE+(hf_importe-HF_DSCTO_M-ROUND(hf_importe*(HF_DSCTO_P/100),2)+hf_fletes+hf_embala+hf_otros)/IIF(MONEDA=2,HF_FACTOR,1)
        ENDIF
      CASE HF_TIPO='X'  && NOTA DE CREDITO
        IF BETWEEN(HF_FECHA,FECHAI,FECHAF)
          HABER=HABER+hf_importe/IIF(MONEDA=2,V_TC.TC_MONTO,1)
        ELSE
          IHABER=IHABER+hf_importe/IIF(MONEDA=2,V_TC.TC_MONTO,1)
        ENDIF
      CASE HF_TIPO='Y'  && NOTA DE DEBITO
        IF BETWEEN(HF_FECHA,FECHAI,FECHAF)
          DEBE=DEBE+HF_IMPORTE/IIF(MONEDA=2,V_TC.TC_MONTO,1)
        ELSE
          IDEBE=IDEBE+HF_IMPORTE/IIF(MONEDA=2,V_TC.TC_MONTO,1)
        ENDIF
      CASE HF_TIPO='Z'  && COMUN. INTERNA
	      IF BETWEEN(HF_FECHA,FECHAI,FECHAF)
		      IF (HF_IMPORTE>0) THEN
        	 	  DO CASE
            		  CASE HF_MONEDA='D'
            		     DEBE=DEBE+HF_IMPORTE * HF_FACTOR
	            	  CASE (HF_MONEDA='A' OR HF_MONEDA='B')
    	        	     DEBE=DEBE+HF_IMPORTE
        	 	  ENDCASE
	           ELSE
        	      DO CASE
    	        	  CASE HF_MONEDA='D'
        	    	     HABER=HABER+ABS(HF_IMPORTE) * HF_FACTOR
            		  CASE (HF_MONEDA='A' OR HF_MONEDA='B')
            		     HABER=HABER+ABS(HF_IMPORTE)
	           	 ENDCASE
     		   ENDIF
     	   ELSE
     	   		brow
    			IF (HF_IMPORTE>0) THEN
         	    	DO CASE
						CASE HF_MONEDA='D'
            	    		IDEBE=IDEBE+HF_IMPORTE * HF_FACTOR
            	 		CASE (HF_MONEDA='A' OR HF_MONEDA='B')
            	    		IDEBE=IDEBE+HF_IMPORTE
            	 	ENDCASE
            	ELSE
         	    	DO CASE
            	 		CASE HF_MONEDA='D'
		            		IHABER=IHABER+ABS(HF_IMPORTE) * HF_FACTOR
        	    	 	CASE (HF_MONEDA='A' OR HF_MONEDA='B')
            	   			IHABER=IHABER+ABS(HF_IMPORTE)
            	 	ENDCASE
            	ENDIF            	
         	ENDIF     		
    ENDCASE
  ENDIF
  SELECT V_FAC_HD 
  SKIP
ENDDO

SELECT V_REC_HD
SET RELATION TO DTOS(Hr_FECHA) INTO V_TC

SEEK V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL
DO WHILE .NOT. EOF() .AND. V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL=HR_EMPR+HR_COD_CL
  IF HR_ESTADO<>'A' 
    IF BETWEEN(HR_FECHA,FECHAI,FECHAF)
      HABER=HABER+HR_TOT_BS/IIF(MONEDA=2,V_TC.TC_MONTO,1)
    ELSE
      IHABER=IHABER+HR_TOT_BS/IIF(MONEDA=2,V_TC.TC_MONTO,1)
    ENDIF
  ENDIF
  SELECT V_REC_HD
  SKIP
ENDDO

SELECT SALDOCLI

IF (V_CLIENT.CL_SALD_AN+DEBE+IDEBE+HABER+IHABER)<>0
  TOT_DEUDORES = TOT_DEUDORES+INICIAL+DEBE-HABER
  APPEND BLANK
  REPLACE EMPR WITH EMPRESA, ;
          COD_CL WITH V_CLIENT.CL_COD_CL, ;
          RAZON  WITH V_CLIENT.CL_RAZON, ;
          INICIAL WITH (IIF(MONEDA=2,V_CLIENT.CL_SALD_AN+V_CLIENT.CL_DIF_AN,V_CLIENT.CL_SALD_AN)/IIF(MONEDA=2,TC_INI,1))+IDEBE-IHABER, ;
          CARGO WITH DEBE, ;
          ABONO WITH HABER, ;
          SALDO WITH INICIAL+DEBE-HABER
ENDIF

IF (V_CLIENT.CL_COD_CL = '000204')
	P_INICIAL = INICIAL
	P_CARGO = DEBE
	P_ABONO = HABER
	P_SALDO = INICIAL+DEBE-HABER
ENDIF

SELECT V_CLIENT

SKIP
ENDDO

SELECT SALDOCLI 
IF ORDEN=1
  INDEX ON RAZON TO (MI_ARCH)
ELSE
  INDEX ON COD_CL TO (MI_ARCH)
ENDIF

REP_ARCH='V:'+SYS(3)+'.TXT'

DO CASE
  CASE OPCION=1 
    REPORT FORM V_LISCLI TO FILE (REP_ARCH)
    DEFINE WINDOW VER_REP FROM 0,0 TO 24,79 DOUBLE TITLE '[ESC] - PARA SALIR'
    MODI COMM (REP_ARCH) WINDOW VER_REP NOEDIT
    RELEASE WINDOW VER_REP    
  CASE OPCION=2 
    REPORT FORM V_LISCLI TO FILE (REP_ARCH)
    ! NPRINT &REP_ARCH NB NFF Q=SERVER
ENDCASE

CLEAR
CLOSE DATA
DELETE FILE (MI_ARCH+'.DBF')
DELETE FILE (MI_ARCH+'.IDX')
DELETE FILE (REP_ARCH)
RETURN 

FUNCTION GET_EMPR
*****************
PARAMETER EMPR
SELECT 0
USE V_EMPR ORDER EMPR
SEEK EMPR
IF EOF()
  USE
  RETURN .F.
ELSE
  *INI_GEST=EM_FECHA
  INI_GEST=CTOD('01/04/1998')
  FECHAI=INI_GEST
  MI_EMPRESA=EM_DESCR
  @ 8,37 SAY MI_EMPRESA
  @10,41 SAY INI_GEST
  USE
  RETURN .T.
ENDIF
