* PROGRAMA PARA CLASIFICACION ABC
* POR LINEA DE PRODUCTO DE ACUERDO A
* TOTAL COSTO DE ITEMS VENDIDOS,
* EL CRITERIO DE CLASIFICACION ES : RC*PESO

CLOSE DATA
IVA = 0.13   && VALOR DEL IVA PARA CALCULAR PRECIO NETO
SELECT 1
  USE V_ITEMS ORDER PART
SELECT 2
  CREATE TABLE TEMP_ABC (T_EMPR C(1), T_PART C(15), T_LINEA C(3), ;
               T_TKG N(14,2), T_TCANT N(14,2), T_TVN N(14,2), T_TCV N(14,2), T_RC N(6,4))
  SELECT V_ITEMS
  GO TOP
  DO WHILE .NOT. EOF()
     SELECT TEMP_ABC
     APPEND BLANK
     REPLACE T_EMPR WITH V_ITEMS.IT_EMPR, T_PART WITH V_ITEMS.IT_PART, ;
             T_LINEA WITH V_ITEMS.IT_LINEA
     SELECT V_ITEMS
     SKIP           
  ENDDO
  SELECT TEMP_ABC
  INDEX ON T_EMPR+T_PART TAG PART   
SELECT 3
  USE V_TC ORDER FECHA  
SELECT 5
  USE V_FAC_LN ORDER PART
  SET RELATION TO DTOS(LF_FECHA) INTO V_TC
  SET RELATION TO LF_EMPR+LF_PART INTO V_ITEMS ADDITIVE
GO TOP
SET FILTER TO LF_PESO<>0.AND.LF_ESTADO<>'A'
DO WHILE .NOT. EOF()
   SELECT TEMP_ABC
   SEEK V_FAC_LN.LF_EMPR+V_FAC_LN.LF_PART
   IF FOUND()
      IF V_ITEMS.IT_COSTO>0
         REPLACE T_TVN WITH T_TVN + (V_FAC_LN.LF_CANT * V_FAC_LN.LF_PRECIO - V_FAC_LN.LF_DESCTOS) * (1-IVA), ;
                 T_TKG WITH T_TKG + V_FAC_LN.LF_PESO, T_TCANT WITH T_TCANT + V_FAC_LN.LF_CANT, ;
                 T_TCV WITH T_TCV + (V_ITEMS.IT_COSTO * V_FAC_LN.LF_CANT * V_TC.TC_MONTO)                                               
      ENDIF        
   ENDIF   
   SELECT V_FAC_LN
   SKIP
ENDDO
SELECT TEMP_ABC
INDEX ON SUBSTR(T_LINEA,1,1)+STR(T_TKG*T_TCANT*((T_TVN-T_TCV)/T_TVN)) TAG TEMP_ABC DESCENDING
SET RELATION TO T_EMPR+T_PART INTO V_ITEMS
DO ABC WITH 'A'
DO ABC WITH 'C'
DO ABC WITH 'F'
DO ABC WITH 'P'
DO ABC WITH 'T'
DO ABC WITH 'O'
DO ABC WITH 'X'
DO ABC WITH 'V'
CLOSE DATA
DELETE FILE TEMP_ABC.DBF
DELETE FILE TEMP_ABC.CDX
RETURN

PROCEDURE ABC
*************
PARAMETERS LINEA
SELECT TEMP_ABC
SET FILTER TO T_LINEA = LINEA
SUM (T_TKG*T_TCANT*((T_TVN-T_TCV)/T_TVN)) TO TOTAL FOR T_LINEA=LINEA
GO TOP
ACUMULADO=0
DO WHILE .NOT. EOF()  
   PORCEN=ROUND(ACUMULADO/TOTAL*100,2)
   DO CASE
      CASE PORCEN<=80
        IF LOCK('V_ITEMS')
           REPLACE V_ITEMS.IT_ABC WITH  'A'
        ENDIF
      CASE PORCEN<=95
        IF LOCK('V_ITEMS')
           REPLACE V_ITEMS.IT_ABC WITH  'B'
        ENDIF   
      OTHERWISE
        IF LOCK('V_ITEMS')
           REPLACE V_ITEMS.IT_ABC WITH  'C'
        ENDIF
   ENDCASE  
   ACUMULADO=ACUMULADO+T_TKG*T_TCANT*((T_TVN-T_TCV)/T_TVN)
   SKIP
ENDDO
SET FILTER TO
GO TOP
RETURN
