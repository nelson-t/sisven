PROCEDURE V_MODDOC
******************
CLOSE ALL

SET EXCLU OFF
SET TALK OFF
SET DELE ON
SET DATE TO FRENCH

IF TYPE("EMPRESA")="U" OR TYPE("MI_EMPRESA")="U"
  DO V_GETEMP
ENDIF

IF TYPE("USER")="U" OR TYPE("MACHINE")="U"
  PUBLIC USER, MACHINE
  USER   =v_getuin("U") 
  MACHINE=v_getuin("M")
ENDIF

TTIPO="R"
TNRO=0
TNEWFECHA={  /  /    }
TNEWNRO=0
TDOSIF=0
TBORRA=.F.

OKCANCEL=1

DO V_MODDOC.SPR

IF LASTKEY()=27 OR OKCANCEL=2
  RETURN
ENDIF  

SET EXACT ON

TNRO   =strtran(str(TNRO,6),' ', '0')

IF TBORRA

  WAIT "ESTA SEGURO?? PRESIONE [ESC] PARA CANCELAR OPERACION" WINDOW
  IF LASTKEY()=27
    RETURN
  ENDIF  
  WAIT "BORRANDO EL DOCUMENTO..." WINDOW TIMEOUT 1

  DO CASE

    case Ttipo="R"  && NOTA DE REMISION
     SELECT 1
     USE V_DOC_HD EXCLUSIVE
     SELECT 2
     USE V_DOC_LN EXCLUSIVE

     SELECT V_DOC_HD
     LOCATE FOR HD_EMPR=EMPRESA AND HD_TIPO='R' AND HD_NRO=TNRO AND HD_ESTADO='A'
     IF EOF()
       WAIT 'NO SE ENCONTRO LA NR O NO ESTA ANULADA...' WINDOW 
     ELSE
       DELETE NEXT 1
       SELECT V_DOC_LN
       DELETE FOR LD_EMPR=EMPRESA AND LD_TIPO='R' AND LD_NRO=TNRO     
     ENDIF
     
    case Ttipo="F"  && FACTURA
     SELECT 1
     USE V_FAC_HD EXCLUSIVE
     SELECT 2
     USE V_FAC_LN EXCLUSIVE

     SELECT V_FAC_HD
     LOCATE FOR HF_EMPR=EMPRESA AND HF_TIPO$'OR' AND STR(HF_NDOSIF,4)=STR(TDOSIF,4) AND HF_NRO=TNRO AND HF_ESTADO='A'
     IF EOF()
       WAIT 'NO SE ENCONTRO LA FACTURA O NO ESTA ANULADA...' WINDOW 
     ELSE
       DELETE NEXT 1
       SELECT V_FAC_LN
       DELETE FOR LF_EMPR=EMPRESA AND LF_TIPO$'OR' AND STR(LF_NDOSIF,4)=STR(TDOSIF,4) AND LF_NRO=TNRO
     ENDIF

    case Ttipo="P"  && PEDIDO / COTIZACION
     SELECT 1
     USE V_PED_HD EXCLUSIVE
     SELECT 2
     USE V_PED_LN EXCLUSIVE

     SELECT V_PED_HD
     LOCATE FOR HP_EMPR=EMPRESA AND HP_NRO=TNRO AND HP_ESTADO='A'
     IF EOF()
       WAIT 'NO SE ENCONTRO PEDIDO O NO ESTA ANULADO...' WINDOW 
     ELSE
       DELETE NEXT 1
       SELECT V_PED_LN
       DELETE FOR LP_EMPR=EMPRESA AND LP_NRO=TNRO     
     ENDIF

    case Ttipo="X" OR Ttipo="Y"  
     SELECT 1
     USE V_FAC_HD EXCLUSIVE

     SELECT V_FAC_HD
     LOCATE FOR HF_EMPR=EMPRESA AND HF_TIPO=Ttipo AND HF_NRO=TNRO AND HF_ESTADO='A'

     IF EOF()
       WAIT 'NO SE ENCONTRO LA NOTA O NO ESTA ANULADA...' WINDOW 
     ELSE
       DELETE NEXT 1
     ENDIF

  ENDCASE

  CLOSE ALL
  RETURN
ENDIF 

TNEWNRO=strtran(str(TNEWNRO,6),' ', '0')

IF .not. V_Vnrdoc(EMPRESA, TTIPO, TNRO, TDOSIF)
 WAIT "DOCUMENTO ORIGEN NO EXISTE. NO SE PUEDE CONTINUAR " WINDOW
 RETURN
ENDIF

IF v_Vnrdoc(EMPRESA, TTIPO, TNEWNRO, TDOSIF)
 WAIT "EL DOCUMENTO NUEVO YA EXISTE. NO SE PUEDE CONTINUAR " WINDOW
 RETURN
ENDIF

WAIT "SE CAMBIARA DE "+TTIPO+'-'+TNRO+" A "+TTIPO+'-'+TNEWNRO+" "+DTOC(TNEWFECHA)+" [ESC] o [ENTER]" WINDOW
IF LASTKEY()=27
  RETURN
ENDIF  

WAIT "ESTA SEGURO?? PRESIONE [ESC] PARA CANCELAR OPERACION" WINDOW
IF LASTKEY()=27
  RETURN
ENDIF  

DO CASE
  case Ttipo="R"  && NOTA DE REMISION
     SELECT 1
     USE V_DOC_HD EXCLUSIVE
     SELECT 2
     USE V_DOC_LN EXCLUSIVE
     SELECT 3
     USE V_FAC_HD EXCLUSIVE

     SELECT 1
     IF TNEWFECHA<>{  /  /    }
        REPLACE HD_FECHA WITH TNEWFECHA FOR HD_EMPR=EMPRESA AND HD_TIPO='R' AND HD_NRO=TNRO 
     ENDIF

     IF TNEWNRO<>"000000"
        REPLACE HD_NRO WITH TNEWNRO FOR HD_EMPR=EMPRESA AND HD_TIPO='R' AND HD_NRO=TNRO 
        SELECT 3
        REPLACE HF_NR WITH TNEWNRO FOR HF_NR=TNRO
     ENDIF

     SELECT 2
     IF TNEWFECHA<>{  /  /    }
        REPLACE LD_FECHA WITH TNEWFECHA FOR LD_EMPR=EMPRESA AND LD_TIPO='R' AND LD_NRO=TNRO 
     ENDIF
     
     IF TNEWNRO<>"000000"
        REPLACE LD_NRO WITH TNEWNRO FOR LD_EMPR=EMPRESA AND LD_TIPO='R' AND LD_NRO=TNRO 
     ENDIF
     
  case Ttipo="F"  && FACTURA
     SELECT 1
     USE V_FAC_HD EXCLUSIVE
     SELECT 2
     USE V_FAC_LN EXCLUSIVE
     SELECT 3
     USE V_DOC_HD EXCLUSIVE

     SELECT 1
     IF TNEWFECHA<>{  /  /    }
        REPLACE HF_FECHA WITH TNEWFECHA, HF_FECHAV WITH TNEWFECHA ;
                FOR HF_EMPR=EMPRESA AND HF_TIPO$'OR' AND STR(HF_NDOSIF,4)=STR(TDOSIF,4) AND HF_NRO=TNRO 
     ENDIF

     IF TNEWNRO<>"000000"
        REPLACE HF_NRO WITH TNEWNRO ;
                FOR HF_EMPR=EMPRESA AND HF_TIPO$'OR' AND STR(HF_NDOSIF,4)=STR(TDOSIF,4) AND HF_NRO=TNRO 
        SELECT 3
        REPLACE HD_FACTURA WITH TNEWNRO FOR STR(HD_NDOSIF,4)=STR(TDOSIF,4) AND HD_FACTURA=TNRO
     ENDIF

     SELECT 2
     IF TNEWFECHA<>{  /  /    }
        REPLACE LF_FECHA WITH TNEWFECHA FOR LF_EMPR=EMPRESA AND LF_TIPO$'OR' AND STR(LF_NDOSIF,4)=STR(TDOSIF,4) AND LF_NRO=TNRO 
     ENDIF

     IF TNEWNRO<>"000000"
        REPLACE LF_NRO WITH TNEWNRO FOR LF_EMPR=EMPRESA AND LF_TIPO$'OR' AND STR(LF_NDOSIF,4)=STR(TDOSIF,4) AND LF_NRO=TNRO 
     ENDIF

  case Ttipo="P"  && PEDIDO / COTIZACION
     SELECT 1
     USE V_PED_HD EXCLUSIVE
     SELECT 2
     USE V_PED_LN EXCLUSIVE
     SELECT 3
     USE V_DOC_HD EXCLUSIVE
     SELECT 4
     USE V_FAC_HD EXCLUSIVE

     SELECT 1
     IF TNEWFECHA<>{  /  /    }
        REPLACE HP_FECHA WITH TNEWFECHA FOR HP_EMPR=EMPRESA AND HP_NRO=TNRO 
     ENDIF

     IF TNEWNRO<>"000000"
        REPLACE HP_NRO WITH TNEWNRO FOR HP_EMPR=EMPRESA AND HP_NRO=TNRO 
        SELECT 3
        REPLACE HD_PEDIDO WITH TNEWNRO FOR HD_PEDIDO=TNRO
        SELECT 4
        REPLACE HF_PEDIDO WITH TNEWNRO FOR HF_PEDIDO=TNRO
     ENDIF

     SELECT 2
     IF TNEWFECHA<>{  /  /    }
        REPLACE LP_FECHA WITH TNEWFECHA FOR LP_EMPR=EMPRESA AND LP_NRO=TNRO 
     ENDIF
     
     IF TNEWNRO<>"000000"
        REPLACE LP_NRO WITH TNEWNRO FOR LP_EMPR=EMPRESA AND LP_NRO=TNRO 
     ENDIF

  case Ttipo="X" OR Ttipo="Y"
     SELECT 1
     USE V_FAC_HD EXCLUSIVE

     SELECT 1
     IF TNEWFECHA<>{  /  /    }
        REPLACE HF_FECHA WITH TNEWFECHA, HF_FECHAV WITH TNEWFECHA ;
                FOR HF_EMPR=EMPRESA AND HF_TIPO=Ttipo AND HF_NRO=TNRO 
     ENDIF

     IF TNEWNRO<>"000000"
        REPLACE HF_NRO WITH TNEWNRO ;
                FOR HF_EMPR=EMPRESA AND HF_TIPO=Ttipo AND HF_NRO=TNRO 
     ENDIF

ENDCASE

CLOSE ALL
WAIT "PROCESO CONCLUIDO." WINDOW

RETURN