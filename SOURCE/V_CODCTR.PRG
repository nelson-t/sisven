FUNCTION V_CODCTR
*****************
PARAMETER NAUTORIZA, NFACTURA, NNIT, FECHAT, MONTOT, LLAVED

CODCTRL=""

ELMONTO=alltrim(str(round(MONTOT,0)))

tfac  =DOBLEVER(NFACTURA)
tnit  =DOBLEVER(NNIT)
tfecha=DOBLEVER(FECHAT)
tmonto=DOBLEVER(ELMONTO)

TOT1=val(tfac)+val(tnit)+val(tfecha)+val(tmonto)
TOT1=alltrim(STR(TOT1,100,0))
*? TOT1

PASO1=TOT1+V_VERHOE(TOT1)
PASO1=PASO1+V_VERHOE(PASO1)
PASO1=PASO1+V_VERHOE(PASO1)
PASO1=PASO1+V_VERHOE(PASO1)
PASO1=PASO1+V_VERHOE(PASO1)
PASO1=right(PASO1,5)

*? "PASO1=", PASO1

CADENA1=substr(LLAVED,1,val(substr(PASO1,1,1))+1)
CADENA2=substr(LLAVED,1+val(substr(PASO1,1,1))+1,val(substr(PASO1,2,1))+1)
CADENA3=substr(LLAVED,1+val(substr(PASO1,1,1))+1+val(substr(PASO1,2,1))+1,val(substr(PASO1,3,1))+1)
CADENA4=substr(LLAVED,1+val(substr(PASO1,1,1))+1+val(substr(PASO1,2,1))+1+val(substr(PASO1,3,1))+1,val(substr(PASO1,4,1))+1)
CADENA5=substr(LLAVED,1+val(substr(PASO1,1,1))+1+val(substr(PASO1,2,1))+1+val(substr(PASO1,3,1))+1+val(substr(PASO1,4,1))+1,val(substr(PASO1,5,1))+1)

*? CADENA1, CADENA2, CADENA3, CADENA4, CADENA5

CADENA1=NAUTORIZA+CADENA1
CADENA2=tfac+CADENA2
CADENA3=tnit+CADENA3
CADENA4=tfecha+CADENA4
CADENA5=tmonto+CADENA5

*? "CADENAS=", CADENA1, CADENA2, CADENA3, CADENA4, CADENA5

PASO3=(CADENA1+CADENA2+CADENA3+CADENA4+CADENA5)
PASO3=UPPER(V_ALLEGD(PASO3, LLAVED+PASO1))

*? "PASO3=", PASO3

STORE 0 to ST, SP1, SP2, SP3, SP4, SP5

FOR I=1 to len(paso3)
  ST=ST+ASC(SUBSTR(PASO3,I,1))
  SP1=SP1+IIF(MOD(I,5)=1,ASC(SUBSTR(PASO3,I,1)),0)
  SP2=SP2+IIF(MOD(I,5)=2,ASC(SUBSTR(PASO3,I,1)),0)
  SP3=SP3+IIF(MOD(I,5)=3,ASC(SUBSTR(PASO3,I,1)),0)
  SP4=SP4+IIF(MOD(I,5)=4,ASC(SUBSTR(PASO3,I,1)),0)
  SP5=SP5+IIF(MOD(I,5)=0,ASC(SUBSTR(PASO3,I,1)),0)
ENDFOR

*? "ST,SP1,...", ST, SP1, SP2, SP3, SP4, SP5

TOT2=     INT((ST*SP1)/(val(substr(PASO1,1,1))+1))
TOT2=TOT2+INT((ST*SP2)/(val(substr(PASO1,2,1))+1))
TOT2=TOT2+INT((ST*SP3)/(val(substr(PASO1,3,1))+1))
TOT2=TOT2+INT((ST*SP4)/(val(substr(PASO1,4,1))+1))
TOT2=TOT2+INT((ST*SP5)/(val(substr(PASO1,5,1))+1))

*? "TOT2",TOT2

TOT3=V_BASE64(TOT2)

*? "TOT3", TOT3

COD1=UPPER(V_ALLEGD(TOT3,LLAVED+PASO1))

*?? " COD1=", COD1

CODCTRL=SUBSTR(COD1,1,2)
FOR I=3 TO LEN(COD1)-1 STEP 2
  CODCTRL=CODCTRL+"-"+SUBSTR(COD1,I,2)   
ENDFOR

*?CODCTRL

RETURN CODCTRL

FUNCTION DOBLEVER
******************
PARAMETER ST
DOBLEV=ST+V_VERHOE(ST)
DOBLEV=DOBLEV+V_VERHOE(DOBLEV)
RETURN DOBLEV
