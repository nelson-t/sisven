SET EXCLU OFF
SET DELE ON
SET DATE FRENCH
CLOSE DATA
CLEAR
SET TALK OFF

IF TYPE("EMPRESA")="U" OR TYPE("MI_EMPRESA")="U" OR TYPE("INI_GEST")="U"
  DO V_GETEMP
ENDIF

FECHAI=INI_GEST
FECHAF=DATE()
INDICEF=00

RESPON='   '
ORDEN=1
SALDOS=1
CONCOSTO=2
MONEDA=1
REPRO=1
MAYOR_A=0
MENOR_A=0
QUE_CODS=1
CODS_CL=SPACE(8)
CATEGO=' '
OPCION=1
MENOR=0
EN_COBRA=0
INFO=0

DO V_RDEUDA.SPR

IF LASTKEY()=27 .OR. OPCION=3
 CLOSE DATA
 CLEAR 
 RETURN
ENDIF

IF REPRO=1
  DO CALC_DEU
ENDIF

NOMBRE=SYS(3)
NOMB_REP='..\TMP\'+NOMBRE+'.TXT' 
NOMB_IDX='..\TMP\'+NOMBRE+'.IDX'

SELECT 1
USE V_CLIENT

DO CASE
  CASE ORDEN=1  && Ordenado por saldos
    if moneda=1
      INDEX ON 10000000-CL_SALD_AC TO (NOMB_IDX)
    else
      INDEX ON 10000000-CL_SALD_US TO (NOMB_IDX)
    endif
  CASE ORDEN=2  && Ordenado por c¢digo de clientes
    SET ORDER TO CODIGO
  CASE ORDEN=3  && Ordenado por raz¢n social de clientes
    INDEX ON CL_RAZON TO (NOMB_IDX)
ENDCASE

DO CASE   && Reportes solamente por c¢digos seleccionados
  CASE QUE_CODS=1
    WCOND="CL_EMPR=EMPRESA"
  CASE QUE_CODS=2
    WCOND="CL_EMPR=EMPRESA .AND. CL_COD_CL<>ALLTRIM(CODS_CL)"
  CASE QUE_CODS=3
    WCOND="CL_EMPR=EMPRESA .AND. CL_COD_CL=ALLTRIM(CODS_CL)"
ENDCASE      

IF EN_COBRA=1
  WCOND=WCOND + " .AND. CL_COBRA='S'"
ENDIF

DO CASE && Rep. por tipo de saldos Ej. <> 0 , > 0, etc.
  CASE SALDOS=1
    IF MONEDA=1
      SET FILTER TO EVAL(WCOND) .AND. CL_COD_RES=ALLTRIM(RESPON) .AND. CL_CATEGO=ALLTRIM(CATEGO) .AND. CL_SALD_AC<>0 .AND. IIF(MENOR=1,CL_SALD_AC<=MENOR_A,.T.)
    ELSE
      SET FILTER TO EVAL(WCOND) .AND. CL_COD_RES=ALLTRIM(RESPON) .AND. CL_CATEGO=ALLTRIM(CATEGO) .AND. CL_SALD_US<>0 .AND. IIF(MENOR=1,CL_SALD_US<=MENOR_A,.T.)
    ENDIF
  CASE SALDOS=2
    IF MONEDA=1
      SET FILTER TO EVAL(WCOND) .AND. CL_COD_RES=ALLTRIM(RESPON) .AND. CL_CATEGO=ALLTRIM(CATEGO) .AND. CL_SALD_AC>0 .AND. IIF(MENOR=1,CL_SALD_AC<=MENOR_A,.T.)
    ELSE
      SET FILTER TO EVAL(WCOND) .AND. CL_COD_RES=ALLTRIM(RESPON) .AND. CL_CATEGO=ALLTRIM(CATEGO) .AND. CL_SALD_US>0 .AND. IIF(MENOR=1,CL_SALD_US<=MENOR_A,.T.)
    ENDIF
  CASE SALDOS=3
    IF MONEDA=1
      SET FILTER TO EVAL(WCOND) .AND. CL_COD_RES=ALLTRIM(RESPON) .AND. CL_CATEGO=ALLTRIM(CATEGO) .AND. CL_SALD_AC<0 .AND. IIF(MENOR=1,CL_SALD_AC<=MENOR_A,.T.)
    ELSE
      SET FILTER TO EVAL(WCOND) .AND. CL_COD_RES=ALLTRIM(RESPON) .AND. CL_CATEGO=ALLTRIM(CATEGO) .AND. CL_SALD_US<0 .AND. IIF(MENOR=1,CL_SALD_US<=MENOR_A,.T.)
    ENDIF
  CASE SALDOS=4
    IF MONEDA=1
      SET FILTER TO EVAL(WCOND) .AND. CL_COD_RES=ALLTRIM(RESPON) .AND. CL_CATEGO=ALLTRIM(CATEGO) .AND. CL_SALD_AC>MAYOR_A .AND. IIF(MENOR=1,CL_SALD_AC<=MENOR_A,.T.)
    ELSE
      SET FILTER TO EVAL(WCOND) .AND. CL_COD_RES=ALLTRIM(RESPON) .AND. CL_CATEGO=ALLTRIM(CATEGO) .AND. CL_SALD_US>MAYOR_A .AND. IIF(MENOR=1,CL_SALD_US<=MENOR_A,.T.)
    ENDIF
ENDCASE  
GO TOP

DO CASE
  CASE OPCION=1 .AND. LASTKEY()<>27    && Si reporte es a pantalla
    IF CONCOSTO=1
      REPORT FORM V_RDEUDA TO FILE (NOMB_REP)
    ELSE
      IF INFO=0
        REPORT FORM V_RDEUDO TO FILE (NOMB_REP)
      ELSE
        REPORT FORM V_RDEUDI TO FILE (NOMB_REP)      
      ENDIF
    ENDIF
    DEFINE WINDOW VER_REP FROM 0,0 TO 24,79 DOUBLE TITLE '[ESC] - PARA SALIR'
    MODI COMM (NOMB_REP) WINDOW VER_REP NOEDIT
    RELEASE WINDOW VER_REP    
  CASE OPCION=2 .AND. LASTKEY()<>27  && Reporte a impresora
    IF CONCOSTO=1
      REPORT FORM V_RDEUDA TO (NOMB_REP)
    ELSE
      IF INFO=0
        REPORT FORM V_RDEUDO TO (NOMB_REP)
      ELSE
        REPORT FORM V_RDEUDI TO (NOMB_REP)
      ENDIF
    ENDIF
    ! COPY &NOMB_REP LPT1:
  CASE OPCION=3 .OR. LASTKEY()=27
ENDCASE
CLEAR

CLOSE DATA
DELETE FILE (NOMB_IDX)
DELETE FILE (NOMB_REP)

RETURN

PROCEDURE CALC_DEU
******************
CLOSE DATA
CLEAR
SET SAFETY OFF

SELECT 0
USE V_TC ORDER FECHA
SEEK DTOS(INI_GEST)
IF !EOF()
  TC_INI=TC_MONTO
ELSE
  TC_INI=0
ENDIF
USE

INDICEF=INDICEF/100/360

SELECT 1
USE V_FAC_HD ORDER ESTADOS
SET FILTER TO BETWEEN(HF_FECHA,FECHAI,FECHAF)

SELECT 2
USE V_REC_HD ORDER ESTADOS
SET FILTER TO BETWEEN(HR_FECHA,FECHAI,FECHAF)

SELECT 3
USE V_CLIENT ORDER  CODIGO

SELECT 4
USE V_DOC_HD ORDER ESTADOS
SET FILTER TO BETWEEN(HD_FECHA,FECHAI,FECHAF)

SELECT V_CLIENT
DO CASE
  CASE QUE_CODS=1
    SET FILTER TO CL_EMPR=EMPRESA 
  CASE QUE_CODS=2
    SET FILTER TO CL_EMPR=EMPRESA .AND. CL_COD_C<>ALLTRIM(CODS_CL)
  CASE QUE_CODS=3
    SET FILTER TO CL_EMPR=EMPRESA .AND. CL_COD_CL=ALLTRIM(CODS_CL)
ENDCASE      
GO TOP

SELECT 5
USE V_TC ORDER FECHA

EST_ARCH='..\TMP\'+SYS(3)

SELECT 0
USE V_ESTCLI
COPY STRUC TO (EST_ARCH) WITH CDX
USE

SELECT 0
USE (EST_ARCH) ORDER FECHA ALIAS ESTADOS exclusive

SELECT V_CLIENT

DO WHILE .NOT. EOF()

  CODIGO=CL_COD_CL
  RAZON =CL_RAZON
  IF MONEDA=1
    SALD_INI=CL_SALD_AN
    Q_MONEDA = 'B'
  ELSE
    SALD_INI=CL_SALD_AN+CL_DIF_AN
    Q_MONEDA = 'D'
  ENDIF
  SELECT ESTADOS
  ZAP
  
  APPEND BLANK
  IF LOCK()
    REPLACE OBS   WITH 'SALDO INICIO DE GESTION'
    REPLACE FECHA WITH INI_GEST
    REPLACE DEBE  WITH IIF(SALD_INI>=0,SALD_INI,0)
    REPLACE HABER WITH IIF(SALD_INI<0 ,ABS(SALD_INI),0)
    REPLACE TC    WITH TC_INI

  ENDIF          

  SELECT V_FAC_HD
  SET RELATION TO DTOS(HF_FECHA) INTO V_TC

  SEEK V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL

  DO WHILE .NOT. EOF() .AND. V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL=HF_EMPR+HF_COD_CL
    IF HF_ESTADO<>'A' .AND. HF_TIPO<>'O'
       DO CASE
       CASE HF_TIPO='R'  && FACTURA AL CREDITO
          TTIPO='F.CR.'
          TDEBE=hf_importe-HF_DSCTO_M-ROUND(hf_importe*(HF_DSCTO_P/100),2)+hf_fletes+hf_embala+hf_otros 
          THABER=0 
       CASE HF_TIPO='X'  && NOTA DE CREDITO
          TTIPO='N.C.'
          TDEBE=0
          THABER=hf_importe
       CASE HF_TIPO='Y'  && NOTA DE DEBITO
          TTIPO='N.D.'
          TDEBE=HF_IMPORTE
          THABER=0
     	ENDCASE

      SELECT ESTADOS
      APPEND BLANK
      IF LOCK()
        REPLACE TIPO WITH TTIPO
        REPLACE OBS WITH V_FAC_HD.HF_OBS
        REPLACE FECHA WITH V_FAC_HD.HF_FECHA
        REPLACE NRO WITH V_FAC_HD.HF_NRO
        REPLACE DEBE WITH TDEBE
        REPLACE HABER WITH THABER
        IF V_FAC_HD.HF_TIPO='R'
          REPLACE TC WITH V_FAC_HD.HF_FACTOR
        ELSE
          REPLACE TC WITH V_TC.TC_MONTO
        ENDIF
      ENDIF          
    ENDIF
    SELECT V_FAC_HD 
    SKIP
  ENDDO

  SELECT V_REC_HD
  SET RELATION TO DTOS(HR_FECHA) INTO V_TC
  
  SEEK V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL
  DO WHILE .NOT. EOF() .AND. V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL=HR_EMPR+HR_COD_CL
    IF HR_ESTADO<>'A' 
      TDEBE=0
      THABER=HR_TOT_BS
      SELECT ESTADOS
      APPEND BLANK
      IF LOCK()
        REPLACE TIPO  WITH 'RCBO.'
        REPLACE OBS   WITH 'ABONO A SU CUENTA'
        REPLACE FECHA WITH V_REC_HD.HR_FECHA
        REPLACE NRO   WITH V_REC_HD.HR_NRO
        REPLACE DEBE  WITH TDEBE
        REPLACE HABER WITH THABER
        REPLACE TC    WITH V_TC.TC_MONTO
      ENDIF          
    ENDIF
    SELECT V_REC_HD
    SKIP
  ENDDO
  SET RELATION TO
  
  SELECT V_DOC_HD
  SET RELATION TO DTOS(HD_FECHA) INTO V_TC

  SEEK V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL
  DO WHILE .NOT. EOF() .AND. V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL=HD_EMPR+HD_COD_CL
    IF (HD_ESTADO=' ' .AND. HD_TIPO='R')
      *AQUI SON NR NO FACTURADAS
    	SELECT ESTADOS
    	APPEND BLANK
    	IF LOCK()
      		REPLACE TIPO  WITH "NR." 
      		REPLACE OBS   WITH V_DOC_HD.HD_OBS
      		REPLACE FECHA WITH V_DOC_HD.HD_FECHA
      		REPLACE NRO   WITH V_DOC_HD.HD_NRO
      		REPLACE DEBE  WITH V_DOC_HD.hd_importe-ROUND((V_DOC_HD.hd_importe* V_DOC_HD.hd_dscto_p)/100,2)+ V_DOC_HD.hd_ped_fle+ V_DOC_HD.hd_ped_emb+ V_DOC_HD.hd_ped_otr
       		REPLACE TC WITH V_TC.TC_MONTO
    	ENDIF
    SELECT V_DOC_HD
    ENDIF
    SKIP
  ENDDO

  SET RELATION TO
  
  T_DB=0
  T_HB=0

  FINANC=0
  P_FINAN=0

  T_DBU=0
  T_HBU=0

  FINANCU=0
  P_FINANU=0

  FECHA1=INI_GEST

  DEUD_0  =0
  DEUD_30 =0
  DEUD_60 =0
  DEUD_90 =0
  DEUD_120=0

  DEUD_0U  =0
  DEUD_30U =0
  DEUD_60U =0
  DEUD_90U =0
  DEUD_120U=0

  SELECT ESTADOS
  GO TOP

  DO WHILE .NOT. EOF()
    T_DB=T_DB+DEBE
    T_HB=T_HB+HABER
    T_SALDO=T_DB-T_HB

    T_DBU=T_DBU+round(DEBE/TC,2)
    T_HBU=T_HBU+round(HABER/TC,2)
    T_SALDOU=T_DBU-T_HBU

    IF LOCK()
      REPLACE SALDO WITH T_SALDO
      REPLACE SALDOU WITH T_SALDOU
    ENDIF

    FINANC=FINANC+(P_FINAN*(FECHA-FECHA1)*INDICEF)
    FINANCU=FINANCU+(P_FINANU*(FECHA-FECHA1)*INDICEF)

    P_FINAN=T_SALDO
    P_FINANU=T_SALDOU
    
    FECHA1=FECHA
    IF DEBE<>0 .AND. DEBE<>HABER
        DO CASE
          CASE FECHAF-FECHA <=30 
              DEUD_0  =DEUD_0+DEBE
              DEUD_0U  =DEUD_0U+round(DEBE/TC,2)
          CASE FECHAF-FECHA <=60 
              DEUD_30 =DEUD_30+DEBE
              DEUD_30U =DEUD_30U+round(DEBE/TC,2)
          CASE FECHAF-FECHA <=90 
              DEUD_60 =DEUD_60+DEBE
              DEUD_60U =DEUD_60U+round(DEBE/TC,2)
          CASE FECHAF-FECHA <=120 
              DEUD_90 =DEUD_90+DEBE
              DEUD_90U =DEUD_90U+round(DEBE/TC,2)
          CASE FECHAF-FECHA >120 
              DEUD_120=DEUD_120+DEBE
              DEUD_120U=DEUD_120U+round(DEBE/TC,2)
        ENDCASE
    ENDIF

    SKIP
  ENDDO

  FINANC=FINANC+(P_FINAN*(FECHAF-FECHA1)*INDICEF)
  FINANCU=FINANCU+(P_FINANU*(FECHAF-FECHA1)*INDICEF)

  MI_HABER=0
  MI_HABERU=0
    
  GO TOP

  DO WHILE .NOT. EOF()
      IF HABER<>0 .AND. HABER<>DEBE

        MI_HABER=MI_HABER+HABER
        IF DEUD_120>0 .AND. MI_HABER>0
           IF DEUD_120>=MI_HABER
             DEUD_120=DEUD_120-MI_HABER
             MI_HABER=0
           ELSE
             MI_HABER=MI_HABER-DEUD_120
             DEUD_120=0
           ENDIF
        ENDIF

        MI_HABERU=MI_HABERU+round(HABER/TC,2)

        IF DEUD_120U>0 .AND. MI_HABERU>0
           IF DEUD_120U>=MI_HABERU
             DEUD_120U=DEUD_120U-MI_HABERU
             MI_HABERU=0
           ELSE
             MI_HABERU=MI_HABERU-DEUD_120U
             DEUD_120U=0
           ENDIF
        ENDIF

        IF DEUD_90>0 .AND. MI_HABER>0
           IF DEUD_90>=MI_HABER
             DEUD_90=DEUD_90-MI_HABER
             MI_HABER=0
           ELSE
             MI_HABER=MI_HABER-DEUD_90
             DEUD_90=0
           ENDIF
        ENDIF

        IF DEUD_90U>0 .AND. MI_HABERU>0
           IF DEUD_90U>=MI_HABERU
             DEUD_90U=DEUD_90U-MI_HABERU
             MI_HABERU=0
           ELSE
             MI_HABERU=MI_HABERU-DEUD_90U
             DEUD_90U=0
           ENDIF
        ENDIF

        IF DEUD_60>0 .AND. MI_HABER>0
           IF DEUD_60>=MI_HABER
             DEUD_60=DEUD_60-MI_HABER
             MI_HABER=0
           ELSE
             MI_HABER=MI_HABER-DEUD_60
             DEUD_60=0
           ENDIF
        ENDIF

        IF DEUD_60U>0 .AND. MI_HABERU>0
           IF DEUD_60U>=MI_HABERU
             DEUD_60U=DEUD_60U-MI_HABERU
             MI_HABERU=0
           ELSE
             MI_HABERU=MI_HABERU-DEUD_60U
             DEUD_60U=0
           ENDIF
        ENDIF

        IF DEUD_30>0 .AND. MI_HABER>0
           IF DEUD_30>=MI_HABER
             DEUD_30=DEUD_30-MI_HABER
             MI_HABER=0
           ELSE
             MI_HABER=MI_HABER-DEUD_30
             DEUD_30=0
           ENDIF
        ENDIF
        IF DEUD_30U>0 .AND. MI_HABERU>0
           IF DEUD_30U>=MI_HABERU
             DEUD_30U=DEUD_30U-MI_HABERU
             MI_HABERU=0
           ELSE
             MI_HABERU=MI_HABERU-DEUD_30U
             DEUD_30U=0
           ENDIF
        ENDIF

        IF DEUD_0>0 .AND. MI_HABER>0
           IF DEUD_0>=MI_HABER
             DEUD_0=DEUD_0-MI_HABER
             MI_HABER=0
           ELSE
             MI_HABER=MI_HABER-DEUD_0
             DEUD_0=0
           ENDIF
        ENDIF
        IF DEUD_0U>0 .AND. MI_HABERU>0
           IF DEUD_0U>=MI_HABERU
             DEUD_0U=DEUD_0U-MI_HABERU
             MI_HABERU=0
           ELSE
             MI_HABERU=MI_HABERU-DEUD_0U
             DEUD_0U=0
           ENDIF
        ENDIF

        IF DEUD_0+DEUD_30+DEUD_60+DEUD_90+DEUD_120<=0 .AND. MI_HABER>0
          DO CASE
            CASE FECHAF-FECHA <=30 
                DEUD_0  =DEUD_0-MI_HABER
            CASE FECHAF-FECHA <=60 
                DEUD_30 =DEUD_30-MI_HABER
            CASE FECHAF-FECHA <=90 
                DEUD_60 =DEUD_60-MI_HABER
            CASE FECHAF-FECHA <=120 
                DEUD_90 =DEUD_90-MI_HABER
            CASE FECHAF-FECHA >120 
                DEUD_120=DEUD_120-MI_HABER
          ENDCASE
          MI_HABER=0 
        ENDIF  
        IF DEUD_0U+DEUD_30U+DEUD_60U+DEUD_90U+DEUD_120U<=0 .AND. MI_HABERU>0
          DO CASE
            CASE FECHAF-FECHA <=30 
                DEUD_0U  =DEUD_0U-MI_HABERU
            CASE FECHAF-FECHA <=60 
                DEUD_30U =DEUD_30U-MI_HABERU
            CASE FECHAF-FECHA <=90 
                DEUD_60U =DEUD_60U-MI_HABERU
            CASE FECHAF-FECHA <=120 
                DEUD_90U =DEUD_90U-MI_HABERU
            CASE FECHAF-FECHA >120 
                DEUD_120U=DEUD_120U-MI_HABERU
          ENDCASE
          MI_HABERU=0 
        ENDIF  
      ENDIF
      SKIP
    ENDDO

*********** ACTUALIZACION DE TABLA DE CLIENTES ***************

  SELECT V_CLIENT 
  IF LOCK()
    REPLACE CL_SALD_DB WITH T_DB, CL_SALD_HB WITH T_HB
    REPLACE CL_0 WITH DEUD_0, CL_30 WITH DEUD_30, CL_60 WITH DEUD_60, CL_90 WITH DEUD_90, CL_120 WITH DEUD_120
    REPLACE CL_FINANC WITH FINANC

    REPLACE CL_0U WITH DEUD_0U, CL_30U WITH DEUD_30U, CL_60U WITH DEUD_60U, CL_90U WITH DEUD_90U, CL_120U WITH DEUD_120U
    REPLACE CL_FINANCU WITH FINANCU    
   	REPLACE CL_SALD_AC WITH T_SALDO
    REPLACE CL_SALD_US WITH T_SALDOU
  ENDIF
  
  IF CL_SALD_AC<>0
    @  7,5 SAY 'CLIENTE: '+CL_COD_CL+'-  '+CL_RAZON+'  SALDO'+TRANSFORM(CL_SALD_AC,'99,999,999.99') COLOR B*/GR
    @  8,5 SAY 'DEUDA  1-30  dias:'+TRANSFORM(CL_0,'9,999,999.99')
    @  9,5 SAY 'DEUDA 31-60  dias:'+TRANSFORM(CL_30,'9,999,999.99')
    @ 10,5 SAY 'DEUDA 61-90  dias:'+TRANSFORM(CL_60,'9,999,999.99')
    @ 11,5 SAY 'DEUDA 91-120 dias:'+TRANSFORM(CL_90,'9,999,999.99')
    @ 12,5 SAY 'DEUDA 121 o mas  :'+TRANSFORM(CL_120,'9,999,999.99')+'  TOTAL DEUDA: '+TRANSFORM(CL_0+CL_30+CL_60+CL_90+CL_120,'99,999,999.99')+IIF(CL_0+CL_30+CL_60+CL_90+CL_120<>CL_SALD_AC,' ####','')
    @ 13,25 SAY 'COSTO FINANCIERO= '+TRANSFORM(FINANC,'9,999,999.99') COLOR R/GR*
  ENDIF
  ***************************************************************
  SELECT V_CLIENT
  SKIP
ENDDO

SELECT ESTADOS
USE
WAIT "PROCESO CONCLUIDO...SALIENDO." TIMEOUT 2

DELETE FILE (EST_ARCH+'.DBF') 
DELETE FILE (EST_ARCH+'.CDX') 

CLOSE DATA
CLEAR
RETURN
