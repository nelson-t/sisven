SET DECIMALS TO 5
SET DELE ON
SET EXCLU OFF
SET DATE TO DMY
SET TALK OFF

EMPRESA='1'

SELECT 1
USE V_ITEMS ORDER PART

SELECT 2
USE V_DOC_LN ORDER KARDEX
SET RELATION TO LD_EMPR+LD_PART INTO V_ITEMS

SELECT 3
USE V_ALM ORDER ALM

MI_ARCH='C:\'+SYS(3)


SELECT 4
USE V_ITSALD ORDER PART
COPY STRUC TO (MI_ARCH) WITH CDX
USE (MI_ARCH) ORDER PART ALIAS SALDOS

T_PART=SPACE(15)
T_ALM =SPACE(2)

SELECT V_DOC_LN
SEEK EMPRESA
DO WHILE .NOT. EOF() .AND. LD_EMPR=EMPRESA
  IF LD_PART<>T_PART
    IF LOCK('V_ITEMS')
      REPLACE V_ITEMS.IT_INGRESO WITH 0, V_ITEMS.IT_KG_ING WITH 0 ,V_ITEMS.IT_PESO_R WITH 0 
    ENDIF
    DO MAS_ITSAL WITH LD_EMPR,LD_PART  
    SELECT V_DOC_LN
    T_PART=LD_PART
  ENDIF
  SELECT V_DOC_LN   
  SKIP
ENDDO

SELECT V_DOC_LN
SET RELATION TO LD_EMPR+LD_ALM+LD_PART INTO SALDOS ADDITIVE

SEEK EMPRESA
DO WHILE .NOT. EOF() .AND. LD_EMPR=EMPRESA
  IF LD_TIPO='I'.AND. LD_PESO<>0
    IF LOCK('V_ITEMS')
      REPLACE V_ITEMS.IT_INGRESO  WITH V_ITEMS.IT_INGRESO+LD_CANT, ;
              V_ITEMS.IT_KG_ING   WITH V_ITEMS.IT_KG_ING +LD_PESO, ;
              V_ITEMS.IT_PESO_R   WITH V_ITEMS.IT_KG_ING/V_ITEMS.IT_INGRESO
    ENDIF
  ENDIF
  DO CASE 
    CASE LD_INSAL='1' .AND. LD_CANT<>0
     IF LD_PESO=0
       IF V_ITEMS.IT_PESO_R<>0 
         KG_UNI=V_ITEMS.IT_PESO_R
       ELSE
         KG_UNI=V_ITEMS.IT_PESO_T
       ENDIF
       REPLACE SALDOS.IT_INGK  WITH SALDOS.IT_INGK+(LD_CANT*KG_UNI)
       REPLACE SALDOS.IT_ING   WITH SALDOS.IT_ING +LD_CANT
       REPLACE SALDOS.IT_CANTK WITH SALDOS.IT_CANTK+(LD_CANT*KG_UNI)
       REPLACE SALDOS.IT_CANT  WITH SALDOS.IT_CANT +LD_CANT
       CLEAR
       SI_NO='N'
       @ 10,10 SAY '******** INGRESO SIN PESO ********'
       @ 12, 0 SAY LD_TIPO+'-'+LD_NRO+' '+DTOC(LD_FECHA)+' '+LD_PART+' CANT='+TRANSFORM(LD_CANT,'9,999,999.99')
       @ 13, 0 SAY 'PESO TEORICO ES       :'+TRANSFORM(V_ITEMS.IT_PESO_T,'9,999.9999')
       @ 14, 0 SAY 'PESO U. ACTUAL ESTA EN:'+TRANSFORM(KG_UNI,'9,999.9999')+'  ASIGNARLO (S/N)' GET SI_NO PICTURE '!'
       READ
       IF SI_NO='S'
         REPLACE LD_PESO WITH LD_CANT*KG_UNI
       ENDIF
     ELSE
       REPLACE SALDOS.IT_INGK  WITH SALDOS.IT_INGK+LD_PESO
       REPLACE SALDOS.IT_ING   WITH SALDOS.IT_ING +LD_CANT
       REPLACE SALDOS.IT_CANTK WITH SALDOS.IT_CANTK+LD_PESO
       REPLACE SALDOS.IT_CANT  WITH SALDOS.IT_CANT +LD_CANT
     ENDIF
     IF SALDOS.IT_CANT>0
       REPLACE SALDOS.IT_PESO_R  WITH SALDOS.IT_CANTK/SALDOS.IT_CANT
     ENDIF
    CASE LD_INSAL='2' .AND. LD_CANT<>0
     IF SALDOS.IT_CANT<=0
       KG_UNI=SALDOS.IT_PESO_R  
     ELSE
       KG_UNI=SALDOS.IT_CANTK/SALDOS.IT_CANT      
     ENDIF
     REPLACE SALDOS.IT_SALK  WITH SALDOS.IT_SALK+(LD_CANT*KG_UNI)
     REPLACE SALDOS.IT_SAL   WITH SALDOS.IT_SAL +LD_CANT
     REPLACE SALDOS.IT_CANTK WITH SALDOS.IT_CANTK-(LD_CANT*KG_UNI)
     REPLACE SALDOS.IT_CANT  WITH SALDOS.IT_CANT -LD_CANT
     REPLACE LD_PESO WITH (LD_CANT*KG_UNI)
  ENDCASE 
  SELECT V_DOC_LN   
  SKIP
ENDDO

SELECT SALDOS
BROW
USE
DELETE FILE (MI_ARCH+'.DBF')
DELETE FILE (MI_ARCH+'.CDX')
CLOSE DATA

SELECT 1
USE V_DOC_LN ORDER NR &&EMPRESA+TIPO+NRO+PART

SELECT 2
USE V_FAC_DOC ORDER FACTURA

SELECT 3
USE V_FAC_LN ORDER CORRE
SET RELATION TO LF_EMPR+LF_NRO INTO V_FAC_DOC
SET RELATION TO LF_EMPR+V_FAC_DOC.FA_DOC_TIP+V_FAC_DOC.FA_DOC_NRO+LF_PART INTO V_DOC_LN

RETURN


PROCEDURE MAS_ITSAL
*******************
PARAMETER EMPR,PART
SELECT V_ALM
SEEK EMPR
DO WHILE .NOT. EOF() .AND. AL_EMPR=EMPR
  SELECT SALDOS
  APPEND BLANK
  REPLACE IT_EMPR WITH EMPR, ;
          IT_ALM  WITH V_ALM.AL_ALM, ;
          IT_PART WITH PART 
  SELECT V_ALM
  SKIP
ENDDO
RETURN
