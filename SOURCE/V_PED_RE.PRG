PROCEDURE V_PED_RE
******************
*REASIGNA PRECIO AL PEDIDO EN ESTADO "C" / COTIZACION

IF .NOT. V_USRAUT(USER,"PEDIDOS",2)
  RETURN
ENDIF
 
IF V_PED_HD.HP_ESTADO<>"C" 
  MENSAJE1='*** E R R O R ***'
  MENSAJE2='SOLO SE PERMITE REASIGNAR PRECIOS A LAS COTIZACIONES'
  DO V_MENSAJ.SPR
  RETURN
ENDIF

MENSAJE1='CUIDADO ... ESTA OPCION REASIGNARA PRECIOS A TODA LA COTIZACION'
MENSAJE2='PRESIONE [ESC] SI DESEA CANCELAR'
DO V_MENSAJ.SPR
IF LASTKEY()=27
  RETURN
ENDIF  

LISTA=1 &&PRECIO BASE

DO V_PLISTA.SPR

IF LASTKEY()=27
  RETURN
ENDIF  

IMPORTE=0
TPRECIO=""

SELECT V_PED_LN
SEEK V_PED_HD.HP_EMPR+V_PED_HD.HP_NRO

DO WHILE .NOT. EOF() .AND. V_PED_HD.HP_EMPR+V_PED_HD.HP_NRO=LP_EMPR+LP_NRO
  IF LP_ESTADO='C'
   DO CASE
	CASE LISTA=1
		SELPRECIO=V_ITEMS.IT_PRECIO
		TPRECIO="Base" 	
	CASE LISTA=2
		SELPRECIO=V_ITEMS.IT_PRECIO1	
		TPRECIO="Lista 1" 	
	CASE LISTA=3
		SELPRECIO=V_ITEMS.IT_PRECIO2	
		TPRECIO="Lista 2"		
	CASE LISTA=4
		SELPRECIO=V_ITEMS.IT_PRECIO3
		TPRECIO="Lista 3"	
	CASE LISTA=5
		SELPRECIO=V_ITEMS.IT_PRECIO4
		TPRECIO="Lista 4" 	
	CASE LISTA=6
		SELPRECIO=V_ITEMS.IT_PRECIO5
		TPRECIO="Lista 5" 			
   ENDCASE

  *VERIFICA SI HAY DESCUENTO PARA ESE ITEM Y CATEGORIA DE CLIENTE
  *NADA TIENE QUE VER CON EL DESCUENTO GENERAL QUE SE ASIGNA AL PEDIDO/COTIZ.

   DESCTO_IT=0
   SELECT V_DESCTO
   SEEK EMPRESA+V_PED_LN.LP_PART
   DO WHILE .NOT. EOF() .AND. DE_EMPR+DE_PART=EMPRESA+V_PED_LN.LP_PART
    IF BETWEEN(V_PED_HD.HP_FECHA,DE_FECHAI,DE_FECHAF)
      IF V_CLIENT.CL_CATEGO$DE_CATEGO .OR. DE_CATEGO=SPACE(25)
        DESCTO_IT=DE_DESCTO/100
      ENDIF
      EXIT  
    ENDIF
    SKIP
   ENDDO   
   *
   SELECT V_PED_LN
   REPLACE LP_LISTA   WITH ROUND((SELPRECIO-(SELPRECIO*DESCTO_IT)),2)
   REPLACE LP_PRECIO  WITH ROUND((SELPRECIO-(SELPRECIO*DESCTO_IT)),2)

   IMPORTE=IMPORTE+ROUND(LP_CANT*LP_PRECIO,2)

  ENDIF
  SKIP
ENDDO 
      
SELECT V_PED_HD
REPLACE HP_IMPORTE WITH IMPORTE
REPLACE HP_OBS_COM WITH TPRECIO
 
MENSAJE1='SE REASIGNO PRECIOS A TODAS LAS LINEAS DEL PEDIDO'
MENSAJE2=''
DO V_MENSAJ.SPR

RETURN
