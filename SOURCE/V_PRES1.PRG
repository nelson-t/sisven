SET EXCLU OFF
SET DELE ON
CLOSE DATA
CLEAR
SET TALK OFF

EMPRESA=' '
FECHAI={  /  /    }
FECHAF={  /  /    }
OPCION=1
MI_EMPRESA=SPACE(30)
ACTUALIZA=1
NRO_MES=0

DO V_PRES1.SPR

IF LASTKEY()=27 .OR. OPCION=3
 CLOSE DATA
 CLEAR 
 RETURN
ENDIF

IF ACTUALIZA=1
  DO V_RPROCE WITH EMPRESA, FECHAI, FECHAF
ENDIF

CLOSE DATA

SELECT 1
USE V_LINEAS ORDER LINEA
SET FILTER TO LI_EMPR=EMPRESA

T_LINEA=SYS(3)

COPY TO (T_LINEA) WITH CDX
USE (T_LINEA) ORDER LINEA ALIAS V_LINEAK EXCLU
REPLACE LI_PRES    WITH LI_PRES*NRO_MES, LI_PRES_US WITH LI_PRES_US*NRO_MES, ;
        LI_PRES_KG WITH LI_PRES_KG*NRO_MES ALL
SELECT 2
USE V_ITEMS  ORDER PART
SET RELATION TO IT_EMPR+SUBSTR(IT_LINEA,1,2)+' ' INTO V_LINEAK

SELECT 3
USE V_FAC_LN ORDER CORRE

SELECT 4
USE V_TC ORDER FECHA

SELECT V_FAC_LN
SET FILTER TO LF_EMPR=EMPRESA .AND. BETWEEN(LF_FECHA,FECHAI,FECHAF) .AND. LF_ESTADO<>'A' 
SET RELATION TO LF_EMPR+LF_PART INTO V_ITEMS
SET RELATION TO DTOS(LF_FECHA)  INTO V_TC ADDITIVE

GO TOP

DO WHILE .NOT. EOF()
  REPLACE V_LINEAK.LI_REAL_US WITH V_LINEAK.LI_REAL_US+IIF(LF_COD_CL='9',(ROUND(lf_cant* lf_precio,2)-lf_desctos)/V_TC.TC_MONTO,.87*(ROUND(lf_cant* lf_precio,2)-lf_desctos)/V_TC.TC_MONTO)
  REPLACE V_LINEAK.LI_REAL    WITH V_LINEAK.LI_REAL+LF_CANT
  REPLACE V_LINEAK.LI_REAL_KG WITH V_LINEAK.LI_REAL_KG+LF_PESO
  SELECT V_FAC_LN
  SKIP
ENDDO  

SELECT V_LINEAK
SET FILTER TO SUBSTR(LI_LINEA,1,1)<>' ' .AND. SUBSTR(LI_LINEA,2,1)<>' ' .AND. SUBSTR(LI_LINEA,3,1)=' ' .AND. LI_REAL_KG+LI_PRES_KG<>0
FACT_REP='V:'+SYS(3)+'.TXT' 

DO CASE
  CASE OPCION=1 .AND. LASTKEY()<>27
    REPORT FORM V_PRES1 TO FILE (fact_rep)
    DEFINE WINDOW VER_REP FROM 0,0 TO 24,79 DOUBLE TITLE '[ESC] - PARA SALIR'
    MODI COMM (fact_rep) WINDOW VER_REP NOEDIT
    RELEASE WINDOW VER_REP    
  CASE OPCION=2 .AND. LASTKEY()<>27
    REPORT FORM V_pres1 TO FILE (FACT_REP)
    ! COPY &FACT_REP LPT1:
  CASE OPCION=3 .OR. LASTKEY()=27
ENDCASE
CLEAR

CLOSE DATA
DELETE FILE (T_LINEA+'.DBF')
DELETE FILE (T_LINEA+'.CDX')
DELETE FILE (FACT_REP)
RETURN

FUNCTION GET_EMPR
*****************
PARAMETER EMPR
SELECT 0
USE V_EMPR ORDER EMPR
SEEK EMPR
IF EOF()
  USE
  RETURN .F.
ELSE
  MI_EMPRESA=EM_DESCR
  @ 8,37 SAY MI_EMPRESA
  USE
  RETURN .T.
ENDIF