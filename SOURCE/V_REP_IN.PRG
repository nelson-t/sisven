* PROGRAMA PARA OBTENER REPORTE DE INGRESOS DE PRODUCCION
* BY: R.I.A.

CLEAR
CLOSE ALL
STORE CTOD('') TO FECHAI,FECHAF
OPCION=1
SELECT 1 
  USE V_ITEMS ORDER PART
SELECT 2
  USE V_DOC_LN ORDER KARDEX
SELECT 3
  USE V_PED_LN ORDER PENDIENTE  

DO V_REP_IN.SPR

IF LASTKEY()=27 .OR. OPCION=3
   CLOSE ALL
   RETURN
ELSE
   ARCH=SYS(3)+'.TXT'
   DBF=SYS(3)+'.DBF'
   SELECT LD_EMPR AS EMPR,LD_TIPO AS TIPO,LD_NRO AS NRO, ;
   LD_FECHA AS FECHA,LD_PART AS PARTE,LD_CANT AS CANT, ;
   LD_CANT AS SALDO, LD_CANT AS PEND FROM ;
   V_DOC_LN HAVING LD_TIPO='I'.AND.LD_FECHA>=FECHAI.AND.LD_FECHA<=FECHAF ;
   INTO TABLE (DBF)
   USE
   SELECT 4
    USE (DBF) ALIAS INGR
    REPLACE SALDO WITH 0, PEND WITH 0 ALL
    SET RELATION TO EMPR+PARTE INTO V_ITEMS
    GO TOP
    DO WHILE .NOT. EOF()
       SELECT V_DOC_LN
       SEEK INGR.EMPR+INGR.PARTE
       SUM IIF(LD_INSAL='1',LD_CANT,-LD_CANT) WHILE LD_PART=INGR.PARTE TO S
       SELECT V_PED_LN
       SEEK INGR.EMPR+'P'+INGR.PARTE
       SUM LP_PEND WHILE LP_PART=INGR.PARTE .AND. LP_ESTADO$'IP' TO P
       SELECT INGR
       REPLACE SALDO WITH S,PEND WITH P
       SKIP
    ENDDO
   DO CASE
      CASE OPCION=1
          DEFINE WINDOW ING FROM 0,0 TO 24,79 ;
          TITLE '> Presione [Esc] para Salir <'
          REPORT FORM V_REP_IN TO FILE (ARCH) NOCONSOLE
          MODI COMM (ARCH) WINDOW ING NOEDIT 
          RELEASE WINDOW ING
          DELETE FILE (ARCH)
      CASE OPCION=2
          REPORT FORM V_REP_IN TO FILE V_REP_IN.TXT NOCONSOLE
          ! COPY ..\TMP\V_REP_IN.TXT LPT1:
   ENDCASE   
   CLOSE ALL
   DELETE FILE (DBF)
   DELETE FILE STUFF(DBF,10,3,'CDX')
   CLEAR
   RETURN
ENDIF