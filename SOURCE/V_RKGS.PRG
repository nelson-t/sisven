SET EXCLU OFF
SET DELE ON
CLOSE DATA
CLEAR
SET TALK OFF

TIPOR=1
MI_GLOSA=SPACE(30)
MI_GLOSA1=SPACE(30)

KILOS=0
KILOS1=0

TOT_KILOS=0

EMPRESA=' '
FECHAI={  /  /    }
FECHAF={  /  /    }
OPCION=1
MI_EMPRESA=SPACE(30)

DO V_RKGS.SPR

IF LASTKEY()=27 .OR. OPCION=3
 CLOSE DATA
 CLEAR 
 RETURN
ENDIF

DO V_RPROCE WITH EMPRESA, FECHAI, FECHAF

DO V_KGXFAC
*CLOSE DATA


*SELECT 1
*USE V_LINEAK ORDER LINEA
SELECT 2
USE V_ITEMS  ORDER PART
SET RELATION TO IT_EMPR+SUBSTR(IT_LINEA,1,2)+' ' INTO V_LINEAK
SELECT 3
USE V_FAC_LN ORDER CORRE
SELECT 4
USE V_TC ORDER FECHA
SELECT 5
USE V_DOC_LN ORDER CORRE


FACTURAS=SYS(3)
FACT_REP='V:'+FACTURAS+'.TXT' 
FACT_IDX=FACTURAS+'.IDX'
FACTURAS=FACTURAS+'.DBF'

SELECT V_FAC_LN
COPY TO (FACTURAS) FOR LF_EMPR=EMPRESA .AND. BETWEEN(LF_FECHA,FECHAI,FECHAF) .AND. LF_ESTADO<>'A'

SELECT 7
USE (FACTURAS) ALIAS FAC_LN
SET RELATION TO LF_EMPR+LF_PART INTO V_ITEMS
INDEX ON LF_EMPR+V_ITEMS.IT_LINEA+LF_PART TO (FACT_IDX)
SET RELATION TO DTOS(LF_FECHA)  INTO V_TC ADDITIVE

DO CASE
  CASE OPCION=1 .AND. LASTKEY()<>27
      IF TIPOR=1
        REPORT FORM V_RKGS TO FILE V_RKGS.TXT
      ELSE
        REPORT FORM V_RKGS2 TO FILE V_RKGS.TXT
      ENDIF
      DEFINE WINDOW VER_REP FROM 0,0 TO 24,79 DOUBLE TITLE '[ESC] - PARA SALIR'
      MODI COMM V_RKGS.TXT WINDOW VER_REP NOEDIT
      RELEASE WINDOW VER_REP    
  CASE OPCION=2 .AND. LASTKEY()<>27
      IF TIPOR=1
        REPORT FORM V_RKGS TO FILE (FACT_REP)
      ELSE
        REPORT FORM V_RKGS2 TO FILE (FACT_REP)
      ENDIF
      ! NPRINT &FACT_REP NB NFF Q=SERVER   
  CASE OPCION=3 .OR. LASTKEY()=27
ENDCASE
CLEAR

CLOSE DATA
DELETE FILE (FACTURAS)
DELETE FILE (FACT_IDX)
DELETE FILE (FACT_REP)

RETURN

FUNCTION GET_EMPR
*****************
PARAMETER EMPR
SELECT 0
USE V_EMPR ORDER EMPR
SEEK EMPR
IF EOF()
  USE
  RETURN .F.
ELSE
  MI_EMPRESA=EM_DESCR
  @ 8,37 SAY MI_EMPRESA
  USE
  RETURN .T.
ENDIF

FUNCTION GLOSA
**************
KILOS=V_LINEAK.LI_KGXFACT
MI_GLOSA=V_LINEAK.LI_DESCR
RETURN ' '

FUNCTION GLOSA1
**************
SELECT V_ITEMS
SET RELATION TO IT_EMPR+SUBSTR(IT_LINEA,1,1)+'  ' INTO V_LINEAK
KILOS1=V_LINEAK.LI_KGXFACT
tot_kilos=tot_kilos+kilos1
MI_GLOSA1=V_LINEAK.LI_DESCR
SET RELATION TO IT_EMPR+SUBSTR(IT_LINEA,1,2)+' ' INTO V_LINEAK
SELECT FAC_LN
RETURN ' '

