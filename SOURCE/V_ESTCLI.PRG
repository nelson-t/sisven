******************
PROCEDURE V_ESTCLI
******************
PARAMETER IMPRE

INCLUIR_NR=.T.
EST_ARCH=SYS(3)
CODIGO=CL_COD_CL
RAZON =CL_RAZON

SELECT V_EMPR
INI_GEST=EM_FECHA

FECHAI=INI_GEST
FECHAF=DATE()

SELECT V_TC
SEEK DTOS(INI_GEST)

IF .NOT. EOF()
  INI_TC=TC_MONTO
ELSE
  WAIT "ERROR...NO EXISTE TC PARA "+DTOC(INI_GEST) WINDOW
  SELECT V_CLIENT
  RETURN
ENDIF

MONEDA=1
DO V_ESTCLI.SPR

SELECT V_TC
SEEK DTOS(FECHAF)
IF EOF()
  WAIT "ERROR...NO EXISTE TC PARA "+DTOC(FECHAF) WINDOW
  SELECT V_CLIENT
  RETURN
ENDIF

SELECT V_CLIENT
IF MONEDA=1
  *Bs
  SALD_INI=CL_SALD_AN
ELSE
  *USD
  SALD_INI=CL_SALD_AN+CL_DIF_AN
ENDIF    
    
SELECT 0
USE V_ESTCLI
COPY STRUC TO (EST_ARCH) WITH CDX
USE

SELECT 0
USE (EST_ARCH) ORDER FECHA ALIAS ESTADOS

SELECT ESTADOS
APPEND BLANK
IF LOCK()
  REPLACE OBS   WITH '                             SALDO INICIO DE GESTION'
  REPLACE FECHA WITH INI_GEST
  REPLACE DEBE  WITH IIF(SALD_INI>=0,SALD_INI,0)
  REPLACE HABER WITH IIF(SALD_INI<0 ,-SALD_INI,0)
  REPLACE TC    WITH INI_TC
ENDIF          

SELECT V_FAC_HD
SET RELATION TO DTOS(HF_FECHA) INTO V_TC
SEEK V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL

DO WHILE .NOT. EOF() .AND. (V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL=HF_EMPR+HF_COD_CL)
  	IF HF_ESTADO<>'A' .AND. HF_TIPO<>'O'
  		INCLUIR = .F.  	  

    	DO CASE
			CASE HF_TIPO='R'  && FACTURA AL CREDITO
       		 TTIPO='F.CR.'
        	 TDEBE=hf_importe-HF_DSCTO_M-ROUND(hf_importe*(HF_DSCTO_P/100),2)+hf_fletes+hf_embala+hf_otros 
   	    	 THABER=0 
      		CASE HF_TIPO='X'  && NOTA DE CREDITO
        	 TTIPO='N.C.'
        	 TDEBE=0
        	 THABER=hf_importe
      		CASE HF_TIPO='Y'  && NOTA DE DEBITO
        	 TTIPO='N.D.'
        	 TDEBE=HF_IMPORTE
        	 THABER=0
     	ENDCASE
		
    	SELECT ESTADOS
    	APPEND BLANK
    	IF LOCK()
      		REPLACE TIPO  WITH TTIPO
      		REPLACE OBS   WITH V_FAC_HD.HF_OBS
      		REPLACE FECHA WITH V_FAC_HD.HF_FECHA
      		REPLACE NRO   WITH V_FAC_HD.HF_NRO
      		REPLACE DEBE  WITH TDEBE
      		REPLACE HABER WITH THABER
      		IF TTIPO='F.CR.'
        		REPLACE TC WITH V_FAC_HD.HF_FACTOR
      		ELSE
        		REPLACE TC WITH V_TC.TC_MONTO
      		ENDIF
    	ENDIF
  	ENDIF
  	SELECT V_FAC_HD 
  	SKIP
ENDDO

SET RELATION OFF INTO V_TC

*** DO GETRECHD && AQUI LA GLOSA ES MUY GENERAL EN LOS RECIBOS
DO GETRECLN


SELECT V_DOC_HD
SET RELATION TO DTOS(HD_FECHA) INTO V_TC

SEEK V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL
DO WHILE .NOT. EOF() .AND. V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL=HD_EMPR+HD_COD_CL
  IF (HD_ESTADO=' ' .AND. HD_TIPO='R')
    *AQUI SON NR NO FACTURADAS
    IF INCLUIR_NR
    	SELECT ESTADOS
    	APPEND BLANK
    	IF LOCK()
      		REPLACE TIPO  WITH "NR." 
      		REPLACE OBS   WITH V_DOC_HD.HD_OBS
      		REPLACE FECHA WITH V_DOC_HD.HD_FECHA
      		REPLACE NRO   WITH V_DOC_HD.HD_NRO
      		REPLACE DEBE  WITH V_DOC_HD.hd_importe-ROUND((V_DOC_HD.hd_importe* V_DOC_HD.hd_dscto_p)/100,2)+ V_DOC_HD.hd_ped_fle+ V_DOC_HD.hd_ped_emb+ V_DOC_HD.hd_ped_otr
       		REPLACE TC WITH V_TC.TC_MONTO
    	ENDIF
    ENDIF
    SELECT V_DOC_HD
  ENDIF
  SKIP
ENDDO

SET RELATION OFF INTO V_TC

SELECT ESTADOS
SUM DEBE,HABER FOR NRO<>SPACE(6) .AND. TIPO<>SPACE(5) TO T_DB,T_HB
STORE 0 TO S_DB, S_HB
SUM IIF(MONEDA=1,DEBE,ROUND(DEBE/TC,2)),IIF(MONEDA=1,HABER,ROUND(HABER/TC,2)) ;
    FOR FECHA>=INI_GEST .AND. FECHA < FECHAI TO S_DB,S_HB

SELECT V_CLIENT 

REPLACE CL_SALD_DB WITH T_DB
REPLACE CL_SALD_HB WITH T_HB
REPLACE CL_SALD_AC WITH CL_SALD_AN+CL_SALD_DB-CL_SALD_HB

DEFINE WINDOW VER_CLIE FROM 0,0 TO 24,79 DOUBLE TITLE 'ESTADO DE CUENTA DEL CLIENTE - [ESC] PARA SALIR'
ACTIVATE WINDOW VER_CLIE

SELECT ESTADOS
LOCATE FOR BETWEEN(FECHA,FECHAI,FECHAF)
IF FOUND()
  HAY_REG=.T.
ELSE
  HAY_REG=.F.
ENDIF

GO TOP    

REP_ARCH='..\TMP\'+SYS(3)+'.TXT'

IF IMPRE='S'
  IF HAY_REG
    REPORT FORM V_ESTCLI FOR BETWEEN(FECHA,FECHAI,FECHAF) TO (REP_ARCH)
    ! COPY &REP_ARCH lpt1:
  ELSE
    WAIT "EL CLIENTE NO TIENEN MOVIMIENTOS EN EL RANGO DE FECHAS." WINDOW
  ENDIF
ELSE
  IF HAY_REG
    REPORT FORM V_ESTCLI FOR BETWEEN(FECHA,FECHAI,FECHAF) TO FILE (REP_ARCH)
    CLEAR
    MODI COMM (REP_ARCH) NOEDIT WINDOW VER_CLIE 
  ELSE
    WAIT "EL CLIENTE NO TIENEN MOVIMIENTOS EN EL RANGO DE FECHAS." WINDOW
  ENDIF
ENDIF
RELEASE WINDOW VER_CLIE

USE

DELETE FILE (EST_ARCH+'.DBF') 
DELETE FILE (EST_ARCH+'.CDX') 
DELETE FILE (EST_ARCH+'.TXT') 
DELETE FILE (REP_ARCH)

SELECT V_CLIENT

RETURN

PROCEDURE GETRECHD
******************
SELECT V_REC_HD 
SET RELATION TO DTOS(HR_FECHA) INTO V_TC

SEEK V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL
DO WHILE .NOT. EOF() .AND. V_CLIENT.CL_EMPR+V_CLIENT.CL_COD_CL=HR_EMPR+HR_COD_CL
  IF HR_ESTADO<>'A' 
    TDEBE=0
    THABER=HR_TOT_BS
    SELECT ESTADOS
    APPEND BLANK
    IF LOCK()
      REPLACE TIPO  WITH 'RCBO.'
      REPLACE OBS   WITH "* * *  ABONO A SU CUENTA  * * *"
      REPLACE FECHA WITH V_REC_HD.HR_FECHA
      REPLACE NRO   WITH V_REC_HD.HR_NRO
      REPLACE DEBE  WITH TDEBE
      REPLACE HABER WITH THABER
      REPLACE TC    WITH V_TC.TC_MONTO
    ENDIF          
  ENDIF
  SELECT V_REC_HD
  SKIP
ENDDO
SET RELATION OFF INTO V_TC
RETURN

PROCEDURE GETRECLN
******************
SELECT V_REC_LN 
SET RELATION TO DTOS(LR_FECHA) INTO V_TC

SET FILTER TO LR_ESTADO<>'A' AND LR_EMPR=V_CLIENT.CL_EMPR AND LR_COD_CL=V_CLIENT.CL_COD_CL
GO TOP
DO WHILE .NOT. EOF() 
  TDEBE=0
  THABER=LR_MONTO
  SELECT ESTADOS
  APPEND BLANK
  IF LOCK()
    REPLACE TIPO  WITH 'RCBO.'
    REPLACE OBS   WITH V_REC_LN.LR_DESCR
    REPLACE FECHA WITH V_REC_LN.LR_FECHA
    REPLACE NRO   WITH V_REC_LN.LR_NRO
    REPLACE DEBE  WITH TDEBE
    REPLACE HABER WITH THABER
    REPLACE TC    WITH V_TC.TC_MONTO
  ENDIF          
  SELECT V_REC_LN
  SKIP
ENDDO
SET RELATION OFF INTO V_TC
SET FILTER TO
RETURN